#  ============================================================================
#  TITLE : P4gl - Informix 4gl parser and repository loader
#
#  AUTHOR : Sergio Ferreira
#           Moredata, Lda - Lisbon, Portugal
#
# $Id: Makefile.in,v 1.6 2003-05-15 10:23:26 afalout Exp $
#
#  DESCRIPTION : Makefile for fgldoc 4gl parser compilation
#
#  ============================================================================


include ../FgldocDefs.mk


#  ============================================================================
#  Compilation of all programs
#  ============================================================================
all: p4gl p4glpp
	@echo ""
	@echo "+--------------------------------------------------------------------+"
	@echo "|             Doc4gl parser successfully compiled.                   |"
	@echo "+--------------------------------------------------------------------+"
	@echo ""

.PHONY:install clean deinstall tags test

#  ============================================================================
#  4GL Parser (for each source file)
#  ============================================================================
P4GLOBJ= p4gl_synt.o p4gl_ld_st.o p4gl_lex.o p4gl_parse.o  \
	p4gl_util.o p4gl_dump_st.o  p4gl_ins_rep.o actions.o GenFglDoc.o \
	InsertP4glRep.o StringBuffer.o CommentLexer.o ParseComment.o GenParameters.o \
	ReadComments.o CommentsManagement.o Comment.o P4glLexFuncs.o P4glInit.o \
	TableUsage.o P4glAbstractTree.o

p4gl : $(P4GLOBJ) m_p4gl.o
	$(ESQL) $(CFLAGS) -o $@ $(P4GLOBJ) m_p4gl.o

# Compilation of esql/c API for inserting in the repository
p4gl_ins_rep.o: p4gl_ins_rep.ec
	$(ESQL) $(CFLAGS) -c p4gl_ins_rep.ec $(CFLAGS)
	${RM} p4gl_ins_rep.c

# TODO - Fazer regra genérica
# Compilation of esql/c API for inserting in the repository
InsertP4glRep.o: InsertP4glRep.ec
	$(ESQL) $(CFLAGS) -c InsertP4glRep.ec

#  ============================================================================
#  Geração do lexer para os comentários
#  ============================================================================
CommentLexer.o: CommentLexer.l
	$(LEX) -PyyComment -oCommentLexer.c CommentLexer.l
	$(CC) $(CFLAGS) -c CommentLexer.c


#  ==========================================================================
#  Esta regra tem de ser bem vista.
#  Sera que o GNU make mudou as regras ?
#  ==========================================================================
p4gl_lex.o : p4gl_lex.l m_p4gl.c
	${LEX} -t p4gl_lex.l > p4gl_lex.c
	$(CC) -c p4gl_lex.c
	${RM} p4gl_lex.c

p4pp_lex.o : p4pp_lex.l m_p4glpp.c
	${LEX} -t p4pp_lex.l > p4pp_lex.c
	$(CC) -c p4pp_lex.c
	${RM} p4pp_lex.c

#  ==========================================================================
#  4gl Pre-Processor
#    It resolve all the inclusions of globals (globals "file.4gl") and
#    generates a temporary file.
#  ==========================================================================
P4GLPPOBJ= p4pp_lex.o m_p4glpp.o

p4glpp: $(P4GLPPOBJ)
	$(ESQL) -o $@ $(P4GLPPOBJ)

#  ==========================================================================
#  P4gl as library. Done for unit testing.
#  ==========================================================================
p4gl.a : $(P4GLOBJ) p4glpp
	ar rv p4gl.a $(P4GLOBJ)


test: test.parser unit.test

#run parser on some test 4gl files
test.parser:
	./p4gl --file=test/p4gl.4gl --database=maxdevdoc  --insert
	@echo ""
	@echo "+--------------------------------------------------------------------+"
	@echo "|             Doc4gl parser parsing test successfull                 |"
	@echo "+--------------------------------------------------------------------+"
	@echo ""


#run Test suite for p4gl unit testing:
unit.test:
	${MAKE} -C test
	@echo ""
	@echo "+--------------------------------------------------------------------+"
	@echo "|             Doc4gl parser unit test successfull.                   |"
	@echo "+--------------------------------------------------------------------+"
	@echo ""

#  ==========================================================================
#  Generate tag(s) file
#  ==========================================================================
tags:
	@-rm tags
	touch *c
	ctags *.c

#  ==========================================================================
#  Install the software
#  ==========================================================================
install:
	${INSTALL} p4gl p4glpp $(BINDIR)
	@echo ""
	@echo "+--------------------------------------------------------------------+"
	@echo "|             Doc4gl parser successfully installed.                  |"
	@echo "+--------------------------------------------------------------------+"
	@echo ""


deinstall:
	${RM} ${BINDIR}/p4gl ${BINDIR}/p4glpp
	@echo ""
	@echo "+--------------------------------------------------------------------+"
	@echo "|             Doc4gl parser successfully de-installed.               |"
	@echo "+--------------------------------------------------------------------+"
	@echo ""

#  ==========================================================================
#  Cleaning of all the garbage
#  ==========================================================================
clean:
	${RM} *.o p4gl p4glpp lex.yy.c y.tab.h a.out core y.output sqexplain.out \
	*.4go *.4gi *.4ge *.a  InsertP4glRep.c


