#!/usr/bin/perl

use strict;
use warnings;

use Getopt::Long;

my %Options;
GetOptions \%Options, qw(fdecls fgiusr fglext);

my $style;
$style = "fdecls" if defined $Options{fdecls};
$style = "fglext" if defined $Options{fglext};
$style = "fgiusr" if defined $Options{fgiusr};

print <<HEADER;

/* Automatically generated by $0
 * Do not modify by hand!
 */
HEADER

my ($fheader, $x);
my ($name, $min, $max, $step, $ret);
my %targets;
my $fname = '';

LINE: while(<>)
{
    if($fname ne $ARGV)
    {
	$fname = $ARGV;
	$fheader = "\n/* $fname */\n";
    }

    if($x = /^function\((\w+),(\d+),(\d+),(\d+),(-?\d+)\)/ .. /^}/)
    {
	if($x == 1)
	{
	    ($name, $min, $max, $step, $ret) = ($1, $2, $3, $4, $5);
	    %targets = ();
	}

	# look for RUNNER macros only in the function header
	if(/^function/ .. /^\{/)
	{
	    # get possible function name override
	    if(/^\s*RUNNER\((\w+)(?: (\w+))?\)/)
	    {
		$targets{$1} = $2 || $name;
	    }
	}

	if($x =~ /E/)
	{
	    my $alias = $name;

	    if($style ne "fdecls" && %targets)
	    {
		$alias = $targets{$style};
		next LINE unless defined $alias;
	    }

	    print $fheader;
	    $fheader = '';

	    if($style eq "fdecls")
	    {
		print "int $name(int nargs);\n"
	    }

	    if($style eq "fgiusr")
	    {
		my $n = $max;
		$n = -$n if $min != $max;

		printf "    { %-26s%-26s%4d },\n", "\"$alias\",", "$name,", $n;
	    }

	    if($style eq "fglext")
	    {
		my $n = $max;
		$n = -1 if $min != $max;
		$ret = -1 if $ret < 0;

		printf "    { %-26s%-26s%4d,%4d },\n",
		       "\"$alias\",", "$name,", $n, $ret;
	    }
	}
    }
}

print "\n";

__END__


      12345678901234567890123456
      12345678901234567890123456
    { "c_log",			c_log,			 1,	 1 },
    { "c_log10",		c_log10,		 1,	 1 },
    { "c_srand",		c_srand,		 1,	 0 },
    { "c_rand",			c_rand,			 0,	 1 },

    { "c_md5_init",		c_md5_init,		 0,	 1 },
    { "c_md5_update",		c_md5_update,		 3,	 0 },
    { "c_md5_final",		c_md5_final,		 1,	 1 },

    { "c_getkey",		j_getkey,		 2,	 2 },
    { "cursor_name",		cursor_name,		 1,	 1 },

    { "c_readfile",		c_readfile,		 1,	 2 },
    { "c_command",		c_command,		 1,	 3 },
    { "c_statfile",		c_statfile,		 1,	 3 },
    { "c_filemode",		c_filemode,		 1,	 3 },
    { "c_getenv",		c_getenv,		 1,	 1 },
    { "c_putenv",		c_putenv,		 2,	 1 },
    { "c_time",			c_time,			 0,	 1 },
    { "c_readin",		c_readin,		 0,	 2 },
    { "c_writeout",		c_writeout,		 3,	 1 },

    { "c_debug",		c_debug,		-1,	 0 },
    { "c_interpreter",		c_interpreter,		 0,	 1 },

    { "c_alarm",		c_alarm,		 1,	 0 },
    { "c_alarmed",		c_alarmed,		 0,	 1 },

    { "c__errno",		c__errno,		 1,	 1 },
    { "c_errno",		c_errno,		 0,	 1 },
    { "c_strerror",		c_strerror,		 1,	 1 },

    { "c_run",			c_run,			 1,	 1 },
    { "c_fork",			c_fork,			 0,	 1 },
    { "c_execv",		c_execv,		-1,	 1 },
    { "c_execvp",		c_execvp,		-1,	 1 },
    { "c_sqldetach",		c_sqldetach,		 0,	 0 },
    { "c_wait",			c_wait,			 0,	 2 },
    { "c_waitpid",		c_waitpid,		-1,	 2 },
    { "c_waitstat",		c_waitstat,		 2,	 1 },
    { "c_kill",			c_kill,			-1,	 1 },
    { "c_signal",		c_signal,		 2,	 1 },
    { "c_signalq",		c_signalq,		 1,	 2 },
    { "c_signalled",		c_signalled,		 1,	 1 },

    { "c_pipe",			c_pipe,			 0,	 2 },
    { "c_open",			c_open,			-1,	 1 },
    { "c_close",		c_close,		 1,	 1 },
    { "c_read",			c_read,			 2,	 2 },
    { "c_write",		c_write,		 3,	 1 },
    { "c_mread",		c_mread,		 4,	 1 },
    { "c_mwrite",		c_mwrite,		 4,	 1 },
    { "c_lseek",		c_lseek,		 3,	 1 },
    { "c_chmod",		c_chmod,		 2,	 1 },
    { "c_dup",			c_dup,			 1,	 1 },
    { "c_dup2",			c_dup2,			 2,	 1 },
    { "c_fsync",		c_fsync,		 1,	 1 },
    { "c_lockf",		c_lockf,		 3,	 1 },
    { "c_umask",		c_umask,		 1,	 1 },
    { "c_fcntl",		c_fcntl,		-1,	 1 },

    { "fglgetret",		fglgetret,		 0,	 1 },
    { "fglgets",		fglgets,		-1,	 1 },

    { "c_crypt",		c_crypt,		 2,	 1 },
    { "c_setpwent",		c_setpwent,		 0,	 0 },
    { "c_endpwent",		c_endpwent,		 0,	 0 },
    { "c_getpwent",		c_getpwent,		 0,	 9 },
    { "c_getpwuid",		c_getpwuid,		 1,	 9 },
    { "c_getpwnam",		c_getpwnam,		 1,	 9 },

    { "c_ttyname",		c_ttyname,		 0,	 1 },

    { "c_getpid",		c_getpid,		 0,	 1 },
    { "c_getppid",		c_getppid,		 0,	 1 },
    { "c_getpgrp",		c_getpgrp,		 0,	 1 },

    { "c_getuid",		c_getuid,		 0,	 1 },
    { "c_geteuid",		c_geteuid,		 0,	 1 },
    { "c_getgid",		c_getgid,		 0,	 1 },
    { "c_getegid",		c_getegid,		 0,	 1 },
    { "c_setgid",		c_setgid,		 1,	 1 },
    { "c_setsid",		c_setsid,		 0,	 1 },
    { "c_setuid",		c_setuid,		 1,	 1 },

    { "c_chdir",		c_chdir,		 1,	 1 },
    { "c_mkdir",		c_mkdir,		-1,	 1 },
    { "c_chown",		c_chown,		 3,	 1 },
    { "c_fchown",		c_fchown,		 3,	 1 },
    { "c_lchown",		c_lchown,		 3,	 1 },
    { "c_chroot",		c_chroot,		 1,	 1 },
    { "c_link",			c_link,			 2,	 1 },
    { "c_readlink",		c_readlink,		 1,	 1 },
    { "c_rename",		c_rename,		 2,	 1 },
    { "c_rmdir",		c_rmdir,		 1,	 1 },
    { "c_symlink",		c_symlink,		 2,	 1 },
    { "c_unlink",		c_unlink,		 1,	 1 },

    { "c_and",			c_and,			-1,	 1 },
    { "c_or",			c_or,			-1,	 1 },
    { "c_xor",			c_xor,			-1,	 1 },
    { "c_not",			c_not,			 1,	 1 },
    { "c_lshift",		c_lshift,		-1,	 1 },
    { "c_rshift",		c_rshift,		-1,	 1 },

    { "c_asbase",		c_asbase,		-1,	 1 },
    { "c_is4js",		j_is4js,		 0,	 1 },

    { "c_semget",		c_semget,		-1,	 1 },
    { "c_semctl",		c_semctl,		-1,	-1 },
    { "c_semop",		c_semop,		-1,	 1 },

    { "c_getprotobyname",	c_getprotobyname,	 1,	 3 },
    { "c_getprotobynumber",	c_getprotobynumber,	 1,	 3 },
    { "c_proto_alias",		c_proto_alias,		 1,	 1 },
    { "c_getservbyname",	c_getservbyname,	 2,	 4 },
    { "c_getservbyport",	c_getservbyport,	 2,	 4 },
    { "c_serv_alias",		c_serv_alias,		 1,	 1 },

    { "c_gethostname",		c_gethostname,		 0,	 1 },
    { "c_gethostbyname",	c_gethostbyname,	 1,	 3 },
    { "c_gethostbyaddr",	c_gethostbyaddr,	 1,	 3 },
    { "c_host_alias",		c_host_alias,		 1,	 1 },
    { "c_host_addr",		c_host_addr,		 1,	 1 },
    { "c_inet_ntoa",		c_inet_ntoa,		 1,	 1 },
    { "c_inet_aton",		c_inet_aton,		 1,	 1 },

    { "c_htons",		c_htons,		 1,	 1 },
    { "c_htonl",		c_htonl,		 1,	 1 },
    { "c_ntohs",		c_ntohs,		 1,	 1 },
    { "c_ntohl",		c_ntohl,		 1,	 1 },

    { "c__socket",		c__socket,		 1,	 1 },
    { "c_daemon",		c_daemon,		 0,	 1 },
    { "c_accept",		c_accept,		 2,	-1 },
    { "c_bind",			c_bind,			-1,	 1 },
    { "c_connect",		c_connect,		-1,	 1 },
    { "c_getpeername",		c_getpeername,		 2,	-1 },
    { "c_getsockname",		c_getsockname,		 2,	-1 },
    { "c_getsockopt",		c_getsockopt,		 3,	 1 },
    { "c_listen",		c_listen,		 2,	 1 },
    { "c_recv",			c_recv,			-1,	 1 },
    { "c_recvfrom",		c_recvfrom,		-1,	 2 },
    { "c_send",			c_send,			-1,	 1 },
    { "c_sendto",		c_sendto,		-1,	 1 },
    { "c_setsockopt",		c_setsockopt,		 4,	 1 },
    { "c_shutdown",		c_shutdown,		-1,	 1 },
    { "c_socket",		c_socket,		 3,	 1 },
    { "c_socketpair",		c_socketpair,		 3,	 2 },
    { "c_select",		c_select,		 4,	 5 },

    { "cfgl_open",		c_open,			-1,	 1 },
    { "cfgl_close",		c_close,		 1,	 1 },
    { "cfgl_read",		c_read,			 2,	 2 },
    { "cfgl_write",		c_write,		 3,	 1 },

    { "c_putarg",		c_putarg,		-1,	 0 },
    { "c_getarg",		c_getarg,		 0,	 1 },
    { "c_nargs",		c_nargs,		 0,	 1 },
    { "c_argtype",		c_argtype,		 0,	 1 },

    { "c_msgget",		c_msgget,		-1,	 1 },
    { "c_msgctl",		c_msgctl,		-1,	-1 },
    { "c_msgsnd",		c_msgsnd,		-1,	 1 },
    { "c_msgrcv",		c_msgrcv,		-1,	 1 },

    { "c_fopen",		c_fopen,		 2,	 1 },
    { "c_freopen",		c_freopen,		 3,	 1 },
    { "c_fdopen",		c_fdopen,		 2,	 1 },
    { "c_popen",		c_popen,		 2,	 1 },
    { "c_fclose",		c_fclose,		 1,	 1 },
    { "c_pclose",		c_pclose,		 1,	 1 },
    { "c_fflush",		c_fflush,		-1,	 1 },
    { "c_ferror",		c_ferror,		 1,	 1 },
    { "c_feof",			c_feof,			 1,	 1 },
    { "c_clearerr",		c_clearerr,		 1,	 0 },
    { "c_fileno",		c_fileno,		 1,	 1 },
    { "c_fgetpos",		c_fgetpos,		 1,	 1 },
    { "c_fsetpos",		c_fsetpos,		 2,	 1 },
    { "c_setvbuf",		c_setvbuf,		 3,	 1 },
    { "c_putc",			c_putc,			 2,	 1 },
    { "c_getc",			c_getc,			 1,	 1 },
    { "c_fgetln",		c_fgetln,		 1,	 2 },
    { "c_fputln",		c_fputln,		 3,	 1 },
    { "c_fseek",		c_fseek,		 3,	 1 },
    { "c_rewind",		c_rewind,		 1,	 1 },
    { "c_ftell",		c_ftell,		 1,	 1 },
 
    { "c_regcomp",		c_regcomp,		-1,	 2 },
    { "c_regexec",		c_regexec,		-1,	 1 },
    { "c_regerror",		c_regerror,		-1,	 2 },
    { "c_regfree",		c_regfree,		-1,	 0 },
    { "c_regsub",		c_regsub,		-1,	-1 },

    { "c_malloc",		c_malloc,		 1,	 1 },
    { "c_free",			c_free,			 1,	 0 },
    { "c_realloc",		c_realloc,		 2,	 1 },
    { "c_calloc",		c_calloc,		 2,	 1 },
    { "c_memset",		c_memset,		 4,	 0 },
    { "c_memcpy",		c_memcpy,		 5,	 0 },
    { "c_memid",		c_memid,		 1,	 1 },
    { "c_memstats",		c_memstats,		 0,	 3 },
    { "c_mallinfo",		c_mallinfo,		 0,	10 },

    { "c_peekch",		c_peekch,		 2,	 1 },
    { "c_peek8",		c_peek8,		 2,	 1 },
    { "c_peek16",		c_peek16,		 2,	 1 },
    { "c_peek32",		c_peek32,		 2,	 1 },
    { "c_peekshort",		c_peekshort,		 2,	 1 },
    { "c_peekint",		c_peekint,		 2,	 1 },
    { "c_peeklong",		c_peeklong,		 2,	 1 },
    { "c_peekstr",		c_peekstr,		 3,	 1 },
    { "c_sizeof",		c_sizeof,		 1,	 1 },

    { "c_pokech",		c_pokech,		 3,	 0 },
    { "c_poke8",		c_poke8,		 3,	 0 },
    { "c_poke16",		c_poke16,		 3,	 0 },
    { "c_poke32",		c_poke32,		 3,	 0 },
    { "c_pokeshort",		c_pokeshort,		 3,	 1 },
    { "c_pokeint",		c_pokeint,		 3,	 1 },
    { "c_pokelong",		c_pokelong,		 3,	 1 },
    { "c_pokestr",		c_pokestr,		-1,	 0 },

    { "c_tuple",		c_tuple,		-1,	 1 },
    { "c_basename",		c_basename,		 1,	 1 },
    { "c_badargs",		c_badargs,		 0,	 0 },

    { "c_fopen",		c_fopen,		 2,	 1 },
    { "c_fclose",		c_fclose,		 1,	 0 },
    { "c_fflush",		c_fflush,		 1,	 0 },
    { "c_sprintf",		c_sprintf,		-1,	 2 },
    { "c_fprintf",		c_fprintf,		-2,	 1 },
    { "c_printf",		c_printf,		-1,	 1 },
