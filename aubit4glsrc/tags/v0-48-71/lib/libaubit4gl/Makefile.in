# +----------------------------------------------------------------------+
# | Aubit 4gl Language Compiler Version $.0   lib makefile				 |
# +----------------------------------------------------------------------+
# | Copyright (c) 2000-1 Aubit Development Team (See Credits file)       |
# +----------------------------------------------------------------------+
# | This program is free software; you can redistribute it and/or modify |
# | it under the terms of one of the following licenses:                 |
# |                                                                      |
# |  A) the GNU General Public License as published by the Free Software |
# |     Foundation; either version 2 of the License, or (at your option) |
# |     any later version.                                               |
# |                                                                      |
# |  B) the Aubit License as published by the Aubit Development Team and |
# |     included in the distribution in the file: LICENSE                |
# |                                                                      |
# | This program is distributed in the hope that it will be useful,      |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of       |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        |
# | GNU General Public License for more details.                         |
# |                                                                      |
# | You should have received a copy of both licenses referred to here.   |
# | If you did not, or have any questions about Aubit licensing, please  |
# | contact afalout@ihug.co.nz                                           |
# +----------------------------------------------------------------------+

#
# $Id: Makefile.in,v 1.73 2004-10-04 13:50:02 afalout Exp $
#

ROOT    	=../..
LIBROOT		=..

#All stuff common to more then one Aubit compiler make file is there:
include ${ROOT}/incl/Makefile-common

## ==================================================================
##                              Source files
## ==================================================================

CMODS_PROJECT	=project.c

#List of API specification files used to generate .c/.h pair
#created headers are included via a4gl_libaubit4gl_int.h
API_SPEC    =API_esql.spec API_help.spec API_menu.spec API_packer.spec \
			API_form.spec API_msg.spec API_ui.spec API_sql.spec API_rpc.spec \
			API_exreport.spec

#List of API .c files that do not have coresponding .spec file
#looks like we have them all now
#API_C       =API_sql.c API_rpc.c API_exreport.c

#../../incl/a4gl_API_exdata.h     ??????

#List of all Aubit API interfaces source files, part of libaubit4gl:
CMODS_API   =${API_C} ${API_SPEC:.spec=.c}

#List of all non-API source files of libaubit4gl, -- IN ALPHABETIC ORDER -- :
COMMONSRC= \
	attributes.c ns.c \
	builtin.c builtin_d.c \
	calldll.c conv.c compat.c \
	data_if.c dates.c dmy.c  datatypes.c dataio.c decimal.c dynmem.c \
	err.c error.c errfile.c extfile.c eval_field.c \
	fglwrap.c funcs_d.c function_call_stack.c \
	gtime.c gui_io.c gui.c \
	helper.c \
	io.c interval.c \
	keys.c  \
	load.c \
	match.c maths.c memfile.c \
	others.c ops.c \
	pointers.c \
	read_dty.c readkeys.c report.c rexp2.c ${LIBROOT}/resource/resource.c \
	screen.c sql.c sqlconvert.c stack_ops.c stack.c string.c sqlca.c \
	translate.c \
	ui.c

CMODS               =${COMMONSRC} ${LIBROOT}/generated/${CMODS_PROJECT} ${CMODS_API} debug.o
OBJS_API			=${CMODS_API:.c=.o}
OBJS				=${CMODS:.c=.o}

## ==================================================================
##                              Options
## ==================================================================

LIBINCL_PATH		=${LIBROOT}/libincl
INCL_PATH			=${ROOT}/incl
DLMAGIC				=${LIBROOT}/bin/dlmagic
ALL					=api ${LIBROOT}/libaubit4gl${SO_EXT_LINKABLE}
CFLAGS              +=-I.

#we don't want -Wall in CFLAGS when compiling form_x_xdr.c because it would
#give us bunch of warnings about unised varibles, that we cannot fix
#because this file is generated by rpcgen:
CFLAGS_FORM_X_XDR_C =$(CFLAGS:%-Wall=%)

#we cannot compile API code with  -Wstrict-prototypes because we use
#static int (*func)	(); which need variable number of parameters:
CFLAGS_API_C 		=$(CFLAGS:%-Wstrict-prototypes=%)

ifeq "${NON_PEDANTIC_OK}" "1"
	CFLAGS_NO_PEDANTIC  =$(CFLAGS:%-pedantic=%)
else
	CFLAGS_NO_PEDANTIC  =${CFLAGS}
endif

LCLINT_CFLAGS   	=${C_IFLAGS}


ifeq "${TARGET_OS}" "solaris"
	LINK_LIBS		+=-lsocket
endif



ifneq "${TARGET_OS}" "hpux"
	ifneq "${TARGET_OS}" "cygwin"
		ifneq "${GCC_MINGW}" "yes"
            #all platforms except HP-UX, CygWin and MinGW:
			LINK_LIBS           =-ldl -lm
		endif
	endif
else
            #HP-UX only:
			LINK_LIBS           =-lcl -lm -lnsl
endif


ifeq "${GCC_MINGW}" "yes"
	#LINK_LIBS		+=-lc
	#LINK_LIBS		+=-lgcc
	#strcasecmp():
	LINK_LIBS		+=-lmoldname
endif



ifeq "${TARGET_OS}" "darwin"
		#This is to make ONLY dlopen() loadable library, not a standard
        #shared one, ("bundle") so we will need separate setting for
		#libaubit4gl.dynlib
		#
		#cc -dynamiclib -install_name /usr/local/lib/libfoo.2.dylib \
		# -compatibility_version 2.4 -current_version 2.4.5 \
		# -o libfoo.2.4.5.dylib source.o code.o
		#rm -f libfoo.2.dylib libfoo.dylib
		#ln -s libfoo.2.4.5.dylib libfoo.2.dylib
		#ln -s libfoo.2.4.5.dylib libfoo.dylib
		#
		#Also note that the static linker will use the libfoo.dylib symlink,
		#while the dynamic linker will use the libfoo.2.dylib symlink. It is
		#possible to point these symlinks at different minor revisions of
		#the library.

        INST_PATH=$(INSTALL_DIR)/lib
		INST_NAME=${INST_PATH}/libaubit4gl${SO_EXT_LINKABLE}
        #INST_NAME=${AUBITDIR}/lib/libaubit4gl${SO_EXT_LINKABLE}

        SO_LDFLAGS1=$(SO_LDFLAGS:%-flat_namespace=%)
		SO_LDFLAGS2=$(SO_LDFLAGS1:%-bundle=%)
		SO_LDFLAGS3=$(SO_LDFLAGS2:%-undefined=%)
		#SO_LDFLAGS_NOBUNDLE=-r $(SO_LDFLAGS3:%suppress=%)
		SO_LDFLAGS_NOBUNDLE=-dynamiclib \
			-install_name ${INST_NAME} \
			$(SO_LDFLAGS3:%suppress=%)
        #FIXME: -install_name like this will not work after 'make install'!
        #since is in effect hard coded path to the lib file
		#we will have to link two libraries, one for use in source tree,
        #and one to install
else
		SO_LDFLAGS_NOBUNDLE=${SO_LDFLAGS}
endif

.PHONY: all ci splint lclint api clean clean.generated clean.api api.headers

## ==================================================================
##                              Targets
## ==================================================================

all: ${ALL}
	@echo "Default targets (${ALL}) built successfully."

${LIBROOT}/libaubit4gl${SO_EXT_LINKABLE} : $(OBJS)
	${LD} ${SO_LDFLAGS_NOBUNDLE} -o $@ $^ ${LINK_LIBS}
ifeq "${TARGET_OS}" "darwin"
	${MKPATH} ${INST_PATH}
	${CP} $@ ${INST_PATH}
endif
ifeq "${SO_EXT_LINKABLE}" ".dll"
	${MV} TMP${SOEXP_EXT} $@.a
endif

## ==================================================================
##                             Sub Targets
## ==================================================================

ci: $(CMODS)
	ci -l  $^

project.o: ${LIBROOT}/generated/${CMODS_PROJECT}
	${CC} ${CFLAGS} -c -o $@ $^

${LIBROOT}/generated/project.c:
	(cd ${ROOT}/tools/project; ${SH} mkproject)

${LIBROOT}/generated/tmperrs.h :
	${SH} ${LIBROOT}/bin/mkerrors

${ROOT}/compilers/fcompile/form_x_xdr.c  ${ROOT}/compilers/fcompile/form_x.h:
	${MAKE} -C ${ROOT}/compilers/fcompile rpc

${ROOT}/compilers/fcompile/form_x_xdr.o: ${ROOT}/compilers/fcompile/form_x_xdr.c
	${CC} ${CFLAGS_FORM_X_XDR_C} -c -o $@ $^

#initializer element is not computable at load time:
builtin.o: builtin.c
	${CC} ${CFLAGS_NO_PEDANTIC} -c -o $@ $*.c
stack.o: stack.c
	${CC} ${CFLAGS_NO_PEDANTIC} -c -o $@ $*.c
stack_ops.o: stack_ops.c
	${CC} ${CFLAGS_NO_PEDANTIC} -c -o $@ $*.c
debug.o: debug.c
	${CC} ${CFLAGS_API_C} -c -o $@ $^

${ROOT}/common/dataio/form_x.x.h:
	${MAKE} -C ${ROOT}/common/dataio

## ==================================================================
##                        Dependencies
## ==================================================================

error.c : ${LIBROOT}/generated/tmperrs.h
array.o: array.c ${ROOT}/compilers/fcompile/form_x_xdr.c
builtin.o API_ui.c: ${ROOT}/compilers/fcompile/form_x.h
${COMMONSRC}: api ${ROOT}/common/dataio/form_x.x.h
${CMODS_API}: ${ROOT}/common/dataio/form_x.x.h

${LIBROOT}/resource/resource.o:
	${MAKE} -C ${LIBROOT}/resource resource.o 

## ==================================================================
##                         Other Targets
## ==================================================================

splint: lclint
lclint: $(CMODS)
	${LCLINTERR}${LCLINTEXE} ${LCLINTFLAGS} $(LCLINT_CFLAGS) $(CMODS) > ${LCLINTLOG} ${LCLINTLOGCMD}
	${CAT} ${LCLINTLOG} >> ${ROOT}/${LCLINT_GLOBAL_LOG}
	@echo "see ${LCLINTLOG} for results"

## ==================================================================
##                         API Targets
## ==================================================================

################
#Target to create ALL API objects. Must include list of all API header files
#as dependency since they are all included via a4gl_aubit4gl.h
api: ${OBJS_API} $(addprefix ${INCL_PATH}/a4gl_,${API_SPEC:.spec=.h})
	@echo "Sucessfuly created API objects:"
	@echo ${OBJS_API}

###############
#Target to crate all API headers files
api.headers: $(addprefix ${INCL_PATH}/a4gl_,${API_SPEC:.spec=.h})
	@echo "Sucessfuly created API headers"

################
#Rule to make API .c file from .spec file
#When API c file is generated, coresponding .h file must also be created, but
#not in same target, since we need a way to create ALL headers in one go, since
#they are needed for all targets, because they are included in a4gl_aubit4gl.h:
API_%.c: API_%.spec ${INCL_PATH}/a4gl_API_%.h
	${SH} ${DLMAGIC} $< > $@

################
#Rule to make API header from .spec file:
${INCL_PATH}/a4gl_API_%.h: API_%.spec
	${SH} ${DLMAGIC} $^ -h > $@
	${SH} ${DLMAGIC} $^ -H > ${@:.h=_lib.h}
#The former is needed for the API_ui.c in lib/libaubit4gl the latter for the libui/* stuff


################
#Rule to make API objects
#Every API object needs coresponding .c file and ALL of the API headers:
API_%.o: API_%.c $(addprefix ${INCL_PATH}/a4gl_,${API_SPEC:.spec=.h})
	${CC} ${CFLAGS_API_C} -c -o $@ $<

## ==================================================================
##                        Clean Targets
## ==================================================================

#################
#Clean all files created in the process of making libaubit4gl:
clean : clean.generated clean.api
	${RM} $(OBJS) $(OBJS_DEBUG) menu_x.h menu_x_xdr.c \
		form_x_xdr.c form_x.h project.c core lclint.log \
		*.out *.glb *${SO_EXT_LINKABLE} *.a  *.o  *.bak *.dll *.stackdump *.err \
		*.base *.exp *.def .\#* API_lex.c

#################
#Clean all generated files (except API files)
clean.generated:
	${RM} ${LIBROOT}/generated/errdefs ${LIBROOT}/generated/tmperrs.h \
		${LIBROOT}/generated/project.c ${LIBROOT}/generated/project.o

#################
#Clean all .c and .h files created from .spec files, and object files
#for all API's
clean.api:
	${RM} $(addprefix ${INCL_PATH}/a4gl_,${API_SPEC:.spec=.h}) ${API_SPEC:.spec=.c} \
	${OBJS_API} $(addprefix ${INCL_PATH}/a4gl_,${API_SPEC:.spec=_lib.h})


#----------------------------------- EOF -------------------------------





