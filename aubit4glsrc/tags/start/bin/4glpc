#!/bin/sh
#/bin/bash
#this is main Aubit 4gl compiler .4gl files compiler script
#You should not need to invoke actual compiler (4glc) directly

#FIXME:
#uppercase 0, passed to 4glpc as "4gpc -O ..." is causing on CygWin:
#[: --help: unknown operand
#[: --help-options: unknown operand
#...etc...
#...but NOT on UNIX: Why?????

if [ $# -lt 1 -o "$1" = "--help" ]
then
    echo
	echo Aubit 4gl main compiler script: $0
    echo
    echo Usage:
    echo '  4glpc sourcefile.type [...] [options] executablename.4ge'
    echo '  4glpc sourcefile.4gl -c -o objectname.o'
    echo
    echo ' For details, try: '
    echo ' 4glpc --help-options	- for command line options'
    echo ' 4glpc --help-env	- for environment variables recognised'
	echo ' 4glpc --help-types	- for file types'
    echo ' 4glpc --help-examples	- for examples'
    echo
	exit 1
fi

if [ $# -lt 1 -o "$1" = "--help-options" ]
then
    echo
	echo Aubit 4gl main compiler script: $0
    echo
	echo Options:
    echo '  -o'
    echo '  -c'
	echo '  -shared/static ($USE_SHARED=Yes/no) compile with shared libraries'
    echo '  -echo  ($DOIT=echo) display CC command only, do not execute'
    echo '              this inhibits C compiler only, not the 4gl compiler'
    echo '  -debug  ($INCLLINES=Yes) include extra debuging code'
    echo '  -map/nomap ($MAP4GL=Yes) generate additional map file code'
    echo '  -maponly'
    echo '  -gtk/nogtk ($GTKGUI=Yes/No) include GTK libraries (default)'
    echo '  -verbose ($A4GLVERBOSE=yes) show additional info while compiling'
    echo '  -pdf ($USE_PDF=yes) use PDF report libraries when compiling'
	echo '      (if compiler was compiled with them)'
    echo '  -udbc (ODBC_LIB_NAME="udbc")'
    echo '  -odbc (ODBC_LIB_NAME="iodbc")'
    echo '  -as-ddl'
	echo
    echo All options unknown to Aubit compiler will be passed to C compiler
    echo Please see Aubit 4gl manual for more information.
    echo
    exit 1
fi

if [ $# -lt 1 -o "$1" = "--help-env" ]
then
#FIXME: find and list all env var's recognised
	echo
	echo Aubit 4gl main compiler script: $0
    echo
	echo Environment variables recognised:
    echo
	echo '  -shared/static ($USE_SHARED=Yes/no) compile with shared libraries'
    echo '  -echo  ($DOIT=echo) display CC command only, do not execute'
    echo '              this inhibits C compiler only, not the 4gl compiler'
    echo '  -debug  ($INCLLINES=Yes) include extra debuging code'
    echo '  -map/nomap ($MAP4GL=Yes) generate additional map file code'
    echo '  -maponly'
    echo '  -gtk/nogtk ($GTKGUI=Yes/No) include GTK libraries (default)'
    echo '  -verbose ($A4GLVERBOSE=yes) show additional info while compiling'
    echo '  -pdf ($USE_PDF=yes) use PDF report libraries when compiling'
	echo '      (if compiler was compiled with them)'
    echo '  -udbc (ODBC_LIB_NAME="udbc")'
    echo '  -odbc (ODBC_LIB_NAME="iodbc")'
    echo '  -as-ddl'
	echo
    echo 'Note: 4glc, cc and other compilers invoked by this script will'
    echo '      recognise additional variables that might affect this script'
    echo
	exit 1
fi


if [ $# -lt 1 -o "$1" = "--help-types" ]
then
    echo
	echo Aubit 4gl main compiler script: $0
    echo
	echo File types:
    echo '	4gl - 4gl source file, compiled to .c and then to .o'
    echo '	per - 4gl form file, compiled to .c and then to .o'
    echo '	msg - 4gl message file, compiled to .iem'
#FIXME: describe this:
	echo '	a   -'
    echo '	o   -'
    echo '	c   -'
    echo '	menu - Aubit 4gl GUI menu source, compiled to'
    echo
    exit 1
fi

if [ $# -lt 1 -o "$1" = "--help-examples" ]
then
#FIXME: describe this:
	echo Examples:
    echo
	echo '  4glpc sourcefile.4gl -o executablename.4ge'
	echo '  4glpc sourcefile.4gl -c -o objectname.o'
	echo '  4glpc -shared file.4gl -o file.4ge'
    echo '  4glpc -static -echo file.4gl -o file.4ge'
    echo '  4glpc -debug file.4gl -o file.debug'
    echo '  4glpc -map -echo file.4gl'
	echo '  4glpc -gtk file.4gl -o'
    echo
	exit 1
fi

if [ "$GTKGUI" = "" ]
then
	GTKGUI="Yes"
fi

if [ "$AUBITDIR" = "" ]
then
        AUBITDIR=`pwd`
fi

if [ "$COMSPEC" = "" ]
then
	if [ -f $AUBITDIR/.a4glrc ]
	then
	. $AUBITDIR/.a4glrc
	fi
	
	if [ -f $HOME/.a4glrc ]
	then
	. $HOME/.a4glrc
	fi
else
	if [ -f $AUBITDIR/CygWin/.a4glrc-win ]
	then
	. $AUBITDIR/CygWin/.a4glrc-win
	fi
fi

COMPCC=""

#LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$AUBITDIR/lib:$AUBITDIR/extlibs
#export LD_LIBRARY_PATH


FGLLIBSDIR="-L$AUBITDIR/lib"

if [ -d $AUBITDIR/extralibs ]
then
	FGLLIBSDIR="$FGLLIBSDIR -L$AUBITDIR/extralibs"
fi


if [ "$NCURSES_LIB_DIR"  != "" ]
then
        LIBSDIR="-L$NCURSES_LIB_DIR"
fi

if [ "$NCURSES_INCL_DIR"  != "" ]
then
        LIBSDIR="-L$NCURSES_INCL_DIR"
fi


if [ "$COMPILE_QUIET" != "" ]
then
        output=": "
else
        output="echo"
fi

if [ "$ODBC_LIB_NAME" = "" ]
then
	if [ "$COMSPEC" = "" ]
    then
		ODBC_LIB_NAME="iodbc"
    else
        ODBC_LIB_NAME="odbc32"
    fi
fi

# if this isnt set - try in extlibs....
if [ "$ODBC_LIB_DIR" = "" ]
then
        ODBC_LIB_DIR=$AUBITDIR/extlibs
fi

if [ "$ODBC_SHARED" = "" ]
then
        ODBC_SHARED="-L$ODBC_LIB_DIR"
fi

if [ "$ODBC_STATIC" = "" ]
then
        ODBC_STATIC="-L$ODBC_LIB_DIR"
fi


LAST=""
INCLDIR="-I$AUBITDIR/incl"

if [ "$COMSPEC" = "" ]
then
	GCC=${GCC:-"cc -O -g "}
else
	GCC=${GCC:-"gcc -O -g "}
fi

for a in $@
do
   case $a in
   *.a) COMPCC="$COMPCC $a"
   ;;

   *.o) COMPCC="$COMPCC $a"
		EXECNAME="1"
   ;;

   *.c) COMPCC="$COMPCC $a"
   ;;

   *.per) fcompile -c $a
          fname=`basename $a .per`
        COMPCC="$COMPCC $fname.c"
   ;;

   *.msg)
        fname=`basename $a .msg`
		mkmess $fname
		#COMPCC="$COMPCC $fname.c"
   ;;

   *.menu) mcompile -c $a
          fname=`basename $a .menu`
        COMPCC="$COMPCC $fname.c"
   ;;


   *.4gl)
          dirn=`dirname $a`
          fname=`basename $a .4gl`

          fname2="$dirn/$fname"
          fname=$fname2

          if [ -f "$fname".err ]
          then
                rm "$fname".err
          fi

          $output "$fname: "

		  if [ "$A4GLVERBOSE" = "yes" ]
		  then
	          $output ODBC_LIB_DIR is $ODBC_LIB_DIR
			  #LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ODBC_LIB_DIR
			  $output LD_LIBRARY_PATH is $LD_LIBRARY_PATH
              $output Executing: 4glc "$a"
          fi

          err_msg=`4glc "$a"`
          err_code=$?

          if [ "$err_code" != "0" ]
          then
                 $output "Error compiling $a"
				  if [ "$A4GLVERBOSE" = "yes" ]
				  then
                    $output err_msg is: $err_msg
                    $output err_code is: $err_code
                    $output Please check file "$fname".err
                    $output 'You can also "export DEBUG=ALL" to get "debug.out" file'
                  fi

				 exit 1
          fi

		  if [ "$A4GLVERBOSE" = "yes" ]
		  then
            $output 4glc "$a" OK, continue...
		  fi

          if [ "$AUTOINDENT" = "Y" ]
          then
                indent $fname.c
          fi

          if [ "$MAP4GL" = "Y" ]
          then
             if [ -x "$AUBITDIR/bin/loadmap" -a "$LOADMAP" != "N" ]
                then
                        $output "Loading map file for $a into database"
                        loadmap $fname.map > /dev/null 2> /dev/null
                fi
          fi

          if [ "$PRETTYC" != "" ]
          then
                $PRETTYC $fname.c
          fi

          COMPCC="$COMPCC $fname.c"
   ;;

   -echo) DOIT="echo"
   ;;

   -gtk) GTKGUI="Yes"
         export GTKGUI
	 ui="gui"
	export ui
   ;;

   -pdf) USE_PDF = "yes"
         export USE_PDF
   ;;


   -nogtk) GTKGUI="no"
        export GTKGUI
   ;;

   -verbose) A4GLVERBOSE="yes"
        export A4GLVERBOSE
   ;;

   -map)
        echo "Setting map file on"
        MAP4GL="Y"
        export MAP4GL
   ;;

   -maponly) MAP4GL="Y"
             NOCFILE="Y"
         export MAP4GL
   ;;

   -make-compile) MAKE4GLPC="Yes"
		export MAKE4GLPC
   ;;

   -nomap) unset MAP4GL
   ;;

   -debug) INCLINES=""
           export INCLINES
           #DDEBUG="_g"
           COMPCC="$COMPCC -g"
   ;;

   -udbc) ODBC_LIB_NAME="udbc"
   ;;

   -odbc) if [ "$COMSPEC" = "" ]
		then
		   ODBC_LIB_NAME="iodbc"
        else
			ODBC_LIB_NAME="odbc32"
        fi
   ;;

   -as-dll) COMPCC="$COMPCC -shared"
   ;;

   -shared)  if [ "$COMSPEC" = "" ]
            then
			   USE_SHARED="Yes"
            else
				FGLLIBS="$FGLLIBS_SHARED $ODBC_SHARED"
	            export FGLLIBS
            fi
   ;;

   -static) if [ "$COMSPEC" = "" ]
            then
				USE_SHARED="No"
            else
				export FGLLIBS="$FGLLIBS_STATIC $ODBC_STATIC"
            fi

   ;;

   -o) COMPCC="$COMPCC -o "
       ISMAKE=-1

       LAST="2> $fname.err"
       ERRFILE="$fname.err"
       DEFAULTCOMPCC="$COMPCC $fname"
       EXECNAME="-1"


   ;;

   #same as -o, needed to distinguish from I4GL objects in universal makefiles:
   -ao) COMPCC="$COMPCC -o "
       ISMAKE=-1

       LAST="2> $fname.err"
       ERRFILE="$fname.err"
       DEFAULTCOMPCC="$COMPCC $fname"
       EXECNAME="-1"
   ;;


   *) if [ "$ISMAKE" = "-1" ]
      then
         EXECNAME="$a"
		 ISMAKE=1
         LAST="2> $a.err"
         ERRFILE="$a.err"
      fi
      COMPCC="$COMPCC $a"
  ;;
  esac
done

if [ "$EXECNAME" = "-1" ]
then
    COMPCC=$DEFAULTCOMPCC
	$output "-o specified without object name, default name is $fname"
	if [ "$ISMAKE" = "-1" ]
    then
         ISMAKE=1
    fi
fi

if [ "$COMSPEC" = "" ]
then
    #echo COMSPEC not defined: $COMSPEC
	FGLLIBS_SHARED=" -L$AUBITDIR/lib -L../../lib -laclshared"$ui" -lm -ldl"
	FGLLIBS_STATIC=" -L$AUBITDIR/lib -L../../lib -laclall"$ui" -lm -ldl"
else
    #echo COMSPEC defined: $COMSPEC
	FGLLIBS_SHARED=" -L$AUBITDIR/lib -L../../lib -laclallgui -lm -lrpclib  -L/lib/w32api -lodbc32 -lodbccp32"
	FGLLIBS_STATIC=" -L$AUBITDIR/lib -L../../lib -laclallgui -lm  -lrpclib -L/lib/w32api -lodbc32 -lodbccp32"
fi

if [ "$USE_PDF" = "yes" ]
then
	FGLLIBS_SHARED=$FGLLIBS_SHARED " -lpdf"
	FGLLIBS_STATIC=$FGLLIBS_STATIC " -lpdf"
fi

if ! [ "$COMSPEC" = "" ]
then
    CYLIBSNOVER="-lgdk -lgtk -lglib"
	CYLIBSSPECVER="-lgdk-1.3 -lgtk-1.3 -lglib-1.3"
	CYLIBS="-lgtk4gl -lcurses "
	FGLLIBS_SHARED="$FGLLIBS_SHARED $CYLIBS $CYLIBSSPECVER"
	FGLLIBS_STATIC="$FGLLIBS_STATIC $CYLIBS $CYLIBSSPECVER"
fi

#echo $FGLLIBS_SHARED
#echo $FGLLIBS_STATIC

if [ "$USE_SHARED" = "Yes" ]
then
        if [ "$ODBC" = "" ]
        then
                ODBC=$ODBC_SHARED
        fi

        FGLLIBS="$FGLLIBS_SHARED $ODBC"
else
        if [ "$ODBC" = "" ]
        then
                ODBC=$ODBC_STATIC
        fi

        FGLLIBS="$FGLLIBS_STATIC $ODBC_STATIC"
fi

#echo FGLLIBS = $FGLLIBS
#exit

LIBS="-lform$DDEBUG -lpanel$DDEBUG -lncurses$DDEBUG -L$ODBC_LIB_DIR -l$ODBC_LIB_NAME"

if [ "$NOCFILE" = "Y" ]
then
        exit
fi

if [  "$GTKGUI" = "Yes" ]
then
	if [ "$COMSPEC" = "" ]
	then
		if  [ "$MAKE4GLPC" = "Yes" ]
		then
	        	LIBS="$LIBS"
		else
	        	LIBS="$LIBS -lgtk4gl -lgdk -lgtk -lgtk4gl_x"
		fi
    else
		if  [ "$MAKE4GLPC" = "Yes" ]
		then
			#LIBS="$LIBS -lgtk4gl -lgdk -lgtk -lgtk4gl_x "
        	LIBS="$LIBS -lgtk4gl -lgdk -lgtk "
		fi
    fi
fi

if [ "$ISMAKE" != "1" ]
then
#	EXEC="$DOIT $GCC $COMPCC -c $INCLDIR $LAST"
	if [ "$COMSPEC" = "" ]
	then
		EXEC="$DOIT $GCC $COMPCC $INCLDIR $LAST"
    else
        EXEC="$DOIT $GCC $COMPCC -c $INCLDIR $LAST"
    fi

   if [ "$A4GLVERBOSE" = "yes" ]
   then
        $output executing: $EXEC
   fi

   eval $EXEC

else
   $output "Generating Exec"

   if [ "$A4GLVERBOSE" = "yes" ]
   then
	   $output executing: $DOIT $GCC $COMPCC  $INCLDIR  $FGLLIBSDIR $FGLLIBS $LIBSDIR $LIBS $LAST
   fi
   eval $DOIT $GCC $COMPCC  $INCLDIR  $FGLLIBSDIR $FGLLIBS $LIBSDIR $LIBS $LAST 

   if [ $? != 0 ]
   then
      $output "Error compiling... check"`expr "$LAST" : "..\(.*\)"`
   fi
fi

if [ "$ERRFILE" != "" -a ! -s "$ERRFILE" ]
then
	if [ -f "$ERRFILE" ]
    then
		rm $ERRFILE
	fi
fi






