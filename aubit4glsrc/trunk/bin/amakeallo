#!/bin/sh

######################################################################
#Aubit 4gl
#amakeallo - Compiles all 4gl filles in current directory to objects
#
#Very usefull for finding compiler syntax errors on large number of 4gl
#files. Run it in your 4gl program's directory, and it will generate
#log of all compiles, and copy all problematic files in separate
#directory, including err and c files.
#
#n/amakeallo: [: too many arguments    - only with 4js ????
#try qyerix
######################################################################

############################
function stats {
############################

if test $AMAKE = "1"
then

    let TOTALIGNORE=FAILANYWAY+FAILCOMPATIBLE+FAILDEFLIKE+DUPLICATE

    echo " "
	echo "Attempted to compile total of $ATTEMPTED"
	echo "OK= $AMAKEOK, failed= $AMAKEFAIL, already compiled= $COMPBEFORE "
	echo "IGNORED: total= $TOTALIGNORE : $FAILANYWAY that fail to compiled as 4gl files, $DUPLICATE duplicated errors,"
	echo "$FAILCOMPATIBLE since they fails in alt compiler, $FAILDEFLIKE on DEFINE LIKE not in database"
	echo "See $AMAKEERRORLOG and $LINKFAILLIST"

    echo " " >> $AMAKEERRORLOG
	echo "Attempted to compile total of $ATTEMPTED" >> $AMAKEERRORLOG
	echo "OK= $AMAKEOK, failed= $AMAKEFAIL, already compiled= $COMPBEFORE ." >> $AMAKEERRORLOG
	echo "IGNORED: total= $TOTALIGNORE : $FAILANYWAY that fail to compiled as 4gl files, $DUPLICATE duplicated errors," >> $AMAKEERRORLOG
	echo "$FAILCOMPATIBLE since they fails in alt compiler, $FAILDEFLIKE on DEFINE LIKE not in database" >> $AMAKEERRORLOG
	echo "See $AMAKEERRORLOG and $LINKFAILLIST" >> $AMAKEERRORLOG
	date >> $AMAKEERRORLOG


else

	let TOTALFAILED=COMPFAIL4GL+COMPFAILCCOMP+COMPFAILCORE+COMPFAILUNKNOWN+FAILCOMPATIBLE
    echo " "
	echo "Attempted to compile total of $ATTEMPTED , and $ATTEMPTEDGLOBALS GLOBALS files"
	echo "$COMPSUCCESS successfully compiled, $COMPFAIL4GL failed in 4gl, $COMPBEFORE already compiled."
    echo "$COMPFAILCCOMP failed in C compiler, $COMPFAILCORE dumped core, $COMPFAILUNKNOWN failed for unknown reason."
    echo "$TOTALFAILED total failed. $FAILCOMPATIBLE failed in both compilers and assumed OK."
    echo "$CCOMPWARNING produced warnings from C compiler, but compiled. Ignored $ZEROFILESIZE Files with no code."
	echo "$NOGLBFILE glb files not found, $OKNOGLBFILE compiled on the fly, $NO4GLNOGLBFILE 4gl's for making glb not found."
    echo "$TESTCONTINUESKIP skipped since they failed in previous run, $FAILDEFLIKE failed on missing DEFINELIKE and ignored."
	date

    echo " " >> $ERRORLOG
	echo "Attempted to compile total of $ATTEMPTED, and $ATTEMPTEDGLOBALS GLOBALS files" >> $ERRORLOG
	echo "$COMPSUCCESS successfully compiled, $COMPFAIL4GL failed in 4gl, $COMPBEFORE already compiled." >> $ERRORLOG
    echo "$COMPFAILCCOMP failed in C compiler, $COMPFAILCORE dumped core, $COMPFAILUNKNOWN failed for unknown reason." >> $ERRORLOG
    echo "$TOTALFAILED total failed. $FAILCOMPATIBLE failed in both compilers and assumed OK." >> $ERRORLOG
    echo "$CCOMPWARNING produced warnings from C compiler, but compiled. Ignored $ZEROFILESIZE Files with no code." >> $ERRORLOG
	echo "$NOGLBFILE glb files not found, $OKNOGLBFILE compiled on the fly, $NO4GLNOGLBFILE 4gl's for making glb not found." >> $ERRORLOG
    echo "$TESTCONTINUESKIP skipped since they failed in previous run, $FAILDEFLIKE failed on missing DEFINELIKE and ignored." >> $ERRORLOG
	echo "See also:" >> $ERRORLOG
	echo "All zero length files		:$ZEROLOG" >> $ERRORLOG
	echo "All 4gl compiler errors	:$FGLLOG" >> $ERRORLOG
	echo "All C compiler errors		:$CLOG" >> $ERRORLOG
	echo "All core dumps			:$CORELOG" >> $ERRORLOG
    echo "All GLOBALS errors		:$GLOBLOG" >> $ERRORLOG


	date >> $ERRORLOG

	echo " " >> $ZEROLOG
	echo "Ignored $ZEROFILESIZE Files with no code." >> $ZEROLOG
	date >> $ZEROLOG

	echo " " >> $FGLLOG
	echo "$COMPFAIL4GL failed in 4gl"  >> $FGLLOG
	date >> $FGLLOG

	echo " " >> $CLOG
    echo "$COMPFAILCCOMP failed in C compiler" >> $CLOG
	date >> $CLOG

	echo " " >> $CORELOG
	echo "$COMPFAILCORE dumped core." >> $CORELOG
	date >> $CORELOG

    echo " " >> $GLOBLOG
	echo "$NOGLBFILE glb files not found, $OKNOGLBFILE compiled on the fly, $NO4GLNOGLBFILE 4gl's for making glb not found." >> $GLOBLOG
    date >> $GLOBLOG
fi

}

############################
function shortstats {
############################
	if test $AMAKE = "1"
	then
		echo "Tried=$ATTEMPTED OK=$AMAKEOK Fail=$AMAKEFAIL Previous=$COMPBEFORE IGN: aubit=$FAILANYWAY alt=$FAILCOMPATIBLE LIKE=$FAILDEFLIKE"
    else
		echo "OK=$COMPSUCCESS 4gl=$COMPFAIL4GL skip=$COMPBEFORE c=$COMPFAILCCOMP core=$COMPFAILCORE ?=$COMPFAILUNKNOWN compat=$FAILCOMPATIBLE glb=$OKNOGLBFILE/$NOGLBFILE/$NO4GLNOGLBFILE cw=$CCOMPWARNING 0=$ZEROFILESIZE &=$TESTCONTINUESKIP L=$FAILDEFLIKE"
    fi


}

##########################
function analiseerror {
##########################

		if [ -f $ERR ]
		then
			echo "########################################## ($RET) $PWD/$ERR :" >> $ERRORLOG

            #we now return exit codes from CC or fglc, so we need to test this way
            #if the error file was created by 4glc or c compiler:
			ERRLINES=`cat $ERR | grep -c $ERRCHAR`
			if [ "$SCRIPTDEBUG" = "1" ]
		    then
    			echo "ERRLINES found in $ERR = $ERRLINES"
            fi
			if test $ERRLINES != "0"
			then
				cat $ERR | grep -B $GOBACKLINES -A $GOAFTERLINES $ERRCHAR >> $ERRORLOG

				echo "########################################## ($RET) $PWD/$ERR :" >> $FGLLOG
				cat $ERR | grep -B $GOBACKLINES -A $GOAFTERLINES $ERRCHAR >> $FGLLOG
				echo "##########################################################" >> $FGLLOG

				let COMPFAIL4GL=COMPFAIL4GL+1
				if [ "$VERBOSE" = "1" ]
			    then
					echo "$FGLCOMPILER failed: $PWD/$FGL"
	            fi
			else
				$HEAD $ERR  >> $ERRORLOG

				echo "########################################## ($RET) $PWD/$ERR :" >> $CLOG
				$HEAD $ERR  >> $CLOG
				echo "##########################################################" >> $CLOG

				let COMPFAILCCOMP=COMPFAILCCOMP+1
				if [ "$VERBOSE" = "1" ]
			    then
					echo "CC failed: $PWD/$FGL"
	            fi
			fi

		else  #compiler returner error code, but there is no err file
			if [ -f $OBJERR ]
            then #C compiler failed when linking
				echo "########################################## ($RET) $PWD/$OBJERR :" >> $ERRORLOG
				if [ "$VERBOSE" = "1" ]
			    then
					echo "cc failed: $PWD/$FGL"
                fi
		        $HEAD $OBJERR >> $ERRORLOG

				echo "########################################## ($RET) $PWD/$OBJERR :" >> $CLOG
		        $HEAD $OBJERR >> $CLOG
				echo "##########################################################" >> $CLOG


				let COMPFAILCCOMP=COMPFAILCCOMP+1
            else
			    if [ "$VERBOSE" = "1" ]
			    then
					echo "$FGLCOMPILER failed ($RET) (no .err): $PWD/$FGL"
                fi
				echo "########################################## ($RET) $PWD/$i :" >> $ERRORLOG
				echo "$FGLCOMPILER failed ($RET) (no .err)" >> $ERRORLOG
                #is this one of 0 size 4gl files?
				ls -al $i >> $ERRORLOG
				#-rw-r--r--   1 root     root            0 Sep  8 13:24 cheqappl.4gl
				FGLFILESIZE=$(ls -al $i | awk '{print $5}')

				if [ "$VERBOSE" = "1" ]
	    		then
					echo FGLFILESIZE is $FGLFILESIZE
                fi
                if [ "$FGLFILESIZE" = "0" ]
                then
                    echo "This is zero size file, ignoring."
                    echo "This is zero size file, ignoring."  >> $ERRORLOG
                    echo "#$PWD/$i" >> $ZEROLOG
					ls -al $i >> $ZEROLOG
					let ZEROFILESIZE=ZEROFILESIZE+1
				else
					ls core > /dev/null 2>&1
					RET=$?
					if test $RET = "0"
					then
						if [ "$VERBOSE" = "1" ]
					    then
							echo Core was dumped...
                            echo $PWD/$i >> $CORELOG
	                    fi
						echo "Core was dumped..."  >> $ERRORLOG
						rm core
						let COMPFAILCORE=COMPFAILCORE+1
					else
	                    #we have no err file, no object err file, and no core was dumped:
						echo "NOT a core dump. UNKNOWN failure reason."  >> $ERRORLOG
						echo "NOT a core dump. UNKNOWN failure reason."
						let COMPFAILUNKNOWN=COMPFAILUNKNOWN+1
					fi;
                fi
			fi
		fi;
		echo "##########################################################" >> $ERRORLOG


}


########################
function copyerrfiles {
########################
#if error occured, copy all files relevant for debugging to isolated place:


	cp $i $ERRFILESDIR   #4gl file

	if [ -f $ERR ]
    then
		cp $ERR $ERRFILESDIR   #err file
        HAVEERRFILE=1
    fi

	if [ "$COMPILER" = "aubit" ]
	then
		if [ -f $CFILE ]
        then
			cp $CFILE $ERRFILESDIR
            HAVECFILE=1
        fi
		if [ -f $HFILE ]
        then
			cp $HFILE $ERRFILESDIR
            HAVEHFILE=1
        fi
		if [ -f $GFILE ]
        then
			cp $GFILE $ERRFILESDIR
            HAVEGFILE=1
        fi
		if [ -f $OBJERR ]
        then
			cp $OBJERR $ERRFILESDIR
            HAVEOBJERRFILE=1
        fi
    fi


}


##################
function clean {
##################

	ls *.4gl > /dev/null 2>&1
	RET=$?
	if test $RET != "0"
	then
		if [ "$VERBOSE" = "1" ]
    	then
			echo "No .4gl files in current directory."
    	    return
        fi
    fi

	if [ "$VERBOSE" = "1" ]
    then
		echo "Cleaning..."
    fi

	ls *.err > /dev/null 2>&1
	RET=$?
	if test $RET = "0"
	then
		if [ "$VERBOSE" = "1" ]
    	then
			echo Removing .err
        fi
		rm *.err
	fi

	ls *.$COMPEXT > /dev/null 2>&1
	RET=$?
	if test $RET = "0"
	then
		if [ "$VERBOSE" = "1" ]
	    then
			echo Removing .$COMPEXT
        fi
		rm *.$COMPEXT
	fi

	ls core > /dev/null 2>&1
	RET=$?
	if test $RET = "0"
	then
		if [ "$VERBOSE" = "1" ]
    	then
			echo Removing core
        fi
		#FIXME: on CygWin remove *.stackdump
		rm core
	fi


	if [ "$COMPILER" = "aubit" ]
	then

		ls *.$COMPEXT2 > /dev/null 2>&1
		RET=$?
		if test $RET = "0"
		then
			if [ "$VERBOSE" = "1" ]
		    then
    			echo Removing .$COMPEXT2
            fi
			rm *.$COMPEXT2
		fi
    fi

    if test $FULLCLEAN = "1"
    then
		if [ "$VERBOSE" = "1" ]
	    then
            echo "Full clean is ON"
        fi

        #if we remove glb files, and skip is on, in second run all 4gl's
        #that look for them wil fail, so we normally don't want to clean them.
		if [ "$COMPILER" = "aubit" ]
		then
			ls *.glb > /dev/null 2>&1
			RET=$?
			if test $RET = "0"
			then
				if [ "$VERBOSE" = "1" ]
			    then
					echo Removing .glb
                fi
				rm *.glb
			fi
        fi

		#his can be dangerous, tere might be some C code in there?
		ls *.c > /dev/null 2>&1
		RET=$?
		if test $RET = "0"
		then
			if [ "$VERBOSE" = "1" ]
		    then
				echo Removing .c
            fi
			rm *.c
		fi

		#this can also be dangerous, we might have some header files for custom C code there:
		ls *.h > /dev/null 2>&1
		RET=$?
		if test $RET = "0"
		then
			if [ "$VERBOSE" = "1" ]
		    then
				echo Removing .h
            fi
			rm *.h
		fi


		#this can be dangerous too, we might have some .ec code there?
		ls *.ec > /dev/null 2>&1
		RET=$?
		if test $RET = "0"
		then
			if [ "$VERBOSE" = "1" ]
		    then
				echo Removing .ec
            fi
			rm *.ec
		fi

	fi


}


############################
function compileit {
############################

	if test "$DOINGGLOBALS" = "1"
    then
		let ATTEMPTEDGLOBALS=ATTEMPTEDGLOBALS+1
    else
		let ATTEMPTED=ATTEMPTED+1
    fi

	##########
	shortstats
    ##########

    #######################
    #set needed variables:
    #######################
	pwd=`pwd`
	HFILE=`basename $i .4gl`.h;             #h
	GFILE=`basename $i .4gl`.glb;           #glb
	AO=`basename $i .4gl`.$COMPEXT2;        #ao
	OBJERR=$AO.err              	        #ao.err
	X=`basename $i .4gl`.$COMPEXT;          #o
	ERR=`basename $i .4gl`.err;             #err
	CFILE=`basename $i .4gl`.c;             #c

	if test "$SCRIPTDEBUG" = "1111"
   	then
		echo $pwd
		echo $HFILE
		echo $GFILE
		echo $AO
		echo $OBJERR
		echo $X
		echo $ERR
		echo $CFILE

    fi

    HAVEERRFILE=0
    HAVECFILE=0
    HAVEHFILE=0
	HAVEGFILE=0
    HAVEOBJERRFILE=0

    #########################
	#Is is already compiled?
    #########################
	if test "$SKIP" = "1"
	then
		if [ -f $DESTDIR/$X ]
		then
		    if [ "$VERBOSE" = "1" ]
		    then
				echo "$DESTDIR/$X exists - skip is on"
            fi
			let COMPBEFORE=COMPBEFORE+1
			return
		else
			if [ "$COMPILER" = "aubit" ] && [ -f $DESTDIR/$AO ]
			then
			    if [ "$VERBOSE" = "1" ]
			    then
					echo "$DESTDIR/$AO exists - skip is on"
                fi
				let COMPBEFORE=COMPBEFORE+1
				return
			fi
		fi

		if [ "$VERBOSE" = "1" ]
	    then
			echo $DESTDIR/$X or $AO not found
	    fi
	fi

    ##################################
    #Are we continuing same testing?
    ##################################
	if test $TESTCONTINUE = "1"
   	then
		if [ -f $ERRFILESDIR/$i ]
        then
			let TESTCONTINUESKIP=TESTCONTINUESKIP+1
			echo "Continue - $i already tried and failed"
            echo "Continue - $i already tried and failed"   >> $ERRORLOG
            return
        fi
    fi

    #######################
	#set compiler command:
    #######################
	if [ "$COMPILER" = "aubit" ]
	then
		#$FGLCOMPILER file.4gl -c -o file.o
		#COMPCMD="$FGLCOMPILER $i -c -o $X"
		#COMPCMD="$FGLCOMPILER $i -o $X"

		if test $SCRIPTDEBUG = "1"
    	then
			COMPCMD="$FGLCOMPILER -verbose $i -c -o $AO"
        else
			COMPCMD="$FGLCOMPILER $i -c -o $AO"
			export COMPILE_QUIET=yes
			#2) Its compiled with -g
            #3) Its compiled with bison --debug
			#export DEBUG=ALL
            unset DEBUG
        fi
	fi


	if [ "$COMPILER" = "4js" ]
	then
		COMPCMD="$FGLCOMPILER $i"
	fi

	if [ "$COMPILER" = "querix" ]
	then
		COMPCMD="$QUERIXCMPLCMD $i"
	fi

	if [ "$COMPILER" = "informix" ]
	then
		COMPCMD="$ICOMPILER $i"
	fi



    ######################
	#Run compiler command:
    ######################
	if [ "$VERBOSE" = "1" ]
    then
		echo "Run $COMPCMD in $pwd"
    fi

	if test "$SCRIPTDEBUG" = "1"
	then
		echo "#Running $COMPCMD (in $pwd):"  >> $ERRORLOG 2>&1;
    fi

	err_msg=`$COMPCMD > /tmp/compmsg.tmp 2>&1`
	RET=$?
    
	###########################
    #get message from compiler:
    ###########################
	if [ "$err_msg" != "" ]
    then
		if test "$SCRIPTDEBUG" = "1"
   		then
			echo "MSG from compiler: $err_msg"   >> $ERRORLOG 2>&1;
        fi
	    if [ "$VERBOSE" = "1" ]
    	then
			echo "MSG from compiler: $err_msg"
        fi
    else
        if [ -f /tmp/compmsg.tmp ]
        then
			err_msg=`cat /tmp/compmsg.tmp`
        fi
	    if [ "$err_msg" != "" ]
	    then
			if test $SCRIPTDEBUG = "1"
   			then
				echo "MSG from compiler: $err_msg"   >> $ERRORLOG 2>&1;
            fi
		    if [ "$VERBOSE" = "1" ]
	    	then
				echo "MSG from compiler: $err_msg"
	        fi
        fi
	fi

    ######################################################
    #is error caused by missing glb file - try to make it:
    ######################################################
	if test $RET = "7"
    then
		#FIXME:
		#ret code 7 will be only with Aubit, but other compilers can fail on missing 4gl file that
        #contains GLOBALS too!
        #FIXME:
        #this should no longer happen in Aubit, it should now automaticaly create .glb
		if [ "$COMPILER" = "aubit" ]
        then
			let NOGLBFILE=NOGLBFILE+1

			#on exit code 7, $err_msg will be something like:
			#"Couldnt open globals file ../ar/AC.glb"
			DEPENDGLOB4GLFILE=$(echo $err_msg | awk '{print $5}')
			if [ "$VERBOSE" = "1" ]
	    	then
		        echo "File $DEPENDGLOB4GLFILE need to be prepared before $PWH/$i"
	        fi
	        echo "File $DEPENDGLOB4GLFILE need to be prepared before $PWD/$i"  >> $ERRORLOG
	        echo "File $DEPENDGLOB4GLFILE need to be prepared before $PWD/$i"  >> $GLOBLOG

            DIRNAME=`dirname $DEPENDGLOB4GLFILE`
	        DEPEND4GLFILE=`basename $DEPENDGLOB4GLFILE .glb`.4gl;
            DEPEND4GLFILE=$DIRNAME/$DEPEND4GLFILE
			DEPEND4GLOBJ=`basename $DEPENDGLOB4GLFILE .glb`.ao;
			DEPEND4GLERR=`basename $DEPENDGLOB4GLFILE .glb`.err;

            if ! [ -f $DEPEND4GLFILE ]
            then
			    if [ "$VERBOSE" = "1" ]
		    	then
					echo "$DEPEND4GLFILE not found - aborting"
                fi
                echo "$DEPEND4GLFILE not found - aborting"  >> $ERRORLOG
                echo "$DEPEND4GLFILE not found - aborting"  >> $GLOBLOG
				let NO4GLNOGLBFILE=NO4GLNOGLBFILE+1
		        echo "##########################################################" >> $ERRORLOG
				return
			fi


			A4GLGLOBPC="$FGLCOMPILER $DEPEND4GLFILE -c -o $DEPEND4GLOBJ"

		    if [ "$VERBOSE" = "1" ]
	    	then
		        echo "Running $A4GLGLOBPC"
	        fi
	        echo "Running $A4GLGLOBPC" >> $ERRORLOG 2>&1;

			err_msg=`eval "$A4GLGLOBPC"`
			RET=$?

		    if [ "$err_msg" != "" ]
		    then
		        echo "$err_msg"   >> $ERRORLOG 2>&1;
			    if [ "$VERBOSE" = "1" ]
		    	then
					echo "$err_msg"
		        fi
		    fi

			if test $RET = "0"
		    then
			    let OKNOGLBFILE=OKNOGLBFILE+1
	        else
			    if [ "$VERBOSE" = "1" ]
	    		then
					echo "Compiling $DEPENDGLOB4GLFILE from $PWD failed ($RET)."
	            fi
				echo "Compiling $DEPENDGLOB4GLFILE from $PWD failed ($RET)."  >> $ERRORLOG
				echo "Compiling $DEPENDGLOB4GLFILE from $PWD failed ($RET)."  >> $GLOBLOG


		        ######################################################
		        #is this "does not exist in the database ()" error ?
		        ######################################################

				if [ -f $DEPEND4GLERR ]
                then

					ERRLINES=`cat $DEPEND4GLERR | grep -c "does not exist in the database ()"`
					if [ "$SCRIPTDEBUG" = "1" ]
				    then
			    			echo "'does not exist in the database ()' found in $DEPEND4GLERR = $ERRLINES"
			        fi
					if test $ERRLINES != "0"
					then
				        let FAILDEFLIKE=FAILDEFLIKE+1
					    if [ "$VERBOSE" = "1" ]
					    then
							echo "Ignoring error - fails DEFINE LIKE not in database."
			            fi
						echo "Ignoring error - fails DEFINE LIKE not in database." >> $ERRORLOG
					    #FIXME: log filename to $DEFINELIKELIST
			            #FIXME: extract error lines to $DEFINELIKEERROR
				        echo "##########################################################" >> $ERRORLOG
						return
			        fi
                else
					echo "$DEPEND4GLERR not created." >> $ERRORLOG
				    if [ "$VERBOSE" = "1" ]
				    then
						echo "$DEPEND4GLERR not created."
                    fi
				fi

                #Fixme: code for this:
                ####################################################
				#is this "is not a variable ()" error?
                ####################################################



				WASERROR=1
				#we will step on this file again, so we don't want to count this twice:
				#let COMPFAIL4GL=COMPFAIL4GL+1
		        echo "##########################################################" >> $ERRORLOG
				if test $STOPONERROR = "1"
			    then
					echo "Stop."
					exit 1
			    else
					return
				fi

	        fi

			echo "Compiling $DEPENDGLOB4GLFILE from $PWD OK ($RET)."  >> $GLOBLOG

	        #now try it again:
		    err_msg=`eval "$COMPCMD"`
			RET=$?
        fi
	fi

    ################################
    #did compiler retur error code?
    ################################
	if test $RET != "0"
	then
        ##################################################
		#does this fails in alternative 4gl compiler too?
        ##################################################
        if [ "$COMPILER" = "aubit" ] && [ "$COMPATIBLE" = "1" ]
        then
			if test $SCRIPTDEBUG = "1"
   			then
				echo "Trying same in $ALTCOMPILER compiler:"  >> $ERRORLOG
            fi
			if [ "$VERBOSE" = "1" ]
		    then
				echo "Trying same in $ALTCOMPILER compiler:"
            fi

			if test "$USECOMPATFILE" = "1"
            then
                #look at ALTFAILLIST for failed files:
				if [ -f "$ALTFAILLIST" ]
                then
					ERRLINES=`cat $ALTFAILLIST | grep -c "$i"`
					if [ "$SCRIPTDEBUG" = "1" ]
				    then
			    			echo "Looking for $i in $ALTFAILLIST = $ERRLINES"
			        fi
					if test $ERRLINES != "0"
					then
		                let FAILCOMPATIBLE=FAILCOMPATIBLE+1
					    if [ "$VERBOSE" = "1" ]
					    then
							echo "Ignoring error - fails with $ALTCOMPILER too ($ALTFAILLIST)."
	                    fi
						return
					fi

                else
                    echo "File that should contain compatibility failed sources, "
                    echo "$ALTFAILLIST does not exist, but -compatfile was specified. STOP"
                    exit 19
                fi
            else
				if [ -d $FJSERRFILESDIR ]
		        then
				    #look at alternative compiler's dir for files that failed
					if [ "$VERBOSE" = "1" ]
				    then
						echo "Using previous $ALTCOMPILER run results in $FJSERRFILESDIR"
	                fi
					#this depends on amakeallo -4js or -q or -ifx executed previously:
					if [ -f $FJSERRFILESDIR/$i ]
			        then
		                let FAILCOMPATIBLE=FAILCOMPATIBLE+1
					    if [ "$VERBOSE" = "1" ]
					    then
							echo "Ignoring error - fails with $ALTCOMPILER too (previous)."
	                    fi
			            return
			        else
					    if [ "$VERBOSE" = "1" ]
					    then
							echo "NOT EXIST: $FJSERRFILESDIR/$i - so $ALTCOMPILER was OK."
	                    fi
					fi
		        else
			        #if ALTCOMPILER's dir don't exist, try to compile on the fly:
					#this would take a long time since it will try to compile again
			        #every file that fails:

					if [ "$VERBOSE" = "1" ]
				    then
						if [ "$ALTCOMPILER" = "4js" ]
	                    then
		                    echo "$FJSERRFILESDIR don't exist"
							echo "$FOURJSCMPLCMD $i:"
	                    fi
		            fi

					if [ "$ALTCOMPILER" = "4js" ]
	                then
						$FOURJSCMPLCMD $i
	                fi
			        RET=$?
					if test $RET != "0"
			        then
		                let FAILCOMPATIBLE=FAILCOMPATIBLE+1
					    if [ "$VERBOSE" = "1" ]
					    then
							echo "Ignoring error - fails with $ALTCOMPILER too (now)."
	                    fi
				        return
				    fi
				fi
			fi

			if [ "$VERBOSE" = "1" ]
		    then
        	    echo "It compiled OK with $ALTCOMPILER"
            fi

			if test $SCRIPTDEBUG = "1"
   			then
				echo "It compiled OK with $ALTCOMPILER" >> $ERRORLOG
            fi
		fi


        ######################################################
        #is this "does not exist in the database ()" error ?
        ######################################################

        if [ -f $ERR ]
        then

			ERRLINES=`cat $ERR | grep -c "does not exist in the database ()"`
			if [ "$SCRIPTDEBUG" = "1" ]
		    then
	    			echo "'does not exist in the database ()' found in $ERR = $ERRLINES"
	        fi
			if test $ERRLINES != "0"
			then
		        let FAILDEFLIKE=FAILDEFLIKE+1
			    if [ "$VERBOSE" = "1" ]
			    then
					echo "Ignoring error - fails DEFINE LIKE not in database."
	            fi
			    #FIXME: log filename to $DEFINELIKELIST
	            #FIXME: extract error lines to $DEFINELIKEERROR
				return
	        fi
        fi

        ##############################################################
        #It does not fail with other compiler, so we do have an error:
        ##############################################################

		WASERROR=1

		echo $PWD/$i >> $FAILLIST

		############
		copyerrfiles
		############

        ############
        analiseerror
        ############

		if test $STOPONERROR = "1"
	    then
			echo "Stop."
			exit 1
	    else
			return
		fi
	fi;

    #############################################################
	#No error code from compiler, but did we generate object file?
	#############################################################

	HAVEOBJECT=0

	if [ "$COMPILER" = "aubit" ]
	then
		if [ -f $AO ]
		then
			HAVEOBJECT=1
            if test "$MOVETOSTORE" = "1"
            then
				mv $AO $DESTDIR
            fi
        fi
    else
		if [ -f $X ]
		then
			HAVEOBJECT=1
            if test "$MOVETOSTORE" = "1"
            then
				mv $X $DESTDIR
            fi
        fi
    fi

	if test $HAVEOBJECT = "0"
    then

		WASERROR=1
		############
		copyerrfiles
		############

        ############
        analiseerror
        ############

		if test $STOPONERROR = "1"
	    then
			echo "Stop."
			exit 1
	    else
			let COMPFAIL=COMPFAIL+1
			return
		fi
	fi;

    ######################################################################
	#no error code, and object was created, but do we still have err file?
    ######################################################################
	if [ -f $ERR ]
	then
		#This is not really an error, it is warning from C compiler:
		#WASERROR=1
	    if [ "$VERBOSE" = "1" ]
    	then
			echo "Object was generated, but $ERR was generated too, and $FGLCOMPILER did not return error code."
            echo "This probably indicate C compiler warnings"
        fi
		echo "Object was generated, but $ERR was generated too, and $FGLCOMPILER did not return error code."  >> $ERRORLOG
		echo "########################################## ($RET) $PWD/$ERR :" >> $ERRORLOG
		#cat $ERR | grep -B $GOBACKLINES $GOAFTERLINES $ERRCHAR >> $ERRORLOG
	    #this usualy indicates warnings from C compiler, so we will probably not have
		#4gl error lines markers, so we better include complete error file here:
		#echo "#____________________ COMPLETE ERR FILE: _______________________" >> $ERRORLOG
		$HEAD $ERR >> $ERRORLOG
        echo "##########################################################" >> $ERRORLOG
		let CCOMPWARNING=CCOMPWARNING+1

		#this is not really an error:
		#if test $STOPONERROR = "1"
	    #then
		#	echo "Stop."
		#	exit 1
	    #else
		#	return
		#fi

        return

	fi;

    ########################################################
    #no error code, object created, not err file = all is OK
    ########################################################

    if [ "$VERBOSE" = "1" ]
    then
		echo "Compiled: $PWD/$i"
    fi
	let COMPSUCCESS=COMPSUCCESS+1

}   #compileit


##########################
function compglobals {
##########################

    DOINGGLOBALS=1
	WASERROR="0"
	ls *.4gl > /dev/null 2>&1
	RET=$?
	if test $RET != "0"
	then
	    echo "No .4gl files in current directory."
	else
		echo "Making GLOBALS only objects in $PWD"
		####################
		for i in *.4gl; do
		####################
		X=`basename $i .4gl`.$COMPEXT2;
		ERR=`basename $i .4gl`.err;
		CFILE=`basename $i .4gl`.c;
		FGL=`basename $i`

		    #echo $i
		    grep -i "end globals" $i > /dev/null

			RET=$?

			if test $RET != "0"
			then
		        #echo $i is NOT GLOBALS file...
		        continue
		    else
				#echo $i is GLOBALS file...
		        compileit
			fi


		#####
		done
		#####

		if test $WASERROR != "0"
		then
            GLOBERRORS="1"
			if test $STOPGLOBALSERROR = "1"
            then
				echo " "
				echo "Stop after compiling GLOBALS files, because one or more failed to compile"
				echo "See $ERRORLOG for summary of all errors generated"
				echo "All source files causing problems where copied to $ERRFILESDIR"
			    echo "Totals:"
				stats
			    echo " "
				exit 1
            else
				echo " "
                echo "Some errors compiling GLOBALS, but will continue..."
			    echo " "
			fi
		else
            GLOBERRORS="0"
			echo "Globals compiled OK, continuing..."
		fi
    fi
    DOINGGLOBALS=0
} #compglobals

###################
function runamake {
###################

                #allsinglelibs.mk is just a collector for all single
                #file compilations, when using prepmake:
                if [ "$i" = "allsinglelibs.mk" ]
                then
                    return
                fi

                #########################################################
				#set filename of resulting target:
                #########################################################
				#FIXME: it can also be dummy.ao (allsinglelibs.mk) !!!
				EXECFILE=`basename $i .mk`.4ae;
				EXECFILEAOX=`basename $i .mk`.aox;

                #########################################################
                #Clean targed and objects as configured:
                #########################################################
				if test "$FULLCLEAN" = "1"
                then
					amake $i clean
				fi

				if test "$TARGETCLEAN" = "1"
                then
					#pass -cleantarget to amake instead
					#if [ -f $EXECFILE ]
	                #then
					#	rm $EXECFILE
	                #fi
					#FIXME: need to code it!
					amake $i cleantarget
                fi


                #########################################################
				#if we allrealy have this one linked in storrage dir, skip it:
                #########################################################
				if test "$MAXMODE" = "1"
                then
					if [ -f "$MAXDIR/aprog/$EXECFILE" -o -f "$EXECFILEAOX" ]
	                then
						let COMPBEFORE=COMPBEFORE+1
						if test $VERBOSE = "1"
	                    then
							echo "$MAXDIR/aprog/$EXECFILE or $EXECFILEAOX exist, skip is ON"
	                    fi
	                    return
	                fi
                fi

                #########################################################
                #if we allrealy have this one linked in this dir, skip it:
                #########################################################
				if [ -f $EXECFILE ]
                then
					let COMPBEFORE=COMPBEFORE+1
					if test $VERBOSE = "1"
                    then
						echo "$EXECFILE exist, skip is ON"
                    fi
		            if test "$MOVETOSTORE" = "1"
        		    then
		                if test "$MAXMODE" = "1"
        		        then
							mv $EXECFILE $MAXDIR/aprog
                        fi
                    fi
					return
                fi

				let ATTEMPTED=ATTEMPTED+1

                #########################################################
				#run it
                #########################################################
				if test "$SCRIPTDEBUG" = "1"
			    then
                    echo "------------------- Running amake -verbose $i ----------------------"
                fi

				#amake -verbose $i >> $AMAKEERRORLOG 2>&1
                amake -verbose $i > $i.log 2> $i.make.log
				RET=$?

				if test $RET = "0"
				then
	                #########################################################
					#no error code returned by amake:
                    #########################################################

                    #########################################################
	                #did we create executable?
                    #########################################################
					if [ -f $EXECFILE ]
                    then
			            if test "$MOVETOSTORE" = "1"
            			then
			                if test "$MAXMODE" = "1"
            			    then
								mv $EXECFILE $MAXDIR/aprog
                            fi
                        fi
						if test $VERBOSE = "1"
            	        then
							echo "OK: $PWD/$i"
    	                fi
	   	                echo "OK: $PWD/$i" >> $AMAKEERRORLOG

						let AMAKEOK=AMAKEOK+1
                    else
						#########################################################
						#did we crate library?
                        #########################################################
						if [ -f $EXECFILEAOX ]
                        then
							let AMAKEOK=AMAKEOK+1
							if test $VERBOSE = "1"
            		        then
								echo "OK: $PWD/$i"
    		                fi
		   	                echo "OK: $PWD/$i" >> $AMAKEERRORLOG
						else
							if test $VERBOSE = "1"
            		        then
								echo "ERROR (?): $EXECFILE or $EXECFILEAOX not created"
                            fi
							echo "ERROR (?): $EXECFILE or $EXECFILEAOX not created"  >> $AMAKEERRORLOG
							#let AMAKEFAIL=AMAKEFAIL+1
                        fi
                    fi

                else
	                #########################################################
	                #if we got error code from amake:
                    #########################################################

					cat $i.make.log >> /tmp/allmakeerr.log

                    #########################################################
					#get name make failed on:
                    #########################################################
					PROBLEMFILE=$(cat $i.make.log | grep "make: ***" | awk '{print $3}')
					RET=$?

					if test $RET != "0"
					then
		                echo "error in PROBLEMFILE formula"
        		        exit 44
		            fi

					X=`echo $PROBLEMFILE | sed -e "/^\[/s/\[//"`
					PROBLEMFILE=`echo $X | sed -e "/./s/\]//"`
					if [ "$SCRIPTDEBUG" = "1" ]
				    then
						echo Problem file name was $PROBLEMFILE
                    fi

					#/usr/aubit/aubit4glsrc/bin/amakeallo: /usr/aubit/aubit4glsrc/bin/amake: Text file busy
                    if [ "$PROBLEMFILE" = "Text" ]
                    then
                        echo "BLAST!!!! amake: Text file busy"
                        exit 55
                    fi


					Y=`basename $PROBLEMFILE .ao`;
                    if [ "$PROBLEMFILE" != "$Y" ]
                    then
                        #we did have .ao, so we failed on 4gl compile
						if [ "$SCRIPTDEBUG" = "1" ]
					    then
							echo "Problem file was 4gl"
                        fi
						PROBLEMFILE=$Y.4gl;

                        #FIXME:
                        #we might as well ignore here, if we failed to compile
                        #single 4gl file, it's not amake issue?
                        #return

                    else
						#did we have .4ae extension?

						Y=`basename $PROBLEMFILE .4ae`;
	                    if [ "$PROBLEMFILE" != "$Y" ]
    	                then
                        	#we did have .4ae, so we failed on maikng executable.
							if [ "$SCRIPTDEBUG" = "1" ]
						    then
								echo "Problem file was exec"
                            fi
							PROBLEMFILE=$Y.exec;
                        else
							#did we have .aox extension?
							Y=`basename $PROBLEMFILE .aox`;
		                    if [ "$PROBLEMFILE" != "$Y" ]
                            then
	                        	#we did have .aox, so we failed on linking library.
								if [ "$SCRIPTDEBUG" = "1" ]
							    then
									echo "Problem file was lib"
                                fi
								PROBLEMFILE=$Y.lib;
                            else

#------------------- Running amake -verbose A1F.mk ----------------------
#1 No
#Failed on No, not .ao, .aox or .4ae ? STOP.
								
# amake -verbose A1F.mk
#Command is: make -f A1F.mk
#make: *** No rule to make target `pinqwind.aox', needed by `A1F.4ae'.  Stop.
#ERROR: amake failed.

#FIXME : add -quiet to prepmake

								echo "Failed on $PROBLEMFILE, not .ao, .aox or .4ae ? STOP."
    	                        exit 33
                            fi
                        fi
					fi

					if [ "$SCRIPTDEBUG" = "1" ]
				    then
						echo "PROBLEMFILE = $PROBLEMFILE"
						#PROBLEMFILE=serrwind.4gl
                    fi

                    #########################################################
                    #eliminate duplicates:
                    #########################################################
                    if [ -f $LINKFAILLIST ]
                    then
						ERRLINES=`cat $LINKFAILLIST | grep -c "$PROBLEMFILE"`
						if [ "$SCRIPTDEBUG" = "1" ]
					    then
				    			echo "Looking for $PROBLEMFILE in $LINKFAILLIST = $ERRLINES"
				        fi
						if test $ERRLINES != "0"
						then
							if [ "$VERBOSE" = "1" ]
						    then
								echo "Ignoring error - duplicate."
		                    fi
							let DUPLICATE=DUPLICATE+1
                            return
                        fi
                    fi

					#########################################################
	                #look at FAILLIST for files that failed to compile to objects with same compiler:
                    #########################################################
                    if [ -f "$FAILLIST" ]
	                then
							ERRLINES=`cat $FAILLIST | grep -c "$PROBLEMFILE"`
							if [ "$SCRIPTDEBUG" = "1" ]
						    then
					    			echo "Looking for $PROBLEMFILE in $FAILLIST = $ERRLINES"
					        fi
							if test $ERRLINES != "0"
							then
				                let FAILANYWAY=FAILANYWAY+1
								#echo "Ignoring error - $PROBLEMFILE fails ($FAILLIST)." >> $AMAKEERRORLOG
								if [ "$VERBOSE" = "1" ]
							    then
									echo "Ignoring error - $PROBLEMFILE fails ($FAILLIST)."
			                    fi
								return
							fi
		            else
		                    echo "File that should contain failed sources, "
		                    echo "$FAILLIST does not exist. STOP"
		                    exit 19
	                fi

                    #########################################################
                    #if -compatfile was specified, look if we failed on file failed with alt compiler:
                    #########################################################
					if test "$USECOMPATFILE" = "1"
		            then
						if [ -f "$ALTFAILLIST" ]
		                then
							ERRLINES=`cat $ALTFAILLIST | grep -c "$PROBLEMFILE"`
							if [ "$SCRIPTDEBUG" = "1" ]
						    then
					    			echo "Looking for $PROBLEMFILE in $ALTFAILLIST = $ERRLINES"
					        fi
							if test $ERRLINES != "0"
							then
				                let FAILCOMPATIBLE=FAILCOMPATIBLE+1
								#echo "Ignoring error - $PROBLEMFILE fails (ALT$FAILLIST)." >> $AMAKEERRORLOG
								if [ "$VERBOSE" = "1" ]
							    then
									echo "Ignoring error - $PROBLEMFILE fails ($ALTFAILLIST)."
			                    fi
								return
							fi
		                else
		                    echo "File that should contain compatibility failed sources, "
		                    echo "$ALTFAILLIST does not exist, but -compatfile was specified. STOP"
		                    exit 19
		                fi
		            fi


                    #########################################################
                    #Is this "DEFINE ... LIKE not in database" error?
                    #########################################################
					ERRLINES=`cat $i.log | grep -c "does not exist in the database ()"`
					if [ "$SCRIPTDEBUG" = "1" ]
				    then
			    			echo "'does not exist in the database ()' found in $i.log = $ERRLINES"
			        fi
					if test $ERRLINES != "0"
					then
				        let FAILDEFLIKE=FAILDEFLIKE+1
					    if [ "$VERBOSE" = "1" ]
					    then
							echo "Ignoring error - fails DEFINE LIKE not in database."
			            fi
						#echo "Ignoring error - fails DEFINE LIKE not in database." >> $AMAKEERRORLOG
						return
			        fi

                    #########################################################
                    #can we link with alt compiler?
                    #########################################################
                    #if -compatfile was specified

					if test "$USECOMPATFILE" = "1"
		            then
						#amake -verbose $i d4gl-pcode > $i.alt.log 2> $i.make.alt.log
                        amake -verbose $i d4gl-pcode > $i.alt.log 2>&1
						RET=$?

						if test $RET != "0"
						then
			                let FAILCOMPATIBLE=FAILCOMPATIBLE+1
							if [ "$VERBOSE" = "1" ]
						    then
								echo "Ignoring error - $i fails to link with alt compiler too."
		                    fi
							if [ "$SCRIPTDEBUG" = "1" ]
						    then
								echo "Ignoring error - $i fails to link with alt compiler too:" >> $AMAKEERRORLOG
			                    echo $i >> $ALTLINKFAILLIST
								echo "################################################# $PWD/$i" >> $AMAKEERRORLOG 2>&1
	                            cat $i.alt.log >> $AMAKEERRORLOG
								echo "#########################################################" >> $AMAKEERRORLOG 2>&1
                            fi
        					return
                        else
							if [ "$VERBOSE" = "1" ]
						    then
								echo "Links OK with alt compiler: $i."
		                    fi
							echo "Links OK with alt compiler: $i." >> $AMAKEERRORLOG
						fi
					fi

                    #########################################################
                    #Remaining should be linking errors only:
                    #########################################################
                    echo $PROBLEMFILE >> $LINKFAILLIST
					echo "################################################# $PWD/$i" >> $AMAKEERRORLOG 2>&1
					cat $i.log >> $AMAKEERRORLOG
					echo "----Make say it failed on:----" >> $AMAKEERRORLOG
					cat $i.make.log >> $AMAKEERRORLOG
					echo "------------------------------" >> $AMAKEERRORLOG

					let AMAKEFAIL=AMAKEFAIL+1
					if test $VERBOSE = "1"
                    then
						echo "FAILED: $PWD/$i"
                    fi
                    echo "FAILED: $PWD/$i" >> $AMAKEERRORLOG
                fi
				echo "#########################################################" >> $AMAKEERRORLOG 2>&1

}


###########################
function makecurrentdir {
###########################


	if test "$AMAKE" = "1"
    then
		#try to link into programs:

		ls *.mk > /dev/null 2>&1
		RET=$?
		if test $RET = "0"
		then
			if test "$CLEANMK" = "1"
            then
				echo "deleting all .mk files in $PWD ..."
				rm *.mk
            fi
        fi

		ls *.mk > /dev/null 2>&1
		RET=$?
		if test $RET != "0"
		then
		    echo "No .mk files in current directory, trying to make them..."
            echo "###################### running prepmake in $PWD ##################" >> $AMAKEERRORLOG
			prepmake -clean -verbose >> $AMAKEERRORLOG 2>&1
			RET=$?
			echo "########################################################################" >> $AMAKEERRORLOG
			if test $RET != "0"
			then
				if test $RET = "126"
				then
                    echo "Text file busy =  Error 126"
					echo "Text file busy =  Error 126" >> $AMAKEERRORLOG
                    exit 11
                    #return
                else
					echo "prepmake failed ($RET)"
					echo "prepmake failed ($RET)"  >> $AMAKEERRORLOG
                    #exit 12
        	        return
                fi
            fi
        fi

		ls *.mk > /dev/null 2>&1
		RET=$?
		if test $RET != "0"
		then
		    echo "No .mk files in current directory."
		else
	        echo "Running all .mk makefiles in $PWD"

			####################
			for i in *.mk; do
			####################

				##########
				shortstats
                ##########

                ########
                runamake
                ########

			#####
			done
			#####

	    fi

    ####
	else
    ####
        #just compile 4gl files to objects:
		#####
		clean
		#####

		if [ "$COMPILER" = "aubit" ]
		then
			#Aubit needs GLOBALS files compiled first:
			GLOBERRORS=0
			###########
			compglobals
			###########
          	#Aubit NEEDS glb files, and we cannot assume we have
            #them if we had errors when compiling GLOBALS files:

            #FIXME: is this returned correctly?
			if [ "$GLOBERRORS" = "0" ]
	        then
			       ####
			       doit
			       ####
            else
				if test $NONGLOBAFTERGLOBERR = "1"
				then
			        echo "-nonglob is ON, will try to compile non-globals anyway."
					####
			        doit
			        ####
                else
	                echo "Skipping non-GLOBALS files in $subsystem"
                fi
			fi
        else
			####
			doit
			####
        fi
    fi


}


################
function doit {
################

	ls *.4gl > /dev/null 2>&1
	RET=$?
	if test $RET != "0"
	then
	    echo "No .4gl files in current directory."
	else
        echo "Making all 4gl objects in $PWD"

		####################
		for i in *.4gl; do
		####################

		    #########
			compileit
            #########

		#####
		done
		#####

    fi

} #doit


############
#MAIN
############

	#####################################################
	#configuration defaults:
    #####################################################

    #------------ names: -------------------------

	#main compiler:
	COMPILER=aubit
    #compiler used for compatibility fail check:
	ALTCOMPILER=4js

	#-------- files and directories: ------------

	#where to store results of testing - generic name:
	ERRFILESDIR=/tmp/amakeallo
	#where to store results of testing - compiler specific:
	FJSERRFILESDIR=$ERRFILESDIR-4js
	AUBITERRFILESDIR=$ERRFILESDIR-aubit
	QERRFILESDIR=$ERRFILESDIR-querix
	IFXERRFILESDIR=$ERRFILESDIR-informix

    #where to move compiled objects:
	DESTDIR=/tmp/amakeallo-objects
	ROOTDIR=$PWD
	#sub-directories to skip
	SKIPDIRS=

    #------------ commands: ----------------------

	AUBITCMPLCMD="4glpc -noerrcode" #-verbose -debug
    FOURJSCMPLCMD=fglcomp
    QUERIXCMPLCMD=fglc
	ICOMPILER=fglpc
    HEAD=head
    #HEAD=head -n 20


	#------------ numeric variables: ------------

	SKIP=1
	STOPONERROR=0
	STOPGLOBALSERROR=0
    NONGLOBAFTERGLOBERR=0
	RECURSIVE=0
	GOBACKLINES=20
	GOAFTERLINES=10
    FULLCLEAN=0
	TARGETCLEAN=0
	COMPATIBLE=0
	USECOMPATFILE=0
    VERBOSE=0
    SCRIPTDEBUG=0
	MAXMODE=0
	MAXMODE2=0
	TESTCONTINUE=0
	AMAKE=0
	MOVETOSTORE=1


    #------------- strings: ------------------

	ERRCHAR=^\|


	########################
	#initialise counterts:
    ########################s
	WASERROR=0
	COMPSUCCESS=0
	COMPFAIL4GL=0
	COMPBEFORE=0
	COMPFAILCCOMP=0
	COMPFAILCORE=0
	COMPFAILUNKNOWN=0
    FAILCOMPATIBLE=0
	TOTALFAILED=0
    CCOMPWARNING=0
    NOGLBFILE=0
    OKNOGLBFILE=0
    NO4GLNOGLBFILE=0
	ZEROFILESIZE=0
	TESTCONTINUESKIP=0
    FAILDEFLIKE=0
    AMAKEOK=0
    AMAKEFAIL=0
	ATTEMPTED=0
	ATTEMPTEDGLOBALS=0
	FAILANYWAY=0
	DUPLICATE=0

    #################################
	#read options from command line:
    #################################

	############
	for a in $@
	############
	do
	   ##########
	   case $a in
	   ##########

       -cmp)     	#amakeallo -r -compatfile -maxmodeminimal -nonglob
		            RECURSIVE=1
					COMPATIBLE=1
					USECOMPATFILE=1
	                MAXMODE=1
					MAXMODE2=1
					NONGLOBAFTERGLOBERR=1

					VERBOSE=1
                    SCRIPTDEBUG=1

	   ;;


       -link)
					#amakeallo -r -compatfile -maxmodeminimal -amake
		            RECURSIVE=1
					COMPATIBLE=1
					USECOMPATFILE=1
	                MAXMODE=1
					MAXMODE2=1
					AMAKE=1

					#TARGETCLEAN=1
					FULLCLEAN=1
					CLEANMK=1
					VERBOSE=1
                    SCRIPTDEBUG=1

	   ;;

	   -x)
	        for file in *.ae; do
	            AONAME=`basename $file .ae`.ao;
				echo moving $file to $AONAME
				mv $file $AONAME
	        done
	        echo Finished renaming.
	        exit 0
		;;

	    -r) 		RECURSIVE=1
        ;;

		-4js)		COMPILER=4js
        ;;

		-q)			COMPILER=querix
        ;;

		-ifx)		COMPILER=informix
        ;;

		-altq)		ALTCOMPILER=querix
        ;;

		-altifx)	ALTCOMPILER=informix
        ;;

		-stoperr)	STOPONERROR=1
        ;;

        -stopglob) 	STOPGLOBALSERROR=1
        ;;

        -nonglob)   NONGLOBAFTERGLOBERR=1
        ;;

        -nomove) 	MOVETOSTORE=0
        ;;

		-noskip) 	SKIP=0
        ;;

        -fullclean) FULLCLEAN=1
        ;;

        -cleanmk) 	CLEANMK=1
        ;;

        -compat) 	COMPATIBLE=1
        ;;

        -compatfile)
					COMPATIBLE=1
					USECOMPATFILE=1
        ;;

        -continue)  TESTCONTINUE=1
        ;;

        -maxmode)   MAXMODE=1
		;;

        -amake) 	AMAKE=1
        ;;

        -maxmodeminimal)

	                MAXMODE=1
					MAXMODE2=1
        ;;

        -v)			VERBOSE=1
        ;;

        -verbose)	VERBOSE=1
        ;;


        -debug)		VERBOSE=1
                    SCRIPTDEBUG=1
		;;


		-help)

            echo "Aubit 4gl compiler object compile utillity: amakeallo"
            echo " compiles all 4gl files to objects or all .mk to programs"
            echo
			echo "Options: [defaults are in ()]"
			echo " -r = recursive: step into subdirectories too (. only)"
			echo " -4js = use 4Js/D4GL compiler (Aubit)"
			echo " -q = use Querix compiler (Aubit)"
			echo " -ifx = use Informix compiler (Aubit)"
			echo " -altq = use Querix as alternative compiler (4Js)"
			echo " -altifx = use Informix as alternative compiler (4Js)"
			echo " -stoperr = stop on any error (continue)"
			echo " -stopglob = stop if any GLOBALS 4gl file fails (continue)"
            echo " -nonglob = continue compiling non-global files even if globals fail (skip)"
			echo " -noskip = do not skip already compiled (skip)"
			echo " -x = rename Aubit old extensions in "." [.o->.ao]"
			echo " -fullclean = remove .c .h .ec before you start (DANGER!)"
			echo " -compat = ignore errors if they fail in $ALTCOMPILER too (do not ignore)"
			echo " -compatfile = as -compat, but read failed from $ALTFAILLIST file"
			echo " -maxmode[minimal] = special mode for Maximise app (universal mode)"
			echo " -v = verbose - show what you are doing (show only counters)"
			echo " -debug = verbose + much more"
			echo " -continue - contine previous run, don't retry already failed"
			echo " -amake = run amake on all .mk files {compile .4gl to objects)"
            echo " -cleanmk = clean .mk files when running with -amake (use existing .mk)"
			echo " -nomove = don't move resulting objects/execs (move to OBJSTORE)"
			echo " -help = this help"
            echo
            exit 0
        ;;

        *)
            echo "Unknown parametar: $a : try '-help'. STOP."
            exit 1
        ;;

	  ####
	  esac
	  ####
	####
	done
	####


    #################################################
    #set options that depend on command line options:
    #################################################

	if test "$MAXMODE" = "1"
    then
		if [ "$MAXDIR" = "" ]
        then
            echo "MAXDIR not set, but -maxmode specified. Please export MAXDIR to"
            echo "point to Maximise sources root directory. STOP."
            exit 17
        else
            export SCWORK=$MAXDIR
		fi
    fi

	if [ "$COMPILER" = "aubit" ]
	then
		ERRFILESDIR=$AUBITERRFILESDIR
		FGLCOMPILER=$AUBITCMPLCMD
		COMPEXT=o
		COMPEXT2=ao

		if [ -f $AUBITDIR/aubitenv ]
		then
			. $AUBITDIR/aubitenv
		fi

		if [ -f /etc/aubitenv ]
		then
			. /etc/aubitenv
		fi

		if test $MAXMODE = "1"
        then
			if [ -d $MAXDIR/aprog ]
	        then
				DESTDIR=$MAXDIR/aprog
            fi
        fi

	fi

	if [ "$COMPILER" = "4js" ]
	then
		ERRFILESDIR=$FJSERRFILESDIR
		FGLCOMPILER=$FOURJSCMPLCMD
		COMPEXT=42m
		COMPEXT2=

		if test $MAXMODE = "1"
        then
			if [ -d $MAXDIR/gprog ]
	        then
				DESTDIR=$MAXDIR/gprog
            fi
        fi
	fi

	FAILLIST=/tmp/amake-compatfail-$COMPILER
	ALTFAILLIST=/tmp/amake-compatfail-$ALTCOMPILER
	LINKFAILLIST=/tmp/amake-linkfail-$COMPILER
	ALTLINKFAILLIST=/tmp/amake-linkfail-$ALTCOMPILER

	if [ "$ALTCOMPILER" = "4js" ]
    then
		ALTERRFILESDIR=$FJSERRFILESDIR
    fi

    if [ "$ALTCOMPILER" = "querix" ]
    then
		ALTERRFILESDIR=$QERRFILESDIR
    fi

    if [ "$ALTCOMPILER" = "informix" ]
    then
		ALTERRFILESDIR=$IFXERRFILESDIR
    fi



   	ERRORLOG=$ERRFILESDIR/amakeallo.log
	AMAKEERRORLOG=$ERRFILESDIR/amakeall.log
    ZEROLOG=$ERRFILESDIR/zero_size.log
    CLOG=$ERRFILESDIR/c_err.log
    FGLLOG=$ERRFILESDIR/4gl_err.log
	CORELOG=$ERRFILESDIR/core_err.log
    GLOBLOG=$ERRFILESDIR/glob_err.log

	if test $VERBOSE = "0"
	then
		echo "NOTE: using $DESTDIR for objects store"
    fi

    
    ######################################
	#drop and recreate storrage directory:
    ######################################
	if [ -d $ERRFILESDIR ]
	then
	    if [ "$TESTCONTINUE" = "0" ]
        then
			if test $AMAKE = "0"
		    then
				rm -rf $ERRFILESDIR
            fi
        fi
	fi

	if ! [ -d $ERRFILESDIR ]
	then
		mkdir $ERRFILESDIR
    fi

    if ! [ -d $DESTDIR ]
    then
	    mkdir $DESTDIR
    fi

    date

    ######################
    #Initialise log files:
    ######################

	if test "$AMAKE" = "1"
    then
	    date > $AMAKEERRORLOG
		echo "Invoked with: $@" >> $AMAKEERRORLOG
	    echo "Invoked in $PWD" >> $AMAKEERRORLOG
		echo "-----------------------------------------------------" >> $AMAKEERRORLOG
        date > $LINKFAILLIST
        #NOT!:
		#date > $ALTLINKFAILLIST
		date > /tmp/allmakeerr.log
	else
	    date > $ERRORLOG
		echo "Invoked with: $@" >> $ERRORLOG
	    echo "Invoked in $PWD" >> $ERRORLOG
		echo "-----------------------------------------------------" >> $ERRORLOG

		date > $ZEROLOG
		date > $FGLLOG
		date > $CLOG
	    date > $CORELOG
	    date > $GLOBLOG
		date > $FAILLIST
	fi

    #################
    #start compiling:
    #################

    subsystem=$PWD

	##############
    makecurrentdir
    ##############


	if test $RECURSIVE = "1"
	then
		if test $MAXMODE = "1"
        then
			#In Maximise, order of compilation is important, and we also
            #need to skip some directories
			if test "$MAXMODE2" = "1"
            then
				ALLSUBDIRS="winds main ar gl ap"
            else
				ALLSUBDIRS="winds csimods main ar eo fa gl in jm lc qe re ss ap pu wo cm contr dvfund lawmods"
                #FIXME: add gw mn
            fi

            SKIPDIRS="aform aprog forms prog gform gprog qform qprog"
        else
			ALLSUBDIRS=`ls -l | "^d" | awk '{print $NF}'`
        fi

		################################
        for subsystem in $ALLSUBDIRS; do
		################################

                if [ "$subsystem" = "$DESTDIR" ]
				then
					continue
                fi

                #FIXME: this is not working - we need to be able to skip
                #defined directories:
				#if [ "$subsystem" in $SKIPDIRS ]
                #then
                #    continue
                #fi


			   if [ -d $ROOTDIR/$subsystem ]
	           then
				   	if test "$AMAKE" = "1"
                    then
                        echo Making programs in $subsystem...
                    else
						echo Making 4gl objects in $subsystem...
                    fi
				   	cd $ROOTDIR/$subsystem ;

                   	if [ "$subsystem" = "cm" ]  && [ test $MAXMODE = "1" ]
                   	then
					   cd source
                   	fi

                    ##############
                    makecurrentdir
                    ##############

			   fi

            #FIXME: step x levels into subdirectories too

		####
		done
	    ####

    fi

    #####
    stats
    #####

	echo "Finished."

    if [ "$TOTALFAILED" != "0" ]
    then
		echo "See $ERRORLOG for summary of all errors generated"
		echo "All source files causing problems where copied to $ERRFILESDIR"
        exit 1
	else
		exit 0
    fi

#---------------------------------- EOF ---------------------------------
