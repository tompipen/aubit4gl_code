#!/bin/bash
# --norc --noprofile
#There are several problems with SH on CygWin - not sure how to do this to be compatible
#with users that don't have bash on there *NIX platforms ....?
#!/bin/sh
# +----------------------------------------------------------------------+
# | Aubit 4gl Language Compiler Version $.0                              |
# +----------------------------------------------------------------------+
# | Copyright (c) 2000-1 Aubit Development Team (See Credits file)       |
# +----------------------------------------------------------------------+
# | This program is free software; you can redistribute it and/or modify |
# | it under the terms of one of the following licenses:                 |
# |                                                                      |
# |  A) the GNU General Public License as published by the Free Software |
# |     Foundation; either version 2 of the License, or (at your option) |
# |     any later version.                                               |
# |                                                                      |
# |  B) the Aubit License as published by the Aubit Development Team and |
# |     included in the distribution in the file: LICENSE                |
# |                                                                      |
# | This program is distributed in the hope that it will be useful,      |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of       |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        |
# | GNU General Public License for more details.                         |
# |                                                                      |
# | You should have received a copy of both licenses referred to here.   |
# | If you did not, or have any questions about Aubit licensing, please  |
# | contact afalout@ihug.co.nz                                           |
# +----------------------------------------------------------------------+

#
# $Id: 4glpc,v 1.125 2004-03-22 00:15:53 afalout Exp $
#

########################################################################
#this is main Aubit 4gl compiler .4gl files compiler script
#It is recomended in most situations to use 4glc directly - this scrip
#will be obsoleted in the near future.
########################################################################


if [ "$1" = "-dirdiff" ]
then
	#Find files that exist in a tree but not in another tree
	#to find files we missed in 'make clean.all'
	echo "comparing $2 <=> $3"
	cd $2
	#DIRTYLIST=`find`
	#find . -name "*~" -exec echo "\"{}\"" \;
	#DIRTYLIST=`find . -exec echo "\"{}\"" \;`
	
	
	#find . \( -path *tools/cygwin -o -path *crap \) -prune 
	#find /usr/wpas/ \( -path *source -o -path *procs -o -path *\&* -o -path *.L
	#-o -path *BP.O -o -path *SUBS.O -o -path *REPORT \) -prune -or -type d \(
	#-name BP* -o -name *BP -o -name *PROG* -o -name *FUNC* -o -name *SUBS* -o
	#-name *FMCS* -o -name INC* -o -name *INC -o -name PROMPTS* \) -print | tee
	#/usr/wpas/source.dirs	
	
	#DIRTYLIST=`find . -exec echo "'{}'" \;`	
	
	#must ingnore tools/cygwin, since it contains files with spaces in filename
	DIRTYLIST=`find . \( -path \*cygwin\* -o -path \*crap \) -prune -or -name "*"`
	
	cd -
	
	for file in $DIRTYLIST
	do
		LOOKFOR=$3/$file
		#echo $LOOKFOR
		if [ ! -f $LOOKFOR ]
		then
			if [ ! -d $LOOKFOR ]
			then
				#File exists in $2 but not in $3
				#echo "$LOOKFOR"
				echo $file
				#exit
			fi
		fi
	
	done

	
	exit
fi

#Find out if we are using MinGW C compiler (If on Windows)
if [ "$COMSPEC" != "" ]; then
    #TMP=`type gcc | grep -i mingw`
	TMP=`gcc -v 2>&1 | grep -i mingw`

    if [ "$TMP" != "" ]; then
        MINGW=1
        CYG_ROOT="D:/cygwin"
    fi
fi

    ERRCHAR=^\|
	GOBACKLINES=10
	GOAFTERLINES=2
    HEAD=head
    #HEAD=head -n 20
    SHOWERRCODE=1
    FGLCEXEC=4glc
	OVERWRITE_CONFIG=0
#	USE_CONFIGURE=1
	USE_SHARED="Yes"
    TIME_IT=0
	TIME=time


#A4GLVERBOSE="yes"
#A4GLDEBUG="yes"
if [ "$A4GLDEBUG" = "yes" ]
then
	echo "A4GLDEBUG is on - debugging 4glpc script:"
	A4GLVERBOSE="yes"
fi

aubit-config -ae > /tmp/$$.env

NO_COMPILE=0

#############
#this internal variable points to default location of Aubit config files
#Default=/etc/opt/aubit4gl
AUBITETC=/etc/opt/aubit4gl

#FIXME:
#uppercase 0, passed to 4glpc as "4gpc -O ..." is causing on CygWin:
#[: --help: unknown operand
#[: --help-options: unknown operand
#...etc...
#...but NOT on UNIX: Why?????

if [ $# -lt 1 -o "$1" = "--help" ]
then
    echo
	echo Aubit 4gl main compiler script: $0
    echo
    echo Usage:
    echo '  4glpc sourcefile.type [...] [options] executablename.4ae'
    echo '  4glpc sourcefile.4gl -c -o objectname.ao'
    echo '  4glpc sourcefile.4gl -o executablename.4ae'
	echo
    echo ' For details, try: '
    echo ' 4glpc --help-options	- for command line options'
    echo ' 4glpc --help-env	- for environment variables recognised'
	echo ' 4glpc --help-types	- for file types'
    echo ' 4glpc --help-examples	- for examples'
    echo
	if [ "$A4GLVERBOSE" = "yes" ]
	then
        echo "Exiting with code 6"
    fi
	exit 6
fi

if [ $# -lt 1 -o "$1" = "--help-options" ]
then
    echo
	echo Aubit 4gl main compiler script: $0
    echo
	echo Options:
    echo '  -o'
    echo '  -c : falg to C compiler'
	echo '  -shared/static ($USE_SHARED=Yes/no) compile with shared libraries'
    echo '  -echo  ($DOIT=echo) display CC command only, do not execute'
    echo '              this inhibits C compiler only, not the 4gl compiler'
    echo '  -debug  ($INCLLINES=Yes) include extra debuging code'
    echo '  -map/nomap ($MAP4GL=Yes) generate additional map file code'
    echo '  -maponly'
    echo '  -verbose ($A4GLVERBOSE=yes) show additional info while compiling'
    echo '  -noerrcode () do not show eeror code on compile errors'
    echo '  -as-ddl'
    echo '  -i ignore errors and continue'
	echo '  -jabber link executable with Jabber libraries'
	echo
    echo All options unknown to Aubit compiler will be passed to C compiler
    echo Please see Aubit 4gl manual for more information.
    echo
	if [ "$A4GLVERBOSE" = "yes" ]
	then
        echo "Exiting with code 6"
    fi
	exit 6
fi

if [ $# -lt 1 -o "$1" = "--help-env" ]
then
#FIXME: find and list all env var's recognised
	echo
	echo Aubit 4gl main compiler script: $0
    echo
	echo Environment variables recognised:
    echo
	echo '  -shared/static ($USE_SHARED=Yes/no) compile with shared libraries'
    echo '  -echo  ($DOIT=echo) display CC command only, do not execute'
    echo '              this inhibits C compiler only, not the 4gl compiler'
    echo '  -debug  ($INCLLINES=Yes) include extra debuging code'
    echo '  -map/nomap ($MAP4GL=Yes) generate additional map file code'
    echo '  -maponly'
    echo '  -verbose ($A4GLVERBOSE=yes) show additional info while compiling'
    echo '  -as-ddl'
    echo '  $A4GLRC - full path to file to be used instead of .a4glrc'
	echo
    echo 'Note: $FGLCEXEC, cc and other compilers invoked by this script will'
    echo '      recognise additional variables that might affect this script'
    echo
	if [ "$A4GLVERBOSE" = "yes" ]
	then
        echo "Exiting with code 6"
    fi
	exit 6
fi


if [ $# -lt 1 -o "$1" = "--help-types" ]
then
    echo
	echo Aubit 4gl main compiler script: $0
    echo
	echo File types:
    echo '	4gl - 4gl source file, compiled to .c and then to .o'
    echo '	per - 4gl form file, compiled to .c and then to .o'
    echo '	msg - 4gl message file, compiled to .iem'
#FIXME: describe this:
	echo '	a   -'
    echo '	o   -'
    echo '	c   -'
    echo '	menu - Aubit 4gl GUI menu source, compiled to'
    echo
	if [ "$A4GLVERBOSE" = "yes" ]
	then
        echo "Exiting with code 6"
    fi
	exit 6
fi

if [ $# -lt 1 -o "$1" = "--help-examples" ]
then
#FIXME: describe this:
	echo Examples:
    echo
	echo '  4glpc sourcefile.4gl -o executablename.4ge'
	echo '  4glpc sourcefile.4gl -c -o objectname.o'
	echo '  4glpc -shared file.4gl -o file.4ge'
    echo '  4glpc -static -echo file.4gl -o file.4ge'
    echo '  4glpc -debug file.4gl -o file.debug'
    echo '  4glpc -map -echo file.4gl'
    echo
	if [ "$A4GLVERBOSE" = "yes" ]
	then
        echo "Exiting with code 6"
    fi
	exit 6
fi

######################
function run_next {
######################
#get next parameter from command line, and run specified command on it:

		let nextparam=counter+1
		#echo $nextparam
		counter2=0
		#echo $@
		#echo $ALLPARAMS
		for params in $ALLPARAMS #$@
		do
		   	let counter2=counter2+1
			#echo 1 $counter2 2 $nextparam
           	if test "$counter2" = "$nextparam"
            then
                filename=$params
                #echo "Manifest for filename $filename :"
                echo "Running: $DO_AND_EXIT $filename"
                $DO_AND_EXIT $filename
                exit
			fi
        done

        echo "Error: nothing specified after switch"
        exit 2

}


############################
function testswitchfunc {
############################
	ISSWITCH=0

	############
	for a in $@
	############
	do
	   ##########
	   case $a in
	   ##########

	   $TESTSWITCH)     ISSWITCH=1
	   ;;

	  ####
	  esac
	  ####
	####
	done
	####

}


########################
function showerror {
########################

    if [ -f $errfname ]
    then
		if test $SHOWERRCODE = "1"
		then
			ERRLINES=`cat $errfname | grep -c $ERRCHAR`
		    if [ "$ERRLINES" != "0" ]
		    then
				echo "============ FIRST ERROR: =============="
				cat $errfname | grep -B $GOBACKLINES -A $GOAFTERLINES $ERRCHAR
		    else
				echo "============ FIRST ERROR: =============="
				$HEAD $errfname
		    fi
		    echo "========================================"
		fi
	    echo "See file $errfname"
    fi

}


ALLPARAMS=$@

# This needs checking
if [ -f ${AUBITETC}/aubitrc ]
then
	A1=${AUBITETC}/aubitrc
	. ${AUBITETC}/aubitrc
fi

#echo 1 AUBITDIR=$AUBITDIR
#echo $A4GL_LEXTYPE

#we no longer export all variables, so this is obsolete?:
if [ "$MAKINGAUBIT" = "1" ] #if we are invoked from Aubit compiler makefiles
then
	if [ "$AUBIT_BIN_INSTALL" != "1" ] && [ "$AUBIT_SRC_ROOT" != "" ] #and we are still in Aubit source code tree
    then
		AUBITDIR=$AUBIT_SRC_ROOT
    fi
fi
#echo 2AUBITDIR=$AUBITDIR
    #find path to this script:
	PATHTO4GLPC1=`dirname $0`
	PATHTO4GLPC=`dirname $PATHTO4GLPC1` #remove bin/
    #OLD_DIR=`pwd`
	cd $PATHTO4GLPC
    CURRDIR=`pwd`
	cd -


if [ "$AUBITDIR" = "" ]
then
	#if still emty, assume this script is in $AUBITDIR/bin
	export AUBITDIR=$CURRDIR

	if [ -f $AUBITDIR/bin/4glpc ]
    then
		echo "AUBITDIR now set to $AUBITDIR"
        #cd $OLD_DIR
    else
        echo "Error: cannot set AUBITDIR: $AUBITDIR"
		echo PATHTO4GLPC1=$PATHTO4GLPC1
		echo PATHTO4GLPC=$PATHTO4GLPC
    	echo OLD_DIR=$OLD_DIR
		exit 13
    fi
fi


if [ "$AUBITDIR" != "" ]
then
	if [ -f $AUBITDIR/etc/aubitrc ]
	then
		A2=$AUBITDIR/etc/aubitrc
		. $AUBITDIR/etc/aubitrc
	fi
fi
if [ -f ~/.aubit4gl/aubitrc ]
then
	A5=~/.aubit4gl/aubitrc
	. ~/.aubit4gl/aubitrc
fi
#echo 3AUBITDIR=$AUBITDIR
if [ -f ./.aubitrc ]
then
	A6=./.aubitrc
	. ./.aubitrc
fi

if [ -f "$A4GL_INIFILE" ] && [ "$A4GL_INIFILE" != "" ]
then
	A7=$A4GL_INIFILE
	. $A4GL_INIFILE
fi


. /tmp/$$.env
rm /tmp/$$.env

#we no longer export all variables, so this is obsolete?:
if [ "$MAKINGAUBIT" = "1" ]
then
	#if we are invoked from Aubit compiler makefiles
	if [ "$AUBIT_BIN_INSTALL" != "1" ] && [ "$AUBIT_SRC_ROOT" != "" ]
    then
		#and we are still in Aubit source code tree
		#AUBITDIR=$AUBIT_SRC_ROOT
		if test "$COMSPEC" != ""; then
			#For MinGW, without drive letter:
			PATH=$PATH:$AUBIT_SRC_ROOT/bin
        fi
    fi
fi

PATH=$AUBITDIR/bin:$PATH

if [ "$COMPCC_OPTIONS" != "" ]
then
	COMPCC="$COMPCC_OPTIONS"
else
	COMPCC=""
fi

#old_incl is obsolete:
#if [ "$OLD_INCL" != "0" ] #OLD_INCL is set in Makefile-common
#then
#	#if we did not EXPLICITLY turn on new includes, we have to set
#    #old ones as default
#	CFLAGS="-DOLD_INCL $CFLAGS"
#fi

if [ "$AUBITDIR_SRC" = "1" ] #set from Makefile-common
then
	CFLAGS="-DSRC_TREE $CFLAGS"
fi

JABBER_LIB_DIR=$AUBITDIR/tools/jabber
JABBER_LIB_NAME=jabber

FGLLIBSDIR="-L$AUBITDIR/lib"

if [ "$CURRDIR" != "$AUBITDIR" ]; then
	FGLLIBSDIR="$FGLLIBSDIR -L$CURRDIR/lib"
fi

if [ "$MINGW" = "1" ]; then
	FGLLIBSDIR="$FGLLIBSDIR -L$CYG_ROOT$AUBITDIR/lib"
fi



if [ "$COMPILE_QUIET" != "" ]
then
        output=": "
else
        output="echo"
fi

#echo 4AUBITDIR=$AUBITDIR

#restore things from before reading .a4glrc that where in environment:
#see if we are called form Aubit compiler makefiles:
TESTSWITCH=-make-compile
testswitchfunc
if test "$ISSWITCH" = "1"
then
	export MAKE4GLPC="Yes"
fi

LAST=""
#GTK_INC_PATH is set in aubitrc
INCLDIR="-I$AUBITDIR/incl $GTK_INC_PATH"

if [ "$MINGW" = "1" ]; then
	INCLDIR="$INCLDIR -I$CYG_ROOT$AUBITDIR/incl"
fi

NCC_PG="ecpg_wrap"
NCC_IFX="esql"


if test "$A4GL_FAKELEXTYPE" = "PCODE"; then
    NCC="c2pcode_fgl "
else
	#CC is set via aubitrc config file:
	NCC="$CC " # -O2
fi

#  -save-temps              Do not delete intermediate files
#  -v                       Display the programs invoked by the compiler
#  -E                       Preprocess only; do not compile, assemble or link


FGLC_OUTPUT_EXT=c

if [ "$A4GL_LEXTYPE" = "EC" ]
then
	if [ "$A4GL_LEXDIALECT"  = "POSTGRES" ]
	then
		FGLC_OUTPUT_EXT=cpc
        NCC=$NCC_PG
	else
		FGLC_OUTPUT_EXT=ec
        NCC=$NCC_IFX
	fi
fi


#This may help while compiling, but compiled programs will not run
#if it's not in his environmnet. So set your environment!
#WARNING: this _IS_ needed in case you have several different libraries
#with same names in the path, like odbc. This will put path to library we
#are currently compiling for in front, and pick up correct one:
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$AUBITDIR/lib:.:
#$AUBITDIR/extlibs

#ADD_LD_LIBRARY_PATH is defined by 'configure' in aubitrc
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ADD_LD_LIBRARY_PATH

if [ "$TIMEIT" = "1" ]; then
	NCC="$TIME $NCC"
	FGLCEXEC="$TIME $FGLCEXEC"
fi

counter=0

ALL_FLAGS=$@

#First check for flags that affect processing of the flags:

for a in $ALL_FLAGS
do
	case $a in

	   -verbose)
	   		A4GLVERBOSE="yes"
			SHOWERRCODE=1
            echo "Verbose mode ON"
	   ;;

	esac
done


############
for a in $@
############
do
   let counter=counter+1

	if test "$skip_next_flag" = "1"; then
        #we used this flag as parameter to the previous one, so we don't
        #want it processed:
		if [ "$A4GLVERBOSE" = "yes" ]
		then
            echo "Skipping over #$counter=$a"
        fi
        skip_next_flag=0
		continue
    fi

   ##########
   case $a in
   ##########

   -time)
		if [ "$TIMEIT" != "1" ]; then
			TIMEIT=1
			NCC="$TIME $NCC"
    	    FGLCEXEC="$TIME $FGLCEXEC"
        fi
   ;;

   -findfunc)
		nm -A --defined-only `find $AUBITDIR/lib -name '*.so'` | grep $2

        #-H = show file names:
		# grep -H "extern int close" /usr/include/*.h

        exit 0
   ;;

   -findlib)
		nm -A --defined-only `find /lib -name '*.so'` | grep $2

        #-H = show file names:
		# grep -H "extern int close" /usr/include/*.h

        exit 0
   ;;


   -mk_pair)
		#find all targets created by Amake make files, to detect which make fiels
        #failed to produce resulting target
		ALL=`find . -name "*.mk" -exec basename {} \; | sort `
		CNT=0
        CNT2=0
		############
		for a in $ALL
		############
		do
            let CNT=CNT+1
			#echo $a
            PAIR=`basename $a .mk`.4ae
			FOUND=`find -name $PAIR`
            if [ "$FOUND" = "" ]; then
	            PAIR=`basename $a .mk`.aox
				FOUND=`find -name $PAIR`
	            if [ "$FOUND" = "" ]; then
                    echo "Cannot find a target of $a"
                    let CNT2=CNT2+1
                else
					if [ "$A4GLVERBOSE" = "yes" ]; then
						echo $a 	= $PAIR
                    fi
				fi
            else
				if [ "$A4GLVERBOSE" = "yes" ]; then
					echo $a 	= $PAIR
                fi
            fi
		done
        echo "Total processed : $CNT"
		echo "Total targets missing : $CNT2"
    ;;

   -mk_pair2)
		#find amake makefile pair for each target object (programs and libraries)
        #to detect missing make files
		ALL=`find . -name "*.4ae" -exec basename {} \; | sort `
		ALL="$ALL `find . -name "*.aox" -exec basename {} \; | sort `"
		CNT=0
		CNT2=0
		############
		for a in $ALL
		############
		do
            let CNT=CNT+1
			#echo $a
            PAIR=`basename $a .4ae`
            PAIR=`basename $PAIR .aox`
            PAIR=$PAIR.mk
			if [ "$A4GLVERBOSE" = "yes" ]; then
				echo Looking for $PAIR
            fi
			FOUND=`find -name $PAIR`
            if [ "$FOUND" = "" ]; then
				echo "Cannot find make file pair ($PAIR) of $a"
            let CNT2=CNT2+1
            else
				if [ "$A4GLVERBOSE" = "yes" ]; then
					echo $a 	= $PAIR
                fi
            fi
		done
        echo "Total procesed : $CNT"
        echo "Total missing  : $CNT2"
    ;;


   -not_mk)
		#find 4gl source files not referenced in any .mk files
		ALL4GL=`find . -name "*.4gl" -exec basename {} \; | sort `
		ALLMK=`find . -name "*.mk" | sort `
		CNT=0
		CNT2=0
		############
		for a in $ALL4GL
		############
		do
            let CNT=CNT+1
            FOUND=`grep $a $ALLMK`
			if [ "$A4GLVERBOSE" = "yes" ]; then
				echo Looking for $a
            fi
            if [ "$FOUND" = "" ]; then
				echo "Cannot find make file referencing $a"
	            let CNT2=CNT2+1

				if [ "$CMPL" = "yes" ]; then
                    #try to compile it
					THIS4GL=`find . -name $a`
    	            THISOBJ=`basename $THIS4GL .4gl`.ao
        	        THISPATH=`dirname $THIS4GL`
                    if [ ! -f "$THISPATH/$THISOBJ" ]; then
						echo "aubit 4glpc $THIS4GL -c -o $THISPATH/$THISOBJ"
						aubit 4glpc $THIS4GL -c -o $THISPATH/$THISOBJ
	                    if [ "$?" != "0" ]; then
    	                    echo "Failed. Stop."
        	                exit 44
            	        fi
                    else
                        echo "exists: $THISPATH/$THISOBJ"
                    fi
                fi
				if [ "$CMPL" = "clean" ]; then
					THIS4GL=`find . -name $a`
    	            THISOBJ=`basename $THIS4GL .4gl`.ao
        	        THISPATH=`dirname $THIS4GL`
                    if [ -f "$THISPATH/$THISOBJ" ]; then
                        rm $THISPATH/$THISOBJ
                    fi
                fi
            else
				if [ "$A4GLVERBOSE" = "yes" ]; then
					echo "Found $a in $FOUND"
                fi
            fi
		done
        echo "Total procesed : $CNT"
        echo "Total missing  : $CNT2"
    ;;


   -dups)
		#list all duplicated files in tree below current location
		ALL=`find . -name "*" -exec basename {} \; | sort | uniq -c | grep -v " 1" `
		CNT=1
		############
		for a in $ALL
		############
		do
			if [ $CNT = 2 ]
			then
				case $a in
				#things to be ignored:
				"CVS")
				;;
				"Root")
				;;
				"Repository")
				;;
				"Makefile")
				;;
				"Makefile.in")
				;;
				"Makefile.old")
				;;
				"bin")
				;;
				"config")
				;;
				"data")
				;;
				"debian")
				;;
				"Entries")
				;;
				"generated")
				;;
				"*.bak")
				;;
				READM*)
				;;
				"rules")
				;;
				* )
					PRINTED_HEAER=0
					FILE=`find . -name $a`
					for b in $FILE
					do
						if [ ! -d "$b" ]
						then
							if [ "$PRINTED_HEAER" = "0" ]
                            then
                                PRINTED_HEAER=1
								echo -------------------------- $DUP_NUM = $a
                            fi
							ls -al $b
						else
                            if [ "$A4GLVERBOSE" = "yes" ]
                            then
								echo "$b Is directory - skipped"
                            fi
						fi
					done
				esac
				CNT=1
			else
			    CNT=2
				DUP_NUM=$a
			fi
		done

    ;;

   -manifest)
        DO_AND_EXIT="ldd"
        run_next
   ;;

   -run)
        DO_AND_EXIT="exec"
        run_next
   ;;

   -settings)
        echo "Processed configuration files, in this order:"
		echo
		echo "A1 [/etc/opt/aubit4gl/aubitrc] =$A1"
		echo "A2 [/opt/aubit4gl/etc/aubitrc] =$A2"
		echo "A3 [../etc/aubitrc]            =$A3"
		echo "A4 [etc/aubitrc]               =$A4"
		echo "A5 [~/.aubit4gl/aubitrc]       =$A5"
		echo "A6 [./.aubitrc]                =$A6"
		echo "A7 ['A4GL_INIFILE']           =$A7"
		echo "A8 environment"
		echo

        echo AUBITDIR = $AUBITDIR

        if [ "$1" = "-settings" ] && [ "$2" = "" ]
        then
			exit 0
        fi

   ;;

   *.a) COMPCC="$COMPCC $a"
   ;;

   #.ao behaves same as .o, needed to distinguish from I4GL objects in universal makefiles:
   *.o | *.ao) COMPCC="$COMPCC $a"
		EXECNAME="1"
   ;;

   #this is supposed to be linked collection of compiled library files (.ao)
   *.aox) COMPCC="$COMPCC $a"
		EXECNAME="1"
   ;;



   *.c) COMPCC="$COMPCC $a"
   ;;

   *.ec) 
	if [ "$A4GL_LEXDIALECT" = POSTGRES ]
	then
		NCC=$NCC_PG
	else
		NCC=$NCC_IFX
	fi

   	COMPCC="$COMPCC $a"
	;;

   *.cpc)
	if [ "$A4GL_LEXDIALECT" = POSTGRES ]
	then
		NCC=$NCC_PG
	else
		NCC=$NCC_IFX
	fi

   	COMPCC="$COMPCC $a"

   ;;


   *.per)
		  if [ "$A4GLVERBOSE" = "yes" ]
		  then
            $output Compiling form $a
		  fi

		  fcompile -c $a
		  err_code=$?

          dirn=`dirname $a`
   		  fname=`basename $a .per`
   		  errfname=`basename $a .per`.err;

		  if ! [ -f $fname.$FGLC_OUTPUT_EXT ]
		  then
            if [ -f $errfname ]
            then
				showerror
				#$output "Error compiling $a, see file $errfname"
			else
				if [ -f $dirn/$errfname ]
                then
					errfname=$dirn/$errfname
					showerror
					#$output "Error compiling $a - see file $errfname"
                else
					$output "Error compiling $a - error file NOT created"
                fi
            fi
            if [ "$IGNORE_ERRORS" != "1" ]
            then
				if [ "$A4GLVERBOSE" = "yes" ]
				then
			        echo "Exiting with code $err_code"
			    fi
				exit $err_code
            fi
          else
	        COMPCC="$COMPCC $fname.$FGLC_OUTPUT_EXT"
          fi

   ;;


   *.per-old) fcompile -c $a
          fname=`basename $a .per`
        COMPCC="$COMPCC $fname.c"
   ;;

   *.per-direct) fcompile $a
   ;;



   *.msg)
        fname=`basename $a .msg`
		mkmess $fname
		#COMPCC="$COMPCC $fname.c"
   ;;

   *.menu) mcompile -c $a
          fname=`basename $a .menu`
        COMPCC="$COMPCC $fname.c"
   ;;


   *.4gl)

		dirn=`dirname $a`
        if [ "$dirn" != "." ]; then
			if [ "$MINGW" = "1" ]; then
    	        a=$CYG_ROOT$a
				dirn=`dirname $a`
        	fi
        fi

        fname=`basename $a .4gl`
        errfname=`basename $a .4gl`.err;

        fname2="$dirn/$fname"
        fname3="$dirn/$fname.4gl"
		fname=$fname2

        #if we did not invoked 4gl compile from inside directory where 4gl is,
        #CC will not be able to find it's .h file:
		if [ "$dirn" != "" ] && [ "$dirn" != "." ]
		then
			 COMPCC="$COMPCC -I./$dirn"
        fi

        if ! [ -f $fname3 ]
        then
          echo "$fname3 not found"
          exit 10
        fi

        # Create the blank...
        touch $fname.$FGLC_OUTPUT_EXT

        if [ -f "$fname".err ]
        then
        	rm "$fname".err
        fi

		if [ "$A4GLVERBOSE" = "yes" ]
		then
			$output "$fname: "
			$output LD_LIBRARY_PATH=$LD_LIBRARY_PATH, A4GL_SQLTYPE=$A4GL_SQLTYPE
			$output AUBITDIR=$AUBITDIR, PATH=$PATH
			$output "Executing (1) : $FGLCEXEC $a"
		fi

		########################
		#Invoke 4GL compiler
		########################
		err_msg=`eval "$FGLCEXEC" "$a"`
		err_code=$?

		if [ "$err_code" != "0" ]
		then
			##############################
			#$FGLCEXEC returned an error code
            ##############################
			if [ "$err_code" = "139" ]
	        then
	        	echo "$FGLCEXEC core dump"
				if [ "$A4GLDEBUG" = "yes" ]
				then
					env
                fi
				exit 139
			fi

			if [ -f $errfname ]
            then
				showerror
			else
				if [ -f $dirn/$errfname ]
                then
					errfname=$dirn/$errfname
					showerror
					if [ "$A4GLVERBOSE" = "yes" ]
					then
		            	$output err_msg is: $err_msg
		            fi
                else
					$output "Error compiling $a - error file NOT created"
	            	$output err_msg is: $err_msg
                fi
            fi

			if [ "$A4GLVERBOSE" = "yes" ]
			then
				echo "Exiting with code $err_code"
			fi

			exit $err_code
		fi


		
		if [ -f $fname.$FGLC_OUTPUT_EXT ]
        then
            ###########################################
			#C file was created, no error was reported
            ###########################################
			if ! [ -s $fname.$FGLC_OUTPUT_EXT  ]
    	    then
				##############################################
				#C file is empty!
                ##############################################
                echo "Created $fname.$FGLC_OUTPUT_EXT is zero size ! Message is:"
                echo $err_msg

				if [ "$A4GLVERBOSE" = "yes" ]
				then
				  	if [ -f $errfname ]
	    	        then
                        showerror
					else
						if [ -f $dirn/$errfname ]
		                then
							errfname=$dirn/$errfname
							showerror
							#$output "Error compiling $fname.$FGLC_OUTPUT_EXT - see file $errfname"
		                else
							$output "Error compiling $fname.$FGLC_OUTPUT_EXT - error file NOT created"
		                fi
	                fi

					$output err_msg is: $err_msg
	                $output err_code is: $err_code
	                $output Please check file "$fname".err
	                $output 'You can also "export DEBUG=ALL" to get "debug.out" file'
				fi
	            #we don't want to exit with 0 here:
	            err_code=9
				if [ "$A4GLVERBOSE" = "yes" ]
				then
					echo "Exiting with code $err_code"
				fi
				exit $err_code
			fi

			if [ "$A4GLVERBOSE" = "yes" ]
			then
				$output $FGLCEXEC "$a" OK, continue...
			fi

			if [ "$MAP4GL" = "Y" ]
			then
				if [ -x "$AUBITDIR/bin/loadmap" -a "$LOADMAP" != "N" ]
				then
					$output "Loading map file for $a into database"
					loadmap $fname.map > /dev/null 2> $fname.map.err
				fi
			fi

			PRETTYC=${PRETTYC:-"indent"}
			if [ "$AUTOINDENT" = "Y" ]
			then
			 	$PRETTYC "$fname.$FGLC_OUTPUT_EXT"
			fi

			if [ "$LINKIT" = "1" ]
			then
                #we got this .4gl in linking command so we need to make object
                #for linking to succedde, or we where explicity requested to
				#make an object from 4gl file :
				#if [ "$COMSPEC" = "" ]
				#then
					EXEC="$DOIT $NCC $CFLAGS $fname.$FGLC_OUTPUT_EXT -c -o $fname.ao $INCLDIR 2> $fname.$FGLC_OUTPUT_EXT.err"
				#else
				#	EXEC="$DOIT $NCC $CFLAGS $fname.$FGLC_OUTPUT_EXT -c -o $fname.ao $INCLDIR 2> $fname.$FGLC_OUTPUT_EXT.err"
                #    #remove this duplication
				#	#EXEC="$DOIT $NCC $CFLAGS $fname.$FGLC_OUTPUT_EXT -o $fname.ao -c $INCLDIR 2> $fname.$FGLC_OUTPUT_EXT.err"
				#fi

				if [ "$A4GLVERBOSE" = "yes" ]
				then
					$output "executing (2) : $EXEC"
				fi

                ########################
				#Invoke C compiler
				########################
				eval $EXEC
				err_code=$?
                ########################

				if [ "$err_code" != "0" ]
				then
                    #we got error from C compiler
					showerror
					echo "error compiling $fname.$FGLC_OUTPUT_EXT. STOP."
					exit $err_code
                else
					if [ -f "$fname.$FGLC_OUTPUT_EXT.err" ]; then
						#C compiler did not return error code, but .err file was
                        #created, and we know it will only contain C compiler,
                        #warnings, so we don't want to confuse things and people:

						#-s is True if file exists and has a size greater than zero.
						if [ -s "$fname.$FGLC_OUTPUT_EXT.err" ]; then
							if [ "$A4GLVERBOSE" = "yes" ]; then
    	                        echo "Found $fname.$FGLC_OUTPUT_EXT.err, moving it to $fname.$FGLC_OUTPUT_EXT.warn"
        			        fi
							mv "$fname.$FGLC_OUTPUT_EXT.err" "$fname.$FGLC_OUTPUT_EXT.warn"
                        else
                            #file exists, but it's empty
                            rm "$fname.$FGLC_OUTPUT_EXT.err"
                        fi
                    else
						if [ "$A4GLVERBOSE" = "yes" ]; then
 							echo "Did NOT found $fname.$FGLC_OUTPUT_EXT.err"
	       		        fi
					fi
				fi

				COMPCC="$COMPCC $fname.ao"
            else
				COMPCC="$COMPCC $fname.$FGLC_OUTPUT_EXT"
            fi
        else
            ###################################
			#C file was _NOT_ created by FGLCEXEC, but FGLCEXEC did _NOT_ return an error code
            ###################################
            #is this a 0 length 4gl file?
			FGLFILESIZE=$(ls -al $fname3 | $AWK '{print $5}')

			if [ "$FGLFILESIZE" = "0" ]
            then
				if [ "$A4GLVERBOSE" = "yes" ]
	    		then
					echo "$fname3 size is $FGLFILESIZE"
                fi

				#fakeing c file, to get empty object file from c compiler:
				touch $fname.$FGLC_OUTPUT_EXT
				COMPCC="$COMPCC $fname.$FGLC_OUTPUT_EXT"
            else
				$output "Error compiling $a - $fname.$FGLC_OUTPUT_EXT not generated, but no err code from $FGLCEXEC"
				if [ "$A4GLVERBOSE" = "yes" ]
				then
				  	if [ -f $errfname ]
	    	        then
                        showerror
					else
						if [ -f $dirn/$errfname ]
		                then
							errfname=$dirn/$errfname
							showerror
							#$output "Error compiling $fname.$FGLC_OUTPUT_EXT - see file $errfname"
		                else
							$output "Error compiling $fname.$FGLC_OUTPUT_EXT - error file NOT created"
		                fi
	                fi

					$output err_msg is: $err_msg
	                $output err_code is: $err_code
	                $output Please check file "$fname".err
	                $output 'You can also "export DEBUG=ALL" to get "debug.out" file'
				fi
	            #we don't want to exit with 0 here:
	            err_code=9
				if [ "$A4GLVERBOSE" = "yes" ]
				then
					echo "Exiting with code $err_code"
				fi
				exit $err_code
            fi
		fi
   ;;

   -echo) DOIT="echo"
   ;;
   -e) NO_COMPILE=1
	ISMAKE=-1
	LINKIT=0
   ;;

   -i) IGNORE_ERRORS="1"
	
   ;;

   -jabber) USE_JABBER=1
   ;;


   -verbose) 	A4GLVERBOSE="yes"
				SHOWERRCODE=1
   ;;

   -noerrcode)
        SHOWERRCODE=0
   ;;

   -map)
        echo "Setting map file on"
        MAP4GL="Y"
        export MAP4GL
   ;;

   -maponly) 		export MAP4GL="Y"
             		NOCFILE="Y"
   ;;

   -make-compile) 	export MAKE4GLPC="Yes"

   ;;

   -nomap) unset MAP4GL
   ;;

   -debug) export INCLINES=""
           export DEBUG=ALL
		   #DDEBUG="_g"
           COMPCC="$COMPCC -g"
   ;;

   -as-dll)		#creates shared library- .so on UNIX, .dll on Windows
   				COMPCC="$COMPCC -shared"
   ;;

   -shared)
			USE_SHARED="Yes"
   ;;

   -static)
			USE_SHARED="No"

   ;;

   -o) COMPCC="$COMPCC -o "
       ISMAKE=-1
       LINKIT=1

       ERREXT=.err

       ERRFILE="$fname$ERREXT"
       LAST="2> $ERRFILE"
	   DEFAULTCOMPCC="$COMPCC $fname"
       EXECNAME="-1"


   ;;

   -noprefix)  #Something for Mike, to be passed to FGLCEXEC, NOT to CC
	pass="-N \"$next\""
        FGLCEXEC="$FGLCEXEC $pass"
	if [ "$A4GLVERBOSE" = "yes" ]; then
	        echo "FGLCEXEC=$FGLCEXEC"
        fi

   ;;


   *) if [ "$ISMAKE" = "-1" ]
      then
         EXECNAME="$a"
		 ISMAKE=1
	     ERREXT=.err
		 ERRFILE="$a$ERREXT"
		 LAST="2> $ERRFILE"

      fi

      COMPCC="$COMPCC $a"
  ;;

  ####
  esac
  ####
####
done
####


if [ "$EXECNAME" = "-1" ]
then
    COMPCC=$DEFAULTCOMPCC
	$output "-o specified without object name, default name is $fname"
	if [ "$ISMAKE" = "-1" ]
    then
         ISMAKE=1
    fi
fi

#-lFORM/MENU/MSG_xxx is here temporary, untill this lib is dlopen() enabled:
#FGLLIBS_COMMON="-laubit4gl -lFORM_$A4GL_FORMTYPE -lMENU_$A4GL_MENUTYPE -lMSG_$A4GL_MSGTYPE"
FGLLIBS_COMMON="-laubit4gl"

if [ "$COMSPEC" = "" ]
then
	FGLLIBS_COMMON="$FGLLIBS_COMMON" # -ldl"
else
	FGLLIBS_COMMON="$FGLLIBS_COMMON -L/lib/w32api -L/usr/local/lib"
fi

if [ "$A4GL_LEXTYPE" = "EC" ]
then
	#if [ "$A4GL_LEXDIALECT"  = "POSTGRES" ]
	#then
		FGLLIBS_COMMON="$FGLLIBS_COMMON "
	#else

	#fi
fi

#FGLLIBS_COMMON="$FGLLIBS_COMMON -lm  -lRPC_$A4GL_XDRTYPE"
FGLLIBS_STATIC="$FGLLIBS_COMMON -static"
FGLLIBS_SHARED="$FGLLIBS_COMMON"




if [ "$A4GLDEBUG" = "yes" ]
then
	echo ------------------------------------------------------------------
	echo USE_SHARED = $USE_SHARED
	echo FGLLIBS_SHARED = $FGLLIBS_SHARED
	echo FGLLIBS_STATIC = $FGLLIBS_STATIC
	echo ------------------------------------------------------------------
fi

if [ "$USE_SHARED" = "Yes" ]
then
	FGLLIBS="$FGLLIBS_SHARED"
else
	FGLLIBS="$FGLLIBS_STATIC"

	if test "$COMSPEC" = ""; then
		#without -rdynamic:
		#Opps 1 - can't open DLL - /opt/aubit/aubit4glsrc/lib/libSQL_unixodbc.so: undefined symbol: status
		if [ "$A4GL_RDYNAMIC" = "" ]
		then
			A4GL_RDYNAMIC="-rdynamic"
		fi
		LIBS="$LIBS $A4GL_RDYNAMIC"
	fi
fi

if test "$USE_JABBER" = "1"
then
	LIBS="$LIBS -L$JABBER_LIB_DIR -l$JABBER_LIB_NAME -liksemel"
	#JabberX link line:
	#MANLINK2= -rdynamic -lnsl -lposix -lcrypt -liksemel
fi

if [ "$NOCFILE" = "Y" ]
then
   if [ "$A4GLVERBOSE" = "yes" ]
   then
	   $output No C files to compile.
   fi
	if [ "$A4GLVERBOSE" = "yes" ]
	then
		echo "Exiting with code 8"
	fi
	exit 8
fi

if [ "$COMPCC" = "" ]
then
   if [ "$A4GLVERBOSE" = "yes" ]
   then
	   $output No C files to compile.
   fi
	if [ "$A4GLVERBOSE" = "yes" ]
	then
		echo "Exiting with code 8"
    fi
	exit 8
fi

if [ "$A4GLDEBUG" = "yes" ]
then
#	echo $GTKGUI
	echo $COMSPEC
	echo $MAKE4GLPC
fi

if [ "$NO_COMPILE" = 1 ]
then


	eval "$DOIT $NCC -e $CFLAGS $COMPCC $INCLDIR $LAST"
	err_code=$?
	
	if [ "$A4GLVERBOSE" = "yes" ]
	then
		echo "Exiting after esql first stage with code 0"
	fi
	exit $err_code
fi


if [ "$ISMAKE" != "1" ]
then
	if [ "$COMSPEC" = "" ]
	then
		EXEC="$DOIT $NCC $CFLAGS $COMPCC $INCLDIR $LAST"
    else
        EXEC="$DOIT $NCC $CFLAGS $COMPCC -c $INCLDIR $LAST"
    fi

   if [ "$A4GLVERBOSE" = "yes" ]
   then
        $output "executing (3) : $EXEC"
   fi
    ##################
   	#invoke C compiler
    ##################
	eval $EXEC
	err_code=$?

	if [ $err_code != 0 ]
	then
		if [ "$LAST" != "" ]
		then
			errfname=`expr "$LAST" : "..\(.*\)"`
			showerror
			cerrfname=`basename $errfname .err`.$FGLC_OUTPUT_EXT.err
			if [ "$A4GLVERBOSE" = "yes" ]
			then
				echo "Moving $errfname to $cerrfname"
            fi
			mv $errfname $cerrfname
			$output "Error compiling - check $cerrfname"

		else
			$output "Error compiling - no LAST data."
		fi

		if [ "$A4GLVERBOSE" = "yes" ]
		then
	        echo "Exiting with code $err_code"
	    fi
		exit $err_code
   else
        #C compiler did not return error code
		errfname=`expr "$LAST" : "..\(.*\)"`
        if [ -f "$errfname" ]; then
			#-s is True if file exists and has a size greater than zero.
			if [ -s $errfname ]; then
				#this must be warnings, since we got no error code...
				warnfname=`basename $errfname .err`.$FGLC_OUTPUT_EXT.warn
				if [ "$A4GLVERBOSE" = "yes" ]
				then
					echo "Moving $errfname to $warnfname (2)"
	            fi
				mv $errfname $warnfname
            else
                #file exists, but it's empty
				rm $errfname
            fi
        fi
   fi

else
   if [ "$A4GLVERBOSE" = "yes" ]
   then
	   $output "Generating Exec"
	   echo "executing (4) : $DOIT $NCC $CFLAGS $COMPCC $INCLDIR $FGLLIBSDIR $FGLLIBS $LIBSDIR $LIBS $GTKLIBS $LAST"

		if [ "$A4GLDEBUG" = "yes" ]; then
		   echo $DOIT
		   echo $NCC
		   echo $COMPCC
		   echo $INCLDIR
		   echo $FGLLIBSDIR
		   echo $FGLLIBS
		   echo $LIBSDIR
		   echo $LIBS
		   echo $GTKLIBS
		   echo $LAST

		   echo LD_LIBRARY_PATH=$LD_LIBRARY_PATH
	       echo "PWD is `pwd`"
	    fi
   fi

	eval "$DOIT $NCC $CFLAGS $COMPCC $INCLDIR $FGLLIBSDIR $FGLLIBS $LIBSDIR $LIBS $GTKLIBS $LAST"
	err_code=$?

	if [ $err_code != 0 ]
	then
		if [ "$LAST" != "" ]
		then
			errfname=`expr "$LAST" : "..\(.*\)"`
			showerror
			echo "Error compiling... check $errfname"

	  else
		  $output "Error compiling."
      fi
	if [ "$A4GLVERBOSE" = "yes" ]
	then
        echo "Exiting with code $err_code"
    fi
	exit $err_code
   fi
fi

#-s is True if file exists and has a size greater than zero.
if [ "$ERRFILE" != "" -a ! -s "$ERRFILE" ]
then
	if [ -f "$ERRFILE" ]
    then
		rm $ERRFILE
	fi
fi

#Remove output file if it's empty
#errfname=`expr "$LAST" : "..\(.*\)"`
##-s is True if file exists and has a size greater than zero.
#if [ "$errfname" != "" -a ! -s "$errfname" ]
#then
#	if [ -f "$errfname" ]
#    then
#		rm $errfname
#	fi
#fi



if [ "$A4GLVERBOSE" = "yes" ]
then
	echo "Exiting with code 0"
fi

exit 0


#---------------------------- EOF ---------------------------------

