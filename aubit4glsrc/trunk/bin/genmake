#!/bin/sh
##########################################################################
#
#			Aubit 4gl compiler - make system
#
# genmake - utillity script to create Aubit-style makefiles from typical 
# existing 4gl makefiles.
#
# You are not supposed to run this script mannualy; it will be called from
# makefiles created with "prepmake" script.
#
##########################################################################

if [ $# -lt 2 -o "$1" = "--help" ]
then
    echo "ERROR: not enough parameters."
	echo "You are not supposed to run this script mannualy; it will be"
	echo "called from makefiles created with 'prepmake' script."
    exit 2
fi

	#filer out crap:
    CMDLINE=
    CMDLINEBASENAME=
	CNT=0
    CNTALL=0
    CNTSKIP=0
	###########
	for a in $@
    ###########
	do
        let CNTALL=CNTALL+1
		DIRNAME=`dirname $a`
        FULLNAME=$a
		a=`basename $a`
		if ! [ "$a" = "libfgl4js.42x" -o "$a" = "crap" ]
        then
	        let CNT=CNT+1
            if [ "$DIRNAME" != "" ] && [ "$DIRNAME" != "." ]
            then
	            if [ "$DIRNAME" != "$PWD" ]
    	        then
					#PROBLEMFILE=`echo $X | sed -e "/./s/\]//"`
					#LASTDIR=`echo $DIRNAME | sed -e "/$MAXDIR/s/$MAXDIR//"`
					A1=$(echo $MAXDIR | sed -e "s/\//\\\\\//g")
					A2=$(echo $DIRNAME | sed -e "s/$A1//")
					#echo "DIRNAME = $DIRNAME"
                    #echo "LASTDIR = $LASTDIR"
					if [ "$A2" != "/gprog" ] && [ "$A2" != "/gform" ]
                    then
						#if this happens, add it to vpath
						echo "$FULLNAME points outside current dir, to $A2. STOP."
    	                exit 67
                    fi
                fi
            fi
			STRIPPATH=`basename $a`
			CMDLINE="$CMDLINE $a"
			CMDLINEBASENAME="$CMDLINEBASENAME $STRIPPATH"

   			#first and  second can't be .42x
            ##########
			case $a in
            ##########

            *.42x)
				if test "$CNT" = "1" -o "$CNT" = "2"
                then
                    echo "Got $a in first or second position. STOP"
                    exit 56
                fi
            ;;

            *)
				if test "$CNT" = "1"
	            then
					#FIRST=`basename $a`
	                FIRST=$a
	            fi
	            if test "$CNT" = "2"
	            then
					#SECOND=`basename $a`
	                SECOND=$a
	            fi
	        ;;

			####
			esac
			####



        else
            let CNTSKIP=CNTSKIP+1
		fi
    ####
	done
    ####

PROG=`basename $FIRST .4go`
if [ "$PROG" != "$FIRST" ]
then
    IS4GO="1"
    IS42M="0"
    ISLIB="1"
    OBJEXT=4go
    PROGEXT=4gi
	LIBEXT=4go

else
	PROG=`basename $FIRST .42m`
	if [ "$PROG" != "$FIRST" ]
	then
	    IS4GO="0"
	    IS42M="1"
    	ISLIB="1"
        OBJEXT=42m
        PROGEXT=42r
	    LIBEXT=42x

    else
	    IS4GO="0"
	    IS42M="0"
		ISLIB="0"
    fi
fi

if test "$ISLIB" = "0"
then
	PROG=`basename $FIRST .4gi`
	if [ "$PROG" != "$FIRST" ]
	then
	    IS4GI="1"
		FJSLINKLINE=0
        OBJEXT=4go
        PROGEXT=4gi
		LIBEXT=4go
	else
		PROG=`basename $FIRST .42r`
		if [ "$PROG" != "$FIRST" ]
		then
		    IS4GI="1"
            #we are extracting components from 4Js link line, not from
            #dependencies list:
			FJSLINKLINE=1
            OBJEXT=42m
            PROGEXT=42r
	        LIBEXT=42x
        else
			echo "Cannot recognise extension of $FIRST STOP."
    	    exit 4
        fi
	fi
fi

	HEADERNAME='${AUBITDIR}/incl/header.mki'
	#HEADERNAME=header.mki
	FOOTERNAME='${AUBITDIR}/incl/footer.mki'
	FORMFILES=
    LIBLIST=
    FGLLIST=


#if we revceived only prog name and one 4gl file, AND program name is one
#of lib extensions, this is library function, not executable program:
if [ $# = "2" ] && [ "$ISLIB" = "1" ]
then
    IS_SINGLE_LIB="1"
	FILENAME=allsinglelibs.mk
	fname=`basename $SECOND .$OBJEXT`
	fname=`basename $fname .4gl`

    if ! [ -f $FILENAME ]
    then
		echo include $HEADERNAME > $FILENAME
		echo >> $FILENAME
		echo '#we are using this dummy name only to get all in objects-' >> $FILENAME
        echo '#it will not be used for anything - and it will possibly' >> $FILENAME
        echo '#even fail to link:' >> $FILENAME
		echo "PROG		= dummy.lib"  >> $FILENAME
		echo >> $FILENAME
		echo "GLOBALS.4gl	= $fname.4gl" >> $FILENAME
		echo >> $FILENAME
		echo 'FILES.4gl	= \' >> $FILENAME
		echo '		${GLOBALS.4gl} \' >> $FILENAME
	else
		echo "			$fname.4gl \\" >> $FILENAME
	fi

else
	FILENAME=$PROG.mk

	echo include $HEADERNAME > $FILENAME
	echo >> $FILENAME
    #echo "#-------------------------------------" >> $FILENAME
	#echo >> $FILENAME

	if [ "$ISLIB" = "1" ]
    then
		echo "PROG		= $PROG.lib"  >> $FILENAME
    else
		echo "PROG		= $PROG"  >> $FILENAME
    fi
	echo >> $FILENAME

	fname=`basename $SECOND .$OBJEXT`
	fname=`basename $fname .4gl`
	echo "GLOBALS.4gl	= $fname.4gl" >> $FILENAME
	echo >> $FILENAME

	##################
	for a in $CMDLINE
    ##################
	do
		if ! [ "$FIRST" = $a ] 		#it's program name
        then
	        if ! [ "$SECOND" = $a ]  #it's GLOBALS file
            then

			##########
			case $a in
	        ##########

			#*.42m) || *.4go) HOW THE HELL DO YOU DO _OR_here ?
			#*.4go)
            *.$OBJEXT)
				fname=`basename $a .$OBJEXT`
                #EXT=ao
                EXT=4gl

				#cinqwind is BOTH a 4gl and library (.42x, .aox) name
                #which is VERY stupid thing to do, and should be fixed in Maximise;
                #since I will have dependencies listeds with .4go in Maximise makefile,
                #(there will be .42x in 4Js link line, but I'm not looking at that...
				#Maybe I shoud use "fgllink..." line to get files, and not dependencies?)
				if [ "$fname" = "cinqwind" -o "$fname" = "invwind" -o "$fname" = "lic_keys" -o "$fname" = "pinqwind" -o "$fname" = "wcustwind" -o "$fname" = "wordrwin" -o "$fname" = "wpinqwind" ]
                then
					if [ "$OBJEXT" = "4go" ]
                    then
						#EXT=aox
						#if [ "$LIBLIST" = "" ]
					    #then
						#	#echo '		${FILES.lib} \' >> $FILENAME
                	    #fi
						LIBLIST="$LIBLIST $fname.lib"
                    else
    	                FGLLIST="$FGLLIST $fname.$EXT"
                    fi
                else
                    FGLLIST="$FGLLIST $fname.$EXT"
                fi

			;;

            *.$LIBEXT)
				fname=`basename $a .$LIBEXT`
                LIBLIST="$LIBLIST $fname.lib"
            ;;

			#*.42f) || *.frm)
	        *.frm)
				fname=`basename $a .frm`
	            FORMFILES="$FORMFILES $fname.per"
	        ;;

	        *) echo "ERROR: what the hell is $a"

				echo "IS4GO = $IS4GO"
			    echo "IS42M = $IS42M"
		    	echo "ISLIB = $ISLIB"
		        echo "$OBJEXT"
		        echo "$PROGEXT"
			    echo "$LIBEXT"
                echo "---------------------------x"
				echo $CMDLINEBASENAME
                echo "---------------------------x"
                echo $FIRST $SECOND
				#echo $@
				exit 1

	        ;;

			####
			esac
			####
            fi
        fi
	####
	done
    ####

	echo >> $FILENAME

    ############################
	#Write all libs to makefile:
    ############################
	if [ "$LIBLIST" != "" ]
    then

		echo 'FILES.lib	= \' >> $FILENAME
		#################
		for a in $LIBLIST
	    #################
		do
            echo "			$a \\" >> $FILENAME
        ####
        done
        ####

		echo >> $FILENAME
    fi

    ############################
	#Write all 4gl's to makefile:
    ############################
	if [ "$FGLLIST" != "" ]
    then
		echo 'FILES.4gl	= \' >> $FILENAME
		echo '			${GLOBALS.4gl} \' >> $FILENAME

		#if [ "$LIBLIST" != "" ]
		#then
		#	echo '			${FILES.lib} \' >> $FILENAME
        #fi

		#################
		for a in $FGLLIST
	    #################
		do
            echo "			$a \\" >> $FILENAME
        ####
		done
        ####

		echo >> $FILENAME
    #else
        #This can happen with porgrams that have only one 4gl file
		#echo FGLLIST is empty
        #exit 44

	fi

    ############################
	#Write all forms to makefile:
    ############################
	if [ "$ISLIB" != "1" ]
    then

		if [ "$FORMFILES" = "" ]
	    then
			#as defined in header.mki:
			echo 'FILES.per	= ${ALLFORMS.per}' >> $FILENAME
	    else
			echo "FILES.per	= \\" >> $FILENAME

			###################
			for a in $FORMFILES
		    ###################
			do
				echo "			$a \\" >> $FILENAME
	        done
	    fi
    fi
	
    ############################
	#Write footer to makefile:
    ############################
	echo >> $FILENAME
    #echo "#-------------------------------------" >> $FILENAME
	#echo >> $FILENAME
	echo include $FOOTERNAME >> $FILENAME
	echo >> $FILENAME
fi

#------------------------------ EOF --------------------------------
