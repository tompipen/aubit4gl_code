#!/bin/sh
#This is Aubit 4gl compiler warper script


if [ "$AUBITDIR" = "" ]; then
	AUBITDIR=`aubit-config AUBITDIR`
	if [ "$AUBITDIR" = "" ]; then
		echo "ERROR: AUBITDIR is empty. Stop."
		aubit-config AUBITDIR
		exit 3
	fi
fi

INIT_AUBITDIR="$AUBITDIR"

#Strip drive letter, because it will contain ":"
TMPAUBITDIR=`echo $AUBITDIR | sed -e 's/C://'g`
TMPAUBITDIR=`echo $TMPAUBITDIR | sed -e 's/D://'g`

#Strip Cygwin path, because PATH set here will be used by bash to 
#find executables in AUBITDIR
TMPAUBITDIR=`echo $TMPAUBITDIR | sed -e 's/\/cygwin//'g`

PATH=$TMPAUBITDIR/bin:$PATH

#Used to find libaubit4gl _only_ and _only_ on UNIX
LD_LIBRARY_PATH=$AUBITDIR/lib:$LD_LIBRARY_PATH

if [ "$COMSPEC" != "" ]; then
	#dll files are searched for by Windows loader only in PATH
	PATH=$AUBITDIR/lib:$PATH
fi


#set DBPATH for use by some Aubit programs that need form and/or help files, like asql, configurator, etc...

#because of the problem in dealing with multiple separators in resource.c we need to test
#if this variables are currently empty or not before concernating

if test "$A4GL_DBPATH" = "" ; then
	A4GL_DBPATH=$AUBITDIR/bin
else
	A4GL_DBPATH=$AUBITDIR/bin:$A4GL_DBPATH
fi

if test "$DBPATH" = "" ; then
	DBPATH=$AUBITDIR/bin
else
	DBPATH=$AUBITDIR/bin:$DBPATH
fi

export AUBITDIR PATH LD_LIBRARY_PATH A4GL_DBPATH DBPATH

if [ $# -lt 1 -o "$1" = "--help" ]; then
    echo
	echo Aubit 4gl compiler warper script: $0
    echo
    echo Usage:
    echo '  aubit [--verbose] <command> <command parameters...>'
	echo
    echo ' For details, try: '
    echo '    aubit <command> --help'
    echo '    where <command> is one of the following:'
	echo ' 4glpc - main compiler script (scheduled to be obsoleted)'
    echo ' 4glc - 4gl to [C|Perl|EC|...]-code compiler'
	echo ' fcompile - form file (.per) compiler'
    echo ' mcompile - menu file (.menu) compiler'
    echo ' amkmessage - help file (.hlp) compiler'
    echo
    echo ' Use "aubit-config" to inspect Aubit compiler configuration '
    echo
	exit 1
fi

if [ "$1" = "--show" ]; then
    echo
    echo "AUBITDIR=$AUBITDIR"
    echo "INIT_AUBITDIR=$INIT_AUBITDIR"
    echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
    echo "PATH=$PATH"
    exit 0
fi

#FIXME: on CygWin, we must add "bash" in front of "4glpc" otherwise standard "sh" will be
#used and give us bunch of errors in 4glpc. We need to recognize and fix this here

#List of all Aubit tools that are supposed to run only on command line in
#TUI mode - not GUI mode
CMD_LINE_TOOLS="4glc aubit-config default_frm mcompile 4glc-strip aupscol \
	ecpg_wrap mdecompile 4glpc amkmessage aupscol.err c2pcode esql_wrap \
    prepmake aace asql_g.4ae c2pcode_fgl process_report aace_4gl asql_i.4ae \
	fcompile aace_perl asql_p.4ae checker fdecompile runner abug.sh checker_fgl \
    runner_fgl adecompile  unmkmessage afinderr aubitbuild.sh convertsql genmake \
	amake xgen"

for CMD in $CMD_LINE_TOOLS; do
	if test "$1" = "$CMD"; then 
		IS_CMD_LINE_TOOL=1
		export A4GL_UI=TUI
	fi
done	

FLAGS=$@
EXEC=""
FLAG_CNT=0

for FLAG in $FLAGS; do
   ################
   case $FLAG in
   ################

   --verbose | -verbose)
        echo "AUBITDIR=$AUBITDIR"
        echo "PATH=$PATH"
        echo "DBPATH=$DBPATH"
        echo "A4GL_DBPATH=$A4GL_DBPATH"
		VERBOSE=1
        $2 $3 $4 $5 $6 $7 $8 $9
   ;;

   *)
		FLAG_CNT=`(expr $FLAG_CNT + 1) 2>/dev/null`
		
		if test "$FLAG_CNT" = "1" -a "$VALGRIND" = "YES" ; then 
	        EXEC="$EXEC valgrind $FLAG"		
		else
	        EXEC="$EXEC $FLAG"
		fi
   ;;

  ####
  esac
  ####
done
if test "$VERBOSE"; then 
	echo "Running: $EXEC"
fi
eval $EXEC
RET=$?
exit $RET

#----------------------------- EOF --------------------------

