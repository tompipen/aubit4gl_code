# +----------------------------------------------------------------------+
# | Aubit 4gl Language Compiler Version $.0   root makefile              |
# +----------------------------------------------------------------------+
# | Copyright (c) 2000-1 Aubit Development Team (See Credits file)       |
# +----------------------------------------------------------------------+
# | This program is free software; you can redistribute it and/or modify |
# | it under the terms of one of the following licenses:                 |
# |                                                                      |
# |  A) the GNU General Public License as published by the Free Software |
# |     Foundation; either version 2 of the License, or (at your option) |
# |     any later version.                                               |
# |                                                                      |
# |  B) the Aubit License as published by the Aubit Development Team and |
# |     included in the distribution in the file: LICENSE                |
# |                                                                      |
# | This program is distributed in the hope that it will be useful,      |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of       |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        |
# | GNU General Public License for more details.                         |
# |                                                                      |
# | You should have received a copy of both licenses referred to here.   |
# | If you did not, or have any questions about Aubit licensing, please  |
# | contact afalout@ihug.co.nz                                           |
# +----------------------------------------------------------------------+
#
# $Id: Makefile.in,v 1.49 2002-03-29 06:38:36 afalout Exp $
#

#All stuff common to more then one Aubit compiler make file is there:
include incl/Makefile-common

#FIXME: this should be obsoleted by configure and aubitrc:
#we don't want sub-makefiles to include above again: But we dont't went
#to export this gloably, since it would affect 4glpc sctipt!
#Instead, we want tp pass it to makefiles as command line parameter,
#only for make files that use it, but don't call 4glpc
#NOINCL_PARAM=NOINCL=1

#WARNING! cannot use ${MAKEFLAGS} because of make bug (see showbug:)
#all replaced with BUGMAKEFLAGS


## ==================================================================
##                    ODBC Settings
## ==================================================================

#obsolete - ifeq "$(ODBC)" "unix"
#obsolete - 	#Human readable name, for archinve file name, etc.
#obsolete - 	ODBCMANAGER		=unixODBC
#obsolete -    	#additional flags for ifdef in C code, needed for this ODBC driver/manager
#obsolete - #	LIBCFLAGS 		+= -DUNIXODBC
#obsolete - endif
#obsolete - ifeq "$(ODBC)" "iodbc"
#obsolete - 	ODBCMANAGER		=iODBC
#obsolete - #	LIBCFLAGS 		+= -DIODBC
#obsolete - endif
#obsolete - ifeq "$(ODBC)" "no"
#obsolete - 	ODBCMANAGER		=noODBC
#obsolete - #	LIBCFLAGS 		+= -DNOODBC
#obsolete - 	ODBCLIBDIR      =
#obsolete - 	ODBC_LIB_DIR    =
#obsolete - 	ODBC_LIB_NAME   = noodbc
#obsolete - endif

#obsolete - ifneq "$(ODBC)" "no"
#obsolete - 	#make sure we will pick up correct ODBC libraries:
#obsolete - 	LD_LIBRARY_PATH := ${ODBC_LIB_DIR}:${LD_LIBRARY_PATH}
#obsolete - 	export LD_LIBRARY_PATH
#obsolete - endif

## ==================================================================
##                    GTK Settings
## ==================================================================

#obsolete - #Human readable names for archive file names:
#obsolete - ifeq "$(GTKBUILD)" "yes"
#obsolete - 	GUITYPE			=GTK
#obsolete - else
#obsolete - 	GUITYPE			=noGTK
#obsolete - endif

## ==================================================================
##                    PDF Settings
## ==================================================================

#obsolete - ifeq "$(PDFBUILD)" "yes"
#obsolete - #	LIBCFLAGS 		+= -DUSE_PDF_REPORTS
#obsolete - 	PDFTYPE			=PDF
#obsolete - else
#obsolete - 	PDFTYPE			=noPDF
#obsolete - endif
#obsolete -
#MAKERPC				=unixrpc

## ==================================================================
##                    Automatic Build Settings
## ==================================================================

#When we package all binary builds using make allbindist, what we will build
#ALLBINDISTNAMESNOPDF=unixodbc-gtk-nopdf iodbc-gtk-nopdf unixodbc-nogtk-nopdf iodbc-nogtk-nopdf
#ALLBINDISTNAMESPDF	=unixodbc-gtk-pdf unixodbc-nogtk-pdf iodbc-gtk-pdf iodbc-nogtk-pdf
#ALLBINDISTNAMES		=${ALLBINDISTNAMESNOPDF} ${ALLBINDISTNAMESPDF}

## ==================================================================
##                    Install Settings
## ==================================================================

#RPM setup:
#redhat 6:
#RPMBUILDROOT=/root/redhat
#redhat 7.2
RPMBUILDROOT=/usr/src/redhat


SOURCE 		=.
#installation files
TESTDIR     =$(SOURCE)/tools/test
DOCDIR     	=$(SOURCE)/docs
IDEDIR     	=$(SOURCE)/tools/ide
TOBIN		=$(SOURCE)/bin/4glc${EXEEXT} $(SOURCE)/bin/4glpc $(SOURCE)/bin/fcompile${EXEEXT} \
			$(SOURCE)/bin/mcompile${EXEEXT} $(SOURCE)/bin/mkmess${EXEEXT} $(SOURCE)/bin/amake \
			$(SOURCE)/bin/amakeallo $(SOURCE)/bin/amakeallf \
			$(SOURCE)/bin/loadmap${EXEEXT} $(SOURCE)/bin/aubit $(SOURCE)/bin/aubit-config${EXEEXT} \
            $(SOURCE)/bin/genmake $(SOURCE)/bin/mdecompile${EXEEXT} $(SOURCE)/bin/prepmake \
			$(SOURCE)/bin/fdecompile${EXEEXT} $(SOURCE)/bin/fshow${EXEEXT}

#ifeq "$(GTKBUILD)" "yes"
#	TOBIN		+=$(SOURCE)/bin/fshow-gtk${EXEEXT}
#endif

ifeq "$(OUTPUTLANG)" "java"
	TOBIN		+=$(SOURCE)/bin/fdecompile-j${EXEEXT}
endif


#obsolete - ifneq "$(ODBC)" "no"
#obsolete - 	ifeq "$(ODBC_LINK)" "static"
#obsolete - 		TOBIN	+=$(SOURCE)/bin/4glc-noodbc${EXEEXT} $(SOURCE)/bin/fcompile-noodbc${EXEEXT} \
#obsolete - 					$(SOURCE)/bin/mcompile-noodbc${EXEEXT}
#obsolete -     endif
#obsolete - endif

TOLIBGTK	=$(SOURCE)/lib/libUI_GTK${SO_EXT} $(SOURCE)/lib/libUI_GTK_x${SO_EXT}
#$(SOURCE)/lib/libaclsharedgui${SO_EXT}
TOLIBCUI	=$(SOURCE)/lib/libaclshared${SO_EXT} $(SOURCE)/lib/libPDF_NOPDF${SO_EXT} \
			$(SOURCE)/lib/libSQL_nosql${SO_EXT} $(SOURCE)/lib/libUI_CONSOLE${SO_EXT} \
			$(SOURCE)/lib/libRPC_NORPC${SO_EXT}

ifneq "@HAVE_RPCLIB@" "0"
	TOLIBCUI	+=$(SOURCE)/lib/libRPC_SUNRPC${SO_EXT}
endif

ifneq "@HAVE_CURSES@" "0"
	TOLIBCUI	+=$(SOURCE)/lib/libUI_TUI${SO_EXT}
endif


ifneq "${STATICLIB_INST}" "no"
#	TOLIBGTK+=$(SOURCE)/lib/libUI_GTK.a $(SOURCE)/lib/libUI_GTK_x.a
	#$(SOURCE)/lib/libaclallgui.a
	TOLIBCUI+=$(SOURCE)/lib/libaclall.a
endif

TOLIB_EXPORTLIB =$(SOURCE)/lib/libaclshared${SOEXP_EXT} \
            $(SOURCE)/lib/libPDF_NOPDF${SOEXP_EXT} $(SOURCE)/lib/libSQL_nosql${SOEXP_EXT} \
            $(SOURCE)/lib/libUI_CONSOLE${SOEXP_EXT} $(SOURCE)/lib/libRPC_NORPC${SOEXP_EXT}

ifneq "@HAVE_CURSES@" "0"
	TOLIB_EXPORTLIB +=$(SOURCE)/lib/libUI_TUI${SOEXP_EXT}
endif

ifneq "@HAVE_RPCLIB@" "0"
	TOLIB_EXPORTLIB +=$(SOURCE)/lib/libRPC_SUNRPC${SOEXP_EXT}
endif


TOLIBGTK_EXPORTLIB	=$(SOURCE)/lib/libUI_GTK${SOEXP_EXT} $(SOURCE)/lib/libUI_GTK_x${SOEXP_EXT}
#$(SOURCE)/lib/libaclsharedgui${SOEXP_EXT} \



ifneq "${COMSPEC}" ""
	TOLIBCUI			+=$(SOURCE)/lib/libSQL_odbc32${SO_EXT}
	TOLIB_EXPORTLIB		+=$(SOURCE)/lib/libSQL_odbc32${SOEXP_EXT}
endif

ifeq "${PDFBUILD}" "yes"
    TOLIBCUI +=$(SOURCE)/lib/libPDF_PDF${SO_EXT}
endif

#ifneq "$(ODBC)" "no"
#	ifeq "$(ODBC_LINK)" "static"
#		TOLIBGTK	+=$(SOURCE)/lib/libaclallgui-noodbc.a
#		TOLIBCUI	+=$(SOURCE)/lib/libaclall-noodbc.a
#    endif
#endif

ifeq "${HAVE_UNIXODBC}" "yes"
	TOLIBCUI	+=$(SOURCE)/lib/libSQL_unixodbc${SO_EXT}
endif
ifeq "${HAVE_IODBC}" "yes"
	TOLIBCUI	+=$(SOURCE)/lib/libSQL_iodbc${SO_EXT}
endif

ifneq "@IFMX_ESQLC@" "no"
	TOLIBCUI	+=$(SOURCE)/lib/libSQL_esql${SO_EXT}
endif

ifneq "@HAVE_IFXODBC@" "no"
	TOLIBCUI	+=$(SOURCE)/lib/libSQL_ifxodbc${SO_EXT}
endif

ifneq "@HAVE_PGODBC@" "no"
	TOLIBCUI	+=$(SOURCE)/lib/libSQL_pgodbc${SO_EXT}
endif

MKFILNAME	=Makefile

TODOCS		=$(SOURCE)/docs/changelog.txt $(SOURCE)/docs/COPYING $(SOURCE)/docs/CREDITS $(SOURCE)/docs/LICENSE
TOTEST		=$(TESTDIR)/*.4gl $(TESTDIR)/*.per $(TESTDIR)/${MKFILNAME} $(TESTDIR)/*.msg
TOTESTGUI	=$(TESTDIR)/gui/*.4gl $(TESTDIR)/gui/*.per $(TESTDIR)/gui/${MKFILNAME}
#TOETC		=$(SOURCE)/etc/*.example
#TOETC		=$(SOURCE)/etc/a4glrc.example $(SOURCE)/etc/aubitenv.example $(SOURCE)/etc/odbc.ini.example $(SOURCE)/etc/aubitbuild.mk.example
TOETC		=$(SOURCE)/etc/odbc.ini.example
TOHOME		=$(SOURCE)/a4glrc.example
TOROOT		=$(SOURCE)/README.txt
TOINCL		=$(SOURCE)/incl/4glhdr.h $(SOURCE)/incl/acl4glgui.h \
				$(SOURCE)/incl/*.mk $(SOURCE)/incl/*.mki $(SOURCE)/incl/Makefile-common
TOIDE       =$(IDEDIR)/*.4gl $(IDEDIR)/*.c $(IDEDIR)/*.sh $(IDEDIR)/*.msg $(IDEDIR)/*.per $(IDEDIR)/${MKFILNAME}

##################################################
#definitions of names for bynary distro file name:
#FIXME: thi is set in makefile-common by configure:
AUBITVERSION:=$(shell cat $(SOURCE)/tools/project/version)
AUBITBUILD	:=$(shell cat $(SOURCE)/tools/project/build)
COMPILEDATE	:=$(shell date +%d-%m-%Y)

## ==================================================================
##                    CVS Settings
## ==================================================================

#obsolete - AUBITCVSNAME=Aubit4gl
AUBITCVSSFNAME=aubit4glsrc
#obsolete - AUBITCVSSFMANNAME=aubit4gldoc
#obsolete - CVSROOTSF=':pserver:anonymous@cvs.aubit4gl.sourceforge.net:/cvsroot/aubit4gl'

NAMEVERBLD=${AUBITCVSSFNAME}-${AUBITVERSION}.${AUBITBUILD}

#Download page processing temp file names:
#Warning: if you change this names, you will need to manually change existing
#names already embedded in CYBUILDNAMES	and UNIXBUILDNAMES files.
#obsolete - DLTMP1=tmpdlpage1.html
#obsolete - DLTMP2=tmpdlpage2.html

#obsolete - SCPPATH=/home/groups/a/au/aubit4gl/htdocs/files


## ==================================================================
##                    Platform dependent Settings
## ==================================================================

ifdef COMSPEC #############Windows platform - CygWin related:################

	#Under CygWin/Windows, cron cannot use network shares, and also
   	#we want to stop using local upload location, as defined in $WWW:
#obsolete - 	USELOCALUPLOAD	=0
#obsolete - 	SH          	=bash
	#OS				=win32-cygwin
	ARCHEXT			=zip
    DIRSEP			=\\
	EXE				=.exe
	#for packcygwin
	#CYSOURCE 		= $(AUBITDIR)
#obsolete -     CYSOURCE 		=.
#obsolete - 	CYDLLTARGET		=${INSTALL_DIR}/dll
#obsolete - 	CYLIBTARGET1	=${INSTALL_DIR}/extralibs
#obsolete - 	LIBTARGET2		=/lib
#obsolete - 	LIBTARGET1		=${INSTALL_DIR}/extralibs
#obsolete - 	DLLTARGET		=${INSTALL_DIR}/dll
#obsolete - 	RUNEXE			=$(CYSOURCE)/tools/cygwin/run.exe
#obsolete - 	CYTOBIN			=$(CYSOURCE)/bin/4glc${EXE} $(CYSOURCE)/bin/4glpc \
#obsolete - 					$(CYSOURCE)/bin/fcompile${EXE} $(CYSOURCE)/bin/mcompile${EXE} \
#obsolete - 					$(CYSOURCE)/bin/mkmess${EXE} ${RUNEXE} $(CYSOURCE)/bin/amake \
#obsolete - 	    	        $(CYSOURCE)/bin/amakeallf $(CYSOURCE)/bin/amakeallo \
#obsolete - 	        	    $(CYSOURCE)/bin/aubitbuild.sh $(CYSOURCE)/bin/genmake \
#obsolete - 	            	$(CYSOURCE)/bin/prepmake

#obsolete - 	ifneq "$(ODBC)" "no"
#obsolete - 		ifeq "$(ODBC_LINK)" "static"
#obsolete - 			CYTOBIN	+=$(CYSOURCE)/bin/4glc-noodbc${EXE} \
#obsolete - 					$(CYSOURCE)/bin/fcompile-noodbc${EXE} \
#obsolete - 					$(CYSOURCE)/bin/mcompile-noodbc${EXE}
#obsolete -         endif
#obsolete -     endif

#	CYTOLIBGTK	=$(CYSOURCE)/lib/libaclallgui.a $(CYSOURCE)/lib/libUI_GTK.a
	#we still cannot compile this one: $(CYSOURCE)/lib/libUI_GTK_x.so
#	ifneq "$(ODBC)" "no"
#		ifeq "$(ODBC_LINK)" "static"
#			CYTOLIBGTK	+=$(CYSOURCE)/lib/libaclallgui-noodbc.a
			#We still cannot compile this one :$(CYSOURCE)/lib/libUI_GTK-noodbc.a
#        endif
#    endif

#	ifeq "$(GTKBUILD)" "yes"
#	    ifeq "$(GLIBVER)" "old"
#			#extra libraries locations:
#			LIBVER		=-1.3
#			ADD			=/usr/src
#			L1			=${ADD}/gtk+/gdk
#			L2			=${ADD}/gtk+/gtk
#			L3			=${ADD}/rpc-4.0/rpc
#			L4			=${ADD}/glib
#			L5			=${AUBITDIR}/lib
#			L6			=${ADD}/libiconv${LIBVER}/src
#			L7			=${ADD}/intl
#			ALLLINKPATHS=-L${L1} -L${L2} -L${L3} -L${L4} -L${L5} -I/usr/src/rpc-4.0
#
#			LIBCFLAGS 		+=${ALLLINKPATHS}
#	    endif
#    endif

	#WARNING! this will override all CFLAGS in all sub-makefiles:
#	LIBCFLAGS 		+= -DWIN32

	WWW				=\\\\APTIVA\\ROOT\\data2\\htdocs
	ifeq "${USE_RPCGEN}" "0"
		#MAKERPC			=cyrpc
		CYRPC_FLAG:=$(shell ls cyrpc.flg ${NOERR})
	endif

#obsolete -     PREPARE 		=cyprepare
	GTKCONFIGTEXT	=echo "----- gtk-version form makefile -------"
	GTKCONFIGCMD	=echo ${LIBVER}
    LDDCMD          =cygcheck 	#echo "no ldd available on CygWin"
    #we need makefile for aubit binary build on CygWin to install dll/ and extralibs/
#obsolete - 	TOROOT          += $(SOURCE)/Makefile

else ####################### Platform is UNIX ##############################

	#We want to stop using local upload location, as defined in $WWW:
#obsolete - 	USELOCALUPLOAD=0

#obsolete - 	SH          	=sh
	#FIXME: this should be automatic, or contain kernel version:
	#OS				=RH6
	ARCHEXT			=tar.gz
    DIRSEP			=/
	#on unix, we expect to have WWW set in environment
	#WWW			=/data2/htdocs
#obsolete -     PREPARE 		=unixprepare
	GTKCONFIGTEXT	=echo "----- gtk-config --version ---------"
	GTKCONFIGCMD	=gtk-config --version
    LDDCMD          =ldd
endif


## ==================================================================
##                    Nightly builds Settings
## ==================================================================

#obsolete - FTPLOCATION		=$(WWW)${DIRSEP}projects${DIRSEP}Aubit4GL${DIRSEP}download

#FIXME: add CPU to file name (i385,i586, etc.) instead of "bin"
#obsolete - TEMPLATENAME	=aubit4gl-bin-$(TARGET)-$(ODBCMANAGER)-$(GUITYPE)-$(PDFTYPE)---template--.${ARCHEXT}
#obsolete - TEMPLATENAMETXT	=aubit4gl-bin-$(TARGET)-$(ODBCMANAGER)-$(GUITYPE)-$(PDFTYPE)---txttemplate--.${ARCHEXT}
#obsolete - TEMPLATESRC		=aubit4gl-src--template--.${ARCHEXT}

#script (SCP) to use to get html template
#obsolete - AUTOSFSCPGET	=autosfscpget

#obsolete - TARNAMENOEXT	=aubit4gl-bin-$(TARGET)-$(ODBCMANAGER)-$(GUITYPE)-$(PDFTYPE)-$(AUBITVERSION)-$(AUBITBUILD)-$(COMPILEDATE)
#obsolete - TARNAME			=${TARNAMENOEXT}.${ARCHEXT}
#FIXME: remove ZIPNAME
#obsolete - ZIPNAME			=${TARNAME}
#obsolete - ZIPRUNTIMENAME  =aubit4gl-runtime-$(TARGET)-$(ODBCMANAGER)-$(GUITYPE)-$(PDFTYPE)-$(AUBITVERSION)-$(AUBITBUILD)-$(COMPILEDATE).${ARCHEXT}

PLATFORMSTRING	=compile-platform-info

#SF web site thinks all files that have tar.gz ANYWHERE in the name are
#tar.gz files, and show them as empty, so we cannot use full TARNAME:
#PLATFORMINFOFULL=${PLATFORMSTRING}-$(TARNAME).txt
#obsolete - PLATFORMINFOFULL=${PLATFORMSTRING}-$(TARNAMENOEXT).txt
#obsolete - TEMPLATENAMEINFO=${PLATFORMSTRING}-$(TEMPLATENAMETXT).txt
PLATFORMINFO	=${PLATFORMSTRING}.txt


#obsolete - DOWNLOADPAGEBASE=aubitdownload.htm
#obsolete - DOWNLOADPAGE	=$(FTPLOCATION)${DIRSEP}${DOWNLOADPAGEBASE}
#obsolete - TEMPLATEFILEBASE=aubitdownload-template.htm
#obsolete - TEMPLATEFILE	=$(FTPLOCATION)${DIRSEP}${TEMPLATEFILEBASE}

#obsolete - ifeq "$(USELOCALUPLOAD)" "1"
#obsolete - 	CYBUILDNAMES	=${FTPLOCATION}${DIRSEP}cybuildnames.tmp
#obsolete - 	UNIXBUILDNAMES	=${FTPLOCATION}${DIRSEP}unixbuildnames.tmp
#obsolete - 	CYSRCBUILDNAMES	=${FTPLOCATION}${DIRSEP}cysrcbuildnames.tmp
#obsolete - 	UNIXSRCBUILDNAMES=${FTPLOCATION}${DIRSEP}unixsrcbuildnames.tmp
#obsolete - else
#obsolete - 	CYBUILDNAMES	=cybuildnames.tmp
#obsolete - 	UNIXBUILDNAMES	=unixbuildnames.tmp
#obsolete - 	CYSRCBUILDNAMES	=cysrcbuildnames.tmp
#obsolete - 	UNIXSRCBUILDNAMES=unixsrcbuildnames.tmp
#obsolete - endif

SOURCETARBASENAME=aubit4gl-src-$(AUBITVERSION)-$(AUBITBUILD)-$(COMPILEDATE).${ARCHEXT}
#obsolete - MANFILEBASENAME=aubit4gl-doc-$(AUBITVERSION)-$(AUBITBUILD)-$(COMPILEDATE).${ARCHEXT}
#obsolete - #FIXME: remove SOURCEZIPBASENAME
#obsolete - SOURCEZIPBASENAME=${SOURCETARBASENAME}

SOURCETARNAME	=$(SOURCE)/$(SOURCETARBASENAME)
#obsolete - #FIXME: remove SOURCEZIPNAME (and all duplicate functions)
#obsolete - SOURCEZIPNAME	=$(SOURCE)/$(SOURCEZIPBASENAME)
#obsolete - MANFILENAME     =$(SOURCE)/$(MANFILEBASENAME)
#obsolete -

## ==================================================================
##                    Define default target
## ==================================================================

ALL			+=Makefile settings rpc corecompile

ifeq "$(GTKBUILD)" "yes"
	ALL += gtkgui
endif

ALL +=test

## ==================================================================
##                              Targets
## ==================================================================

all: ${ALL}
	@echo " "
	@echo "Successfully compiled Aubit compiler default targets :"
	@echo "${ALL}."
	@echo "You MUST install it before you can use it - execute 'make install'."
	@echo "Thank you for using Aubit 4gl compiler"

log:
	@echo "Logging make process to make.log, please wait..."
	@${MAKE} ${MKNAME} ${BUGMAKEFLAGS} > make.log 2>&1
	@echo "make finished successfuly, see make.log for details."

corecompile: libs
	$(MAKE) -C compilers/4glc/rules
	$(MAKE) -C compilers/4glc
	$(MAKE) -C compilers/fcompile
	$(MAKE) -C compilers/menus
	$(MAKE) -C compilers/helpcompile
	$(MAKE) -C lib loadmap
	@echo Aubit 4gl compiler core is now compiled

libs:
	$(MAKE) -C lib
	$(MAKE) -C lib/libtui
	@echo Aubit 4gl core libraries are now compiled

gtkgui:
	$(MAKE) -C lib/libgui
	@echo Aubit 4gl compiler GTK GUI is now compiled

ide:
	$(MAKE) -C tools/ide
	$(MAKE) -C tools/ide install.aubit

## ==================================================================
##                              Perl compiler
## ==================================================================

perl: perl.compiler perl.lib test.perl

perl.compiler:
	${MAKE} ${MKNAME} -C compilers/4glc 4glc_perl PDFBUILD=no ${NOINCL_PARAM}
	@echo Aubit 4gl Perl-code generating version compiler created

perl.lib:
	cd lib/swig; sh domake
	@echo Aubit 4gl Perl-code libraries installed

test.perl:
	cd tools/test; 4glc_perl test_build.4gl
	cd tools/test; perl test_build.pl

## ==================================================================
##                              Make RPC
## ==================================================================

rpc:
	$(MAKE) ${MKNAME} ${BUGMAKEFLAGS} -C compilers/fcompile rpc
	$(MAKE) ${MKNAME} ${BUGMAKEFLAGS} -C compilers/menus rpc

clean.rpc:
	${RM} compilers/fcompile/form_x_xdr.c
	${RM} compilers/menus/menu_x_xdr.c
	${RM} compilers/fcompile/form_x.h
	${RM} compilers/menus/menu_x.h

## ------------------------------------------------------------------
##                       Cleanup Targets
## ------------------------------------------------------------------

#FIXME: "clean" should clean intermediate files resulting from compile, but will skip
#executables and objects that are needed for instalation. After "clean", it should
#still be possiblt to do "make install"
.PHONY : clean
clean:
	@echo FIXME: only cleanall works

clean.all: cleanall

#will clean EVERYTHING that is not source file from CVS
cleanall: clean.root clean.bin clean.etc clean.incl clean.docs clean.install clean.swig clean.project
	@echo Cleaning Aubit 4gl temporary compiler files and compiled objects...
	$(MAKE) ${MKNAME} -C lib clean
	$(MAKE) ${MKNAME} -C lib/libgui clean
	${MAKE} $(MKNAME) -C lib/libtui clean
	$(MAKE) ${MKNAME} -C lib/extra_libs/file clean
	$(MAKE) ${MKNAME} -C compilers/4glc/rules clean
	$(MAKE) ${MKNAME} -C compilers/4glc clean
	$(MAKE) ${MKNAME} -C compilers/fcompile clean
	$(MAKE) ${MKNAME} -C compilers/menus clean
	$(MAKE) ${MKNAME} -C compilers/helpcompile clean
	$(MAKE) ${MKNAME} -C tools/test clean
	$(MAKE) ${MKNAME} -C tools/test/gui clean
	$(MAKE) -C tools/test/db clean
	$(MAKE) ${MKNAME} -C tools/ide clean
	$(MAKE) ${MKNAME} -C tools/html clean
	$(MAKE) ${MKNAME} -C tools/jabber clean
	@echo Aubit 4gl compiler source tree is now clean

clean.config: clean.configure
clean.configure: clean.makefiles clean.settings
	${RM} config.log config.status incl/config.h docs/doxy/Doxyfile \
            etc/aubit-rpm.spec
#incl/a4gl-rules.mki

clean.settings:
	${RM} etc/a4glrc etc/aubitbuild.mk etc/aubitenv etc/aubitrc

clean.makefiles:
	${RM} compilers/4glc/Makefile
	${RM} compilers/4glc/rules/Makefile
	${RM} compilers/fcompile/Makefile
	${RM} compilers/helpcompile/Makefile
	${RM} compilers/menus/Makefile
	${RM} incl/Makefile-common
	${RM} lib/Makefile
	${RM} lib/libgui/Makefile
	${RM} lib/libpdf/Makefile
	${RM} lib/libsql/nosql/Makefile
	${RM} lib/libsql/esqlc/Makefile
	${RM} lib/libsql/odbc/Makefile
	${RM} lib/extra_libs/file/Makefile
	${RM} lib/libtui/Makefile
	${RM} tools/test/db/Makefile
	${RM} tools/test/lang/Makefile
	${RM} tools/test/regression/Makefile
	${RM} tools/test/db/Makefile
	${RM} tools/adbaccess/Makefile
	${RM} tools/adbload/Makefile
	${RM} tools/html/Makefile
	${RM} tools/ide/Makefile
	${RM} tools/jabber/Makefile
	${RM} tools/odbctest/Makefile
	${RM} tools/test/Makefile
	${RM} tools/test/gui/Makefile
	${RM} Makefile


clean.root:
	$(RM) *.bak *.BAK libincl .*.bak core cyrpc.flg
	${RM} debug.out
	${RM} *.err ${PLATFORMSTRING}*.txt
#We must not clean *.log when running make process to make.log:
	${RM} make.log commit.log rpmbuild.log
#we must not clean *.tmp because of unixbuildnames.tmp:
#	${RM} *.tmp
	${RM} aubit4gl.lsm aubitdownload-template.htm

#FIXME: move this to appropriate makefile:
	${RM} rpmbuild.log
	${RM} compilers/fcompile/fshow.glb
	${RM} compilers/fcompile/fshow.h
#FIXME: we no longer need this file:
	${RM} etc/configure


clean.bin:
	(cd bin;${RM} 4glc${EXE} fcompile${EXE} mcompile${EXE} mkmess${EXE} \
	mcompile-noodbc${EXE} loadmap${EXE} \
	*.bak ide${EXE} fcompile-noodbc${EXE} 4glc-noodbc${EXE} \
	4glc_perl${EXE} mdecompile${EXE} fdecompile${EXE} fdecompile-j${EXE} \
	aubit-config${EXE} fshow${EXE} \
	)

clean.etc:
	${RM} etc/*.bak etc/config/*.bak etc/aubit-auto.spec

clean.incl:
	${RM} incl/*.bak

clean.docs:
	rm -rf docs/doxy/html
	${RM} docs/doxy/*.bak
	${RM} docs/*.bak

clean.install:
	rm -rf install

clean.swig:
	@if [ -f lib/swig/?akefile ]; then \
		$(MAKE) ${MKNAME} -C lib/swig clean; \
    fi
	(cd lib/swig; ${RM} lib_wrap.c *.old *.bak aubit4gl_pl.pm)

clean.project:
	(cd tools/project; ${RM} *.bak)
	(cd tools/cygwin; ${RM} *.bak)


#Clean stuff that is lef over aubitbuild.sh:
clean.build:
	${RM} *.tgz *.htm *.html *.tmp



## ------------------------------------------------------------------
##                       Installation Targets: *NIX
## ------------------------------------------------------------------
#FIXME: this should use ${INSTALL}
#FIXME: install .a4glrc in $HOME too
#FIXME: do NOT overwrite .a4glrc and aubitenv!
#make icons for KDE and GNOME: to IDE, to manual

install: install.core install.example install.manual install.config \
		install.links install.aubitrc install.libs.links \
		install.makefile-install
#install.libs.conf
	
ifneq "${AUBITRCFILEEXISTS}" ""
	@echo " "
	@echo "WARNING: Configuration file aubitrc exists in ${AUBITETC}/aubitrc"
	@echo "====================== WILL NOT OVERWRITE ======================"
	@echo "use 'make install.aubitrc aubitrc=new' if you want to do that "
	@echo "Automatically created aubitrc placed in /tmp/aubitrc.tmp"
	@echo " "
endif
	@echo Aubit compiler installed to $(INSTALL_DIR)
#platform
#etc/aubit-auto.spec

install.core: install.tree install.gtk
	${CP} $(TOBIN) $(INSTALL_DIR)/bin
	chmod a+x $(INSTALL_DIR)/bin/*
	$(CP) $(TOROOT) $(INSTALL_DIR)
	$(CP) $(TOINCL) $(INSTALL_DIR)/incl
	$(CP) $(TOLIBCUI) $(INSTALL_DIR)/lib
ifneq "${COMSPEC}" ""
	$(CP) ${TOLIB_EXPORTLIB} $(INSTALL_DIR)/lib
endif
	@echo "#AUBIT_BIN_INSTALL is needed for make files and 4glpc to know they are not in Aubit compiler source code tree:" > /tmp/Makefile-common
	@echo "AUBIT_BIN_INSTALL=1" >> /tmp/Makefile-common
	@cat $(SOURCE)/incl/Makefile-common >> /tmp/Makefile-common
	@mv /tmp/Makefile-common $(INSTALL_DIR)/incl
	@echo Aubit 4gl core compiler files installed

install.gtk:
ifeq "${GTKBUILD}" "yes"
	$(CP) $(TOLIBGTK) $(INSTALL_DIR)/lib
ifneq "${COMSPEC}" ""
	$(CP) ${TOLIBGTK_EXPORTLIB} $(INSTALL_DIR)/lib
endif
endif

install.config:
	$(CP) ${TOETC} $(INSTALL_DIR)/etc
	@echo "Configuration examples installed to $(INSTALL_DIR)/etc"

install.example:
	$(CP) $(TOTEST) $(INSTALL_DIR)/tools/test
ifeq "${GTKBUILD}" "yes"
	$(CP) $(TOTESTGUI) $(INSTALL_DIR)/tools/test/gui
endif
	@echo Aubit 4gl compiler programming examples are now installed

install.manual:
	$(CP) $(TODOCS) $(INSTALL_DIR)/docs
#	$(CP) $(TODOCS2) $(INSTALL_DIR)/docs/manual/html
	@echo Aubit 4gl compiler manual is now installed

installide:
	${MAKE} ${MKNAME} -C tools/ide install.aubit
	@echo Aubit 4gl compiler IDE is now installed

packide:
	${CP} ${TOIDE} $(INSTALL_DIR)/IDE

installdrop:
	${RMDIR} $(INSTALL_DIR)

#install.tree.mkpath:
install.tree:
#	${MKPATH} $(INSTALL_DIR)
	${MKPATH} $(INSTALL_DIR)/bin
	${MKPATH} $(INSTALL_DIR)/lib
	${MKPATH} $(INSTALL_DIR)/etc
	${MKPATH} $(INSTALL_DIR)/incl
#	${MKPATH} $(INSTALL_DIR)/tools/ide
#	${MKPATH} $(INSTALL_DIR)/test
	${MKPATH} $(INSTALL_DIR)/tools/test/gui
	${MKPATH} $(INSTALL_DIR)/docs
#	${MKPATH} $(INSTALL_DIR)/docs/manual
#	${MKPATH} $(INSTALL_DIR)/docs/manual/html
	@echo "Aubit 4gl compiler instalation tree created"

install.links.source:
#this links bin programs to location of Aubit source code:
	${MKPATH} ${BIN_INSTALL_LINK}
	${LN_S} ${AUBITDIR}/bin/aubit-config ${BIN_INSTALL_LINK}/aubit-config
	${LN_S} ${AUBITDIR}/bin/aubit ${BIN_INSTALL_LINK}/aubit

install.makefile-install:
	${CP} etc/Makefile-install $(INSTALL_DIR)/Makefile
	${CP} incl/Makefile-install.mki $(INSTALL_DIR)/incl
	${CP} -r etc/config/ $(INSTALL_DIR)/etc
	${CP} etc/aubitrc.in $(INSTALL_DIR)/etc/aubitrc-bin.in
#Not all installations will have autoconf, and especially not version 2.5 or up
#we need to have already generated configure in CVS
#BUT-we better do this from main (root-source code) configure.in and use it
#for binar distribution too, with --with-bin switch
#	(cd etc; autoconf)
#	${CP} etc/configure $(INSTALL_DIR)
	${CP} configure $(INSTALL_DIR)
#all targets common to installing compiled source code, AND installing
#binary distributions are in here:
###################################
include incl/Makefile-install.mki
###################################

deinstall: deinstall.all

tarinstall: platform
#FIXME: check if it exists first
#	(cd $(PREFIX); tar -cvzf $(SOURCE)/$(TARNAME) * $(A4GLRC))
	(cd $(INSTALL_DIR); tar -cvzf $(SOURCE)/$(TARNAME) * )

createcleantar: installdrop installall tarinstall
	@echo "Aubit 4gl compiler binary disribution is now in $(SOURCE)/$(TARNAME)"


###################################
# Get sources from CVS
#cvs login script uses "expect" to supply my CVS password, and therefore
#will not be included here; but here is code for this script if you need it:
#Wrapper to make cvs password be non-interactive:
#--------------------------------
#!/usr/bin/expect -f
#spawn cvs login [lindex $argv 0]
#expect "CVS password:"
#send "mysecretpassword\r"
#expect eof
#--------------------------------
#obsolete - source.tar:
#obsolete - 	${RMDIR} $(INSTALL_DIR)
#obsolete - 	${MKPATH} $(INSTALL_DIR)
#obsolete - 	(cd $(INSTALL_DIR); autocvspasswd; cvs -z3 checkout $(AUBITCVSNAME))
#obsolete - 	(cd $(INSTALL_DIR)/$(AUBITCVSNAME); tar -cvzf $(SOURCETARNAME) * )

tar: clean.all
#COMPILE_DATE=20-01-2002
#TARGET=i586-pc-linux-gnu
	${RM} aubit4gl-src-${AUBIT_VERSION}.${AUBIT_BUILD}.tgz
	tar -cvzf aubit4gl-src-${AUBIT_VERSION}.${AUBIT_BUILD}.tgz *
	@echo "Aubit source tarball created"

#obsolete - source.tar.sf:
#obsolete - 	${RMDIR} $(INSTALL_DIR)
#obsolete - 	${MKPATH} $(INSTALL_DIR)
#obsolete - 	(export CVSROOT=${CVSROOTSF}; cd $(INSTALL_DIR); autosfcvsanonpasswd; cvs -z8 checkout $(AUBITCVSSFNAME))
#obsolete - 	(cd $(INSTALL_DIR)/$(AUBITCVSSFNAME); tar -cvzf $(SOURCETARNAME) * )

#obsolete - source.tar.location:
#obsolete - 	(cd $(SRCLOCATION); tar -cvzf $(SOURCETARNAME) * )
#obsolete - 	@echo $(SOURCETARNAME) created

#obsolete - source.tar.curr: SRCLOCATION=${AUBITDIR}
#obsolete - source.tar.curr: clean.all source.tar.location

#obsolete - man.tar.sf:
#use "cvs export" instead "cvs checkout" to get code without CVS directories
#	export CVS_RSH=
#obsolete - 	${RMDIR} $(INSTALL_DIR)
#obsolete - 	${MKPATH} $(INSTALL_DIR)
#obsolete - 	(export CVSROOT=${CVSROOTSF}; cd $(INSTALL_DIR); autosfcvsanonpasswd; cvs -z8 checkout $(AUBITCVSSFMANNAME))
#obsolete - 	(cd $(INSTALL_DIR)/$(AUBITCVSSFMANNAME); tar -cvzf $(MANFILENAME) * )

source.zip:
	${RMDIR} $(INSTALL_DIR)
	${MKPATH} $(INSTALL_DIR)
	(cd $(INSTALL_DIR); autocvspasswd; cvs -w checkout $(AUBITCVSNAME))
	(cd $(INSTALL_DIR)/$(AUBITCVSNAME); zip -r $(SOURCEZIPNAME) * )

#obsolete - source.zip.sf:
#obsolete - 	${RMDIR} $(INSTALL_DIR)
#obsolete - 	${MKPATH} $(INSTALL_DIR)
#obsolete - 	(cd $(INSTALL_DIR); autosfcvsanonpasswd; cvs -w -z8 checkout $(AUBITCVSSFNAME))
#obsolete - 	(cd $(INSTALL_DIR)/$(AUBITCVSSFNAME); zip -r $(SOURCEZIPNAME) * )

#obsolete - source.zip.location:
#obsolete - 	(cd $(SRCLOCATION); zip -r $(SOURCEZIPNAME) * )

#obsolete - source.tar.2download:
#obsolete - ifeq "$(USELOCALUPLOAD)" "1"
#obsolete - 	$(CP) $(SOURCETARNAME) $(FTPLOCATION)
#obsolete - endif
#obsolete - 	autosfscp $(SOURCETARNAME)
#obsolete - 	@if [ ! -f ${DLTMP1} ]; then \
#obsolete - 		${MAKE} ${MKNAME} getdlpage; \
#obsolete - 	fi
#obsolete - 	@sed -e "/^$(TEMPLATESRC)/s/$(TEMPLATESRC)/$(SOURCETARBASENAME)/" ${DLTMP1} > ${DLTMP2} ;
#obsolete - 	@mv ${DLTMP2} ${DLTMP1} ;
#obsolete - 	${MAKE} ${MKNAME} store.tar.dl.names TEMPLATESRC=$(TEMPLATESRC) SOURCETARBASENAME=$(SOURCETARBASENAME)
#obsolete - #	${MAKE} putdlpage
#obsolete -
#obsolete - source.zip.2download:
#obsolete - ifeq "$(USELOCALUPLOAD)" "1"
#obsolete - 	$(CP) $(SOURCEZIPNAME) $(FTPLOCATION)
#obsolete - endif
#obsolete - 	autosfscp $(SOURCEZIPNAME)
#obsolete - 	@if [ ! -f ${DLTMP1} ]; then \
#obsolete - 		${MAKE} ${MKNAME} getdlpage; \
#obsolete - 	fi
#obsolete - 	@sed -e "/^$(TEMPLATESRC)/s/$(TEMPLATESRC)/$(SOURCEZIPBASENAME)/" ${DLTMP1} > ${DLTMP2} ;
#obsolete - 	@mv ${DLTMP2} ${DLTMP1} ;
#obsolete - 	${MAKE} ${MKNAME} store.zip.dl.names TEMPLATESRC=$(TEMPLATESRC) SOURCEZIPBASENAME=$(SOURCEZIPBASENAME)
#obsolete - #	${MAKE} putdlpage
#obsolete -
#obsolete - store.tar.dl.names:
#obsolete - 	@echo 'sed -e "/^$(TEMPLATESRC)/s/$(TEMPLATESRC)/$(SOURCETARBASENAME)/" ${DLTMP1} > ${DLTMP2}'  > ${UNIXSRCBUILDNAMES}
#obsolete - 	@echo 'cp ${DLTMP2} ${DLTMP1}'  >> ${UNIXSRCBUILDNAMES}
#obsolete - ifeq "$(USELOCALUPLOAD)" "0"
#obsolete - 	autosfscp ${UNIXSRCBUILDNAMES}
#obsolete - endif
#obsolete -
#obsolete - store.zip.dl.names:
#obsolete - 	@echo 'sed -e "/^$(TEMPLATESRC)/s/$(TEMPLATESRC)/$(SOURCEZIPBASENAME)/" ${DLTMP1} > ${DLTMP2}' > ${CYSRCBUILDNAMES}
#obsolete - 	@echo 'cp ${DLTMP2} ${DLTMP1}' >> ${CYSRCBUILDNAMES}
#obsolete - ifeq "$(USELOCALUPLOAD)" "0"
#obsolete - 	autosfscp ${CYSRCBUILDNAMES}
#obsolete - endif
#obsolete -

## ------------------------------------------------------------------
##                Additional Installation Targets: Windows/CygWin
## ------------------------------------------------------------------

#obsolete - install.tree.cy:
#obsolete - 	@cd $(INSTALL_DIR); \
#obsolete - 	${MKPATH} $(INSTALL_DIR)/dll; \
#obsolete - 	${MKPATH} $(INSTALL_DIR)/extralibs;
#obsolete -
#obsolete - pack.cygwin:
#obsolete - 	${MAKE} ${MKNAME} installdrop INSTALL_DIR=${INSTALL_DIR}
#obsolete - 	${MAKE} ${MKNAME} install.tree INSTALL_DIR=${INSTALL_DIR}
#obsolete - 	${MAKE} ${MKNAME} install.tree.cy INSTALL_DIR=${INSTALL_DIR}
#obsolete - 	${MAKE} ${MKNAME} installx SOURCE=${CYSOURCE} INSTALL_DIR=${INSTALL_DIR} TOBIN="${CYTOBIN}" TOLIBGTK="${CYTOLIBGTK}"
#obsolete - 	${MAKE} ${MKNAME} install.example SOURCE=${CYSOURCE} INSTALL_DIR=${INSTALL_DIR}
#obsolete - #FIXME: we should pack compiled IDE with binary distro, not sources
#obsolete - 	${MAKE} ${MKNAME} packide SOURCE=${CYSOURCE} INSTALL_DIR=${INSTALL_DIR}
#obsolete - 	${MAKE} ${MKNAME} install.libs LIBTARGET1=${CYLIBTARGET1}
#obsolete - 	${MAKE} ${MKNAME} install.dll DLLTARGET=${CYDLLTARGET}
#obsolete - 	${MAKE} ${MKNAME} cygwin.runtime INSTALL_DIR=${INSTALL_DIR}
#obsolete - 	${MAKE} ${MKNAME} zip.install GUITYPE=GTK $(INSTALL_DIR) $(SOURCE)

#obsolete - cygwin.runtime.with.demo: cygwin.runtime cygwin.runtime.demo cygwin.zip.runtime

#FIXME: if this programs are not compiled, make will stop: cygwin.runtime.demo
#obsolete - cygwin.runtime: cygwin.runtime.tree
#obsolete - 	${CP} /bin/cygncurses?.dll $(INSTALL_DIR)/runtime/runtimelib
#obsolete - 	${CP} /bin/cygwin?.dll $(INSTALL_DIR)/runtime/runtimelib
#obsolete - 	${CP} /bin/cygform?.dll $(INSTALL_DIR)/runtime/runtimelib
#obsolete - 	${CP} /bin/cygpanel?.dll $(INSTALL_DIR)/runtime/runtimelib
#obsolete - 	${CP} ${DLLTARGET}/* $(INSTALL_DIR)/runtime/runtimelib
#obsolete - 	${CP} tools/cygwin/readme-runtime.html $(INSTALL_DIR)/runtime
#FIXME: At the moment, we are not making any .so or .dll on Windows
#	${CP} lib/*.so $(INSTALL_DIR)/runtime/runtimelib

#obsolete - cygwin.runtime.tree:
#obsolete - 	${MKPATH} $(INSTALL_DIR)/runtime
#obsolete - 	${MKPATH} $(INSTALL_DIR)/runtime/runtimelib
#obsolete - 	${MKPATH} $(INSTALL_DIR)/runtime/apps

#obsolete - cygwin.runtime.demo:
#obsolete - 	${MAKE} ${MKNAME} -C tools/test GTKBUILD=yes
#obsolete - #obsolete - 	${MAKE} ${MKNAME} -C tools/test/gui GTKBUILD=yes
#obsolete - 	cp ${CYSOURCE}/tools/test/*.exe $(INSTALL_DIR)/runtime/apps
#obsolete - 	cp ${CYSOURCE}/tools/test/gui/*.exe $(INSTALL_DIR)/runtime/apps
#obsolete - 	${CP} tools/cygwin/*.lnk.hide $(INSTALL_DIR)/runtime
#obsolete - 	${CP} tools/cygwin/unhide.bat $(INSTALL_DIR)/runtime

#if we unhide them before zip, zip will not find them:
unhide.lnk:
#	(cd $(INSTALL_DIR)/runtime; for afile in *.lnk.hide; do echo $$afile; done;)
#	(cd $(INSTALL_DIR)/runtime; for afile in *.lnk.hide; do echo `basename "$$afile" .hide`; done;)
	(cd $(INSTALL_DIR)/runtime; for afile in *.lnk.hide; do mv "$$afile" "`basename "$$afile" .hide`"; done;)

cygwin.zip.runtime:
	${RM} $(SOURCE)/$(ZIPRUNTIMENAME)
	(cd $(INSTALL_DIR)/runtime/; zip -r $(SOURCE)/$(ZIPRUNTIMENAME) * )


#obsolete - zip.install: platform
#obsolete - #FIXME: check if it exists first
#obsolete - 	${RM} $(SOURCE)/$(ZIPNAME)
#obsolete - 	${CP} $(PLATFORMINFO) $(INSTALL_DIR)
#obsolete - #	(cd $(INSTALL_DIR); zip -r $(SOURCE)/$(ZIPNAME) * $(A4GLRC))
#obsolete - 	(cd $(INSTALL_DIR); zip -r $(SOURCE)/$(ZIPNAME) * )
#obsolete - install.libs:
#obsolete - 	cp ${L4}/glib${LIBVER}.lib ${LIBTARGET1}
#obsolete - 	cp ${L1}/gdk${LIBVER}.lib ${LIBTARGET1}
#obsolete - 	cp ${L2}/gtk${LIBVER}.lib ${LIBTARGET1}
#obsolete - 	cp ${L4}/libglib${LIBVER}.a ${LIBTARGET1}/libglib.a
#obsolete - 	cp ${L1}/libgdk${LIBVER}.a ${LIBTARGET1}/libgdk.a
#obsolete - 	cp ${L2}/libgtk${LIBVER}.a ${LIBTARGET1}/libgtk.a
#obsolete - #preserve version numbers too:
#obsolete - 	cp ${L4}/libglib${LIBVER}.a ${LIBTARGET1}
#obsolete - 	cp ${L1}/libgdk${LIBVER}.a ${LIBTARGET1}
#obsolete - 	cp ${L2}/libgtk${LIBVER}.a ${LIBTARGET1}

#FIXME: want about -noodbc libs?
#	cp ${L5}/libUI_GTK.a ${LIBTARGET1}
#	cp ${L5}/libaclallgui.a ${LIBTARGET1}
#obsolete - 	cp ${L5}/libaclall.a ${LIBTARGET1}
#obsolete - 	cp ${L3}/librpclib.a ${LIBTARGET1}

#obsolete - install.dll:
#obsolete - 	cp ${L1}/gdk${LIBVER}.dll ${DLLTARGET}
#obsolete - 	cp ${L4}/glib${LIBVER}.dll ${DLLTARGET}
#obsolete - 	cp ${L6}/iconv${LIBVER}.dll ${DLLTARGET}
#obsolete - 	cp ${L2}/gtk${LIBVER}.dll ${DLLTARGET}
#obsolete - 	cp ${L4}/gmodule/gmodule${LIBVER}.dll ${DLLTARGET}
#obsolete - 	cp ${L7}/gnu-intl.dll ${DLLTARGET}

#obsolete - deinstall.libs:
#obsolete - 	${RM} /usr/lib/glib${LIBVER}.lib
#obsolete - 	${RM} /usr/lib/gdk${LIBVER}.lib
#obsolete - 	${RM} /usr/lib/gtk${LIBVER}.lib
#obsolete - 	${RM} /usr/lib/libglib${LIBVER}.a
#obsolete - 	${RM} /usr/lib/libgdk${LIBVER}.a
#obsolete - 	${RM} /usr/lib/libgtk${LIBVER}.a
#FIXME: what about -noodbc libs?
#	${RM} /usr/lib/libUI_GTK.a
#	${RM} /usr/lib/libaclallgui.a
#obsolete - 	${RM} /usr/lib/libaclall.a
#obsolete - 	${RM} /usr/lib/librpclib.a

#obsolete - deinstall.dll:
#obsolete - 	${RM} /bin/gdk${LIBVER}.dll ${DLLTARGET}
#obsolete - 	${RM} /bin/glib${LIBVER}.dll ${DLLTARGET}
#obsolete - 	${RM} /bin/iconv${LIBVER}.dll ${DLLTARGET}
#obsolete - 	${RM} /bin/gtk${LIBVER}.dll ${DLLTARGET}
#obsolete - 	${RM} /bin/gmodule/gmodule${LIBVER}.dll ${DLLTARGET}
#obsolete - 	${RM} /bin/gnu-intl.dll ${DLLTARGET}


#obsolete - install.bin.lib: install.run.exe
#obsolete - #we should not do this: this should be done in aubitenv:
#obsolete - #$PATH to $AUBITDIR/dll
#obsolete - #$LD_LIBRARY_PATH to $AUBITDIR/extralibs
#obsolete - 	cp dll/* /bin
#obsolete - 	cp extralibs/* /usr/lib
#obsolete - 	${MAKE} ${MKNAME} cygwin.install.message

#obsolete - install.run.exe:
#obsolete - 	${CP} bin/run.exe ${SYSTEMROOT}
#obsolete - 	${MAKE} ${MKNAME} cygwin.install.message

#obsolete - deinstall.bin.lib: deinstall.libs deinstall.dll
#obsolete - 	${RM} ${SYSTEMROOT}/run.exe

#obsolete - cygwin.install.message:
#obsolete - 	@echo "Don't forget to add"
#obsolete - 	@echo "C:\cygwin\bin;C:\cygwin${AUBITDIR}\bin;C:\cygwin${AUBITDIR}\dll"
#obsolete - 	@echo "to WINDOWS path."
#obsolete - 	@echo "Add AUBITGUI=gui to system environment to run in GUI mode"

pack.amake:
	${MKPATH} /tmp/pack_amake/bin
	${CP} bin/amake bin/amakeallo bin/amakeallf bin/genmake bin/prepmake /tmp/pack_amake/bin
	${MKPATH} /tmp/pack_amake/incl
	${CP} incl/*.mk incl/*.mki /tmp/pack_amake/incl
	echo "See HOWTO at https://sourceforge.net/docman/?group_id=32409" > /tmp/pack_amake/README.txt
	(cd /tmp/pack_amake; tar -cvzf $(SOURCE)/amake.tar.gz * )


## ------------------------------------------------------------------
##                       Binary distribution Targets
## ------------------------------------------------------------------
#For nightly builds, put "$AUBITDIR/bin/aubitbuild.sh" in corn
#

#	getdlpage in now in aubitbuild.sh, because source.zip needs it
allbindist: \
	clear.dl.names \
	${ALLBINDISTNAMES} \
	restore.dl.names \
	restore.src.dl.names \
	todownload \
	putdlpage
	@echo "All binary distributions built successfully and placed in FTP locattion"


all.win.bin.dist: \
	cy.clear.dl.names \
	cy-odbc32-gtk-nopdf \
    cygwin.runtime.with.demo \
	cy.restore.dl.names \
	cy.restore.src.dl.names \
	cy.todownload \
	putdlpage
	@echo "All win32 binary distributions built successfully and placed in FTP locattion"

#FIXME: we need to delete stuff in DL locations older then x days

#we cannot do mass upload here using autosfscp becaouse of bug in * files listing, so we need to do it
#for each individual package
todownload:
ifeq "$(USELOCALUPLOAD)" "1"
	$(CP) *.${ARCHEXT} $(FTPLOCATION)
	$(CP) ${PLATFORMSTRING}*.txt $(FTPLOCATION)
else
	@(for afile in *.${ARCHEXT}; do echo To move: "$$afile" ; done;)
	@(for afile in *.${ARCHEXT}; do autosfscp "$$afile" ; done;)
	@(for afile in ${PLATFORMSTRING}*.txt; do echo To move: "$$afile" ; done;)
	@(for afile in ${PLATFORMSTRING}*.txt; do autosfscp "$$afile" ; done;)
#	@echo "Network share drive is disabled"
endif

cy.todownload:
ifeq "$(USELOCALUPLOAD)" "1"
	$(CP) *.${ARCHEXT} $(FTPLOCATION)
	$(CP) ${PLATFORMSTRING}*.txt $(FTPLOCATION)
else
	@(for afile in *.${ARCHEXT}; do echo To move: "$$afile" ; done;)
	@(for afile in *.${ARCHEXT}; do autosfscp "$$afile" ; done;)
	@(for afile in ${PLATFORMSTRING}*.txt; do echo To move: "$$afile" ; done;)
	@(for afile in ${PLATFORMSTRING}*.txt; do autosfscp "$$afile" ; done;)
#	@echo "Network share drive is disabled"
endif


#Example of "autosfscp" script:
##!/usr/bin/expect -f
## wrapper to make cvs password be non-interactive
## username is passed as 1st arg, passwd as 2nd
#spawn scp -q $argv afalout@aubit4gl.sourceforge.net:/home/groups/a/au/aubit4gl/htdocs/files
#expect " password:"
#send "mysecretpassword\r"
#expect eof
bindist.to.sf.download:
	autosfscp $(SOURCE)/$(TARNAME)
	autosfscp $(SOURCE)/$(PLATFORMINFOFULL)

cy.bindist.to.sf.download:
	autosfscp $(SOURCE)/$(ZIPNAME)
	autosfscp $(SOURCE)/$(PLATFORMINFOFULL)


#FIXME: copy source tar and manual tar to download too? We can get it via jCVS servlet anyway...

cleantar:
	$(RM) *.${ARCHEXT}
	$(RM) *.${ARCHEXT}.txt

cleandownload:
ifeq "$(USELOCALUPLOAD)" "1"
	$(RM) $(FTPLOCATION)/*.${ARCHEXT}
	$(RM) $(FTPLOCATION)/${PLATFORMSTRING}*.txt
endif


#example of "autosfscpget" script:
#!/usr/bin/expect -f
#spawn scp -q afalout@aubit4gl.sourceforge.net:$argv .
#expect " password:"
#send "mysecretpassword\r"
#expect eof

getdlpage:
	${RM} ${DLTMP1} ${DLTMP2} ${TEMPLATEFILEBASE}
#	@cp $(TEMPLATEFILE) ${DLTMP1}
	${AUTOSFSCPGET} ${SCPPATH}/${TEMPLATEFILEBASE}
	@if [ -f ${TEMPLATEFILEBASE} ]; then \
		cp ${TEMPLATEFILEBASE} ${DLTMP1}; \
    else \
        ${MAKE} ${MKNAME} getdlpage; \
    fi
#NOTE: re-entrant call to getdlpage abowe is because on CygWin
#autosfscp can fail randomly


putdlpage:
ifeq "$(USELOCALUPLOAD)" "1"
	@if [ -f ${DLTMP1} ]; then \
		cp ${DLTMP1} $(DOWNLOADPAGE); \
        cp ${DLTMP1} $(DOWNLOADPAGEBASE); \
    else \
        echo "putdlpage: cannot find ${DLTMP1}" ; \
    fi
endif
	@if [ -f ${DLTMP1} ]; then \
		cp ${DLTMP1} $(DOWNLOADPAGEBASE); \
		autosfscp $(DOWNLOADPAGEBASE); \
    else \
        echo "putdlpage: cannot find ${DLTMP1}" ; \
    fi

#		rm -f ${DLTMP1} ${DLTMP2}; \

fix.dl.page: getdlpage restore.dl.names cy.restore.dl.names restore.src.dl.names cy.restore.src.dl.names putdlpage

#---------------------

downloadnames:
	@if [ ! -f ${DLTMP1} ]; then \
		${MAKE} ${MKNAME} getdlpage; \
	else \
		sed -e "/^$(TEMPLATENAME)/s/$(TEMPLATENAME)/$(TARNAME)/" ${DLTMP1} > ${DLTMP2} ; \
		sed -e "/^$(TEMPLATENAMEINFO)/s/$(TEMPLATENAMEINFO)/$(PLATFORMINFOFULL)/" ${DLTMP2} > ${DLTMP1} ; \
    fi

clear.dl.names:
#when $(USELOCALUPLOAD) is 0, this will remove loval file, is this OK?
	${RM} ${UNIXBUILDNAMES}

store.dl.names:
	@echo 'sed -e "/^$(TEMPLATENAME)/s/$(TEMPLATENAME)/$(TARNAME)/" ${DLTMP1} > ${DLTMP2}'  >> ${UNIXBUILDNAMES}
	@echo 'sed -e "/^$(TEMPLATENAMEINFO)/s/$(TEMPLATENAMEINFO)/$(PLATFORMINFOFULL)/" ${DLTMP2} > ${DLTMP1}'  >> ${UNIXBUILDNAMES}
ifeq "$(USELOCALUPLOAD)" "0"
	autosfscp ${UNIXBUILDNAMES}
endif


restore.dl.names:
ifeq "$(USELOCALUPLOAD)" "0"
	@if ! [ -f ${CYBUILDNAMES} ]; then \
		${AUTOSFSCPGET} ${SCPPATH}/${CYBUILDNAMES}; \
	fi
endif
	@if [ -f ${CYBUILDNAMES} ]; then \
		dos2unix ${CYBUILDNAMES}; \
		${SH} ${CYBUILDNAMES}; \
    else \
		echo "restore.dl.names: Cannot find ${CYBUILDNAMES}"; \
    fi

#---------------------

cy.downloadnames:
	@if [ ! -f ${DLTMP1} ]; then \
		${MAKE} ${MKNAME} getdlpage; \
	else \
		sed -e "/^$(TEMPLATENAME)/s/$(TEMPLATENAME)/$(TARNAME)/" ${DLTMP1} > ${DLTMP2} ; \
		sed -e "/^$(TEMPLATENAMEINFO)/s/$(TEMPLATENAMEINFO)/$(PLATFORMINFOFULL)/" ${DLTMP2} > ${DLTMP1} ; \
    fi

cy.clear.dl.names:
	${RM} ${CYBUILDNAMES}

cy.store.dl.names:
	@echo 'sed -e "/^$(TEMPLATENAME)/s/$(TEMPLATENAME)/$(TARNAME)/" ${DLTMP1} > ${DLTMP2}'  >> ${CYBUILDNAMES}
	@echo 'sed -e "/^$(TEMPLATENAMEINFO)/s/$(TEMPLATENAMEINFO)/$(PLATFORMINFOFULL)/" ${DLTMP2} > ${DLTMP1}'  >> ${CYBUILDNAMES}
ifeq "$(USELOCALUPLOAD)" "0"
	autosfscp ${CYBUILDNAMES}
endif



cy.restore.dl.names:
ifeq "$(USELOCALUPLOAD)" "0"
	@if ! [ -f ${UNIXBUILDNAMES} ]; then \
		${AUTOSFSCPGET} ${SCPPATH}/${UNIXBUILDNAMES}; \
    fi
#else
#when USELOCALUPLOAD=1, filename ${UNIXBUILDNAMES} includes path
endif
	@if [ -f ${UNIXBUILDNAMES} ]; then \
		${SH} ${UNIXBUILDNAMES}; \
	else\
		echo "cy.restore.dl.names: Cannot find ${UNIXBUILDNAMES}"; \
	fi

#----------------------

cy.restore.src.dl.names:
ifeq "$(USELOCALUPLOAD)" "0"
	@if ! [ -f ${UNIXSRCBUILDNAMES} ]; then \
		${AUTOSFSCPGET} ${SCPPATH}/${UNIXSRCBUILDNAMES}; \
    fi
endif
	@if [ -f ${UNIXSRCBUILDNAMES} ]; then \
		${SH} ${UNIXSRCBUILDNAMES}; \
    else \
		echo "cy.restore.src.dl.names: Cannot find ${UNIXSRCBUILDNAMES}"; \
	fi

restore.src.dl.names:
ifeq "$(USELOCALUPLOAD)" "0"
	@if ! [ -f ${CYSRCBUILDNAMES} ]; then \
		${AUTOSFSCPGET} ${SCPPATH}/${CYSRCBUILDNAMES} ; \
    fi
endif
	@if [ -f ${CYSRCBUILDNAMES} ]; then \
		dos2unix ${CYSRCBUILDNAMES}; \
		${SH} ${CYSRCBUILDNAMES}; \
    else \
		echo "restore.src.dl.names: Cannot find ${CYSRCBUILDNAMES}"; \
	fi

#FIXME: do I need to do make cleanall before each build?
#FIXME: can I compile without ODBC, so we have general purpose compiler
#without any dependencies?

######################
#Binary build targets:

iodbc-gtk-pdf:
	${MAKE} ${MKNAME} PDFBUILD=yes 	GTKBUILD=yes 	ODBC=iodbc 	step.two

iodbc-nogtk-pdf:
	${MAKE} ${MKNAME} PDFBUILD=yes 	GTKBUILD=no 	ODBC=iodbc  step.two

iodbc-gtk-nopdf:
	${MAKE} ${MKNAME} PDFBUILD=no 	GTKBUILD=yes 	ODBC=iodbc  step.two

iodbc-nogtk-nopdf:
	${MAKE} ${MKNAME} PDFBUILD=no 	GTKBUILD=no 	ODBC=iodbc  step.two

unixodbc-gtk-pdf:
	${MAKE} ${MKNAME} PDFBUILD=yes 	GTKBUILD=yes 	ODBC=unix 	step.two

unixodbc-nogtk-pdf:
	${MAKE} ${MKNAME} PDFBUILD=yes 	GTKBUILD=no 	ODBC=unix 	step.two

unixodbc-gtk-nopdf:
	${MAKE} ${MKNAME} PDFBUILD=no 	GTKBUILD=yes 	ODBC=unix 	step.two

unixodbc-nogtk-nopdf:
	${MAKE} ${MKNAME} PDFBUILD=no 	GTKBUILD=no 	ODBC=unix 	step.two

cy-odbc32-gtk-nopdf:
	${MAKE} ${MKNAME} PDFBUILD=no 	GTKBUILD=yes 	ODBC=odbc32 cy.step.two

step.two: \
	settings \
	cleanall \
	all \
	installdrop \
	installall \
	tarinstall \
	downloadnames \
	store.dl.names \
	bindist.to.sf.download
	@echo "UNIX build ${PDFTYPE}-${GUITYPE}-${ODBCMANAGER} build finished successfuly."

cy.step.two: \
	settings \
	cleanall \
	all \
	pack.cygwin \
	cy.downloadnames \
	cy.store.dl.names \
	cy.bindist.to.sf.download
	@echo "CygWin build ${PDFTYPE}-${GUITYPE}-${ODBCMANAGER} build finished successfuly."


## ------------------------------------------------------------------
##                      RPM packaging
## ------------------------------------------------------------------

#You may need to create the following directories to make a build tree:
#	BUILD is the directory where all building occurs by RPM. You don't
#		have to do your test building anywhere in particular, but this is
#		where RPM will do it's building.
#	SOURCES is the directory where you should put your original source
#		tar files and your patches. This is where RPM will look by default.
#	SPECS is the directory where all spec files should go.
#	RPMS is where RPM will put all binary RPMs when built.
#	SRPMS is where all source RPMs will be put.


#will fail, bacause automaticaly generates spec file fill not have
#"configure" step, and AUBITDIR will be wrong
rpm.auto:
ifneq "@RPM@" "no"
ifneq "@AUTOSPEC@" "no"
	${MAKE} rpm.build.auto
else
	@echo "RPM autospec tool where not detected on your system. Try 'make rpm.preset'"
endif
else
	@echo "RPM tools where not detected on your system."
endif

#this will make rpm form autoconf-ed etc/aubit-rpm.conf
rpm:
ifneq "@RPM@" ""
	${MAKE} rpm.build.preset
else
	@echo "RPM tools where not detected on your system."
endif

rpm.build.auto: etc/aubit-auto.spec
rpm.build.auto: RPMCONFFILE:=${AUBITDIR}/etc/aubit-auto.spec
rpm.build.auto: SRCTMP:=${RPMBUILDROOT}/SOURCES/${NAMEVERBLD}.tar.gz
rpm.build.auto: rpm.build

rpm.build.preset: RPMCONFFILE:=${AUBITDIR}/etc/aubit-rpm.spec
#rpm.build.preset: SRCTMP:=${RPMBUILDROOT}/SOURCES/${SOURCETARBASENAME}
rpm.build.preset: SRCTMP:=${RPMBUILDROOT}/SOURCES/${NAMEVERBLD}.tar.gz
rpm.build.preset: rpm.build

#rpm.build: AUBITDIR=${RPMBUILDROOT}/BUILD/aubit4gl-0.20
#rpm.build: PATH=${RPMBUILDROOT}/BUILD/${NAMEVERBLD}/bin:${PATH}
rpm.build:
#RPM insists to have source code in ${RPMBUILDROOT}/SOURCES/ before it will
#build it, and only then make rpm from both of them (src and bin RPM)
#	echo xxx ${SOURCETARBASENAME} ZZZZ ${SRCTMP} xxx
ifeq "${RPM}" "new"
	${RM} ${SRCTMP}
	${RM} /tmp/${NAMEVERBLD}/${SOURCETARBASENAME}
endif
	@if [ ! -f ${SRCTMP} ]; then \
		echo "No ${SRCTMP}, making it..."; \
		if [ ! -f /tmp/${NAMEVERBLD}/${SOURCETARBASENAME} ]; then \
			echo "No /tmp/${NAMEVERBLD}/${SOURCETARBASENAME}, making it..."; \
			${MAKE} ${MKNAME} clean.all > /dev/null; \
			${RMDIR} /tmp/${NAMEVERBLD}; \
			${MKPATH} /tmp/${NAMEVERBLD}; \
			${LN_S} ${AUBITDIR} /tmp/${NAMEVERBLD}/${NAMEVERBLD}; \
			echo "Creating /tmp/${NAMEVERBLD}/$(SOURCETARNAME) from ${NAMEVERBLD}/ ..."; \
			(cd /tmp/${NAMEVERBLD}; tar -cvzf $(SOURCETARNAME) ${NAMEVERBLD}/* > /dev/null); \
		else \
            echo "Have /tmp/${NAMEVERBLD}/${SOURCETARBASENAME}"; \
		fi; \
		${CP} /tmp/${NAMEVERBLD}/${SOURCETARBASENAME} ${SRCTMP} ; \
	else \
        echo "Have ${SRCTMP}"; \
		echo "use RPM=new on make line to force refresh"; \
	fi
#	(export AUBITDIR=${RPMBUILDROOT}/BUILD/${NAMEVERBLD}; export PATH=${RPMBUILDROOT}/BUILD/${NAMEVERBLD}/bin:${PATH}; rpm -ba ${RPMCONFFILE} > rpmbuild.log 2>&1)
	rpm -ba ${RPMCONFFILE} > rpmbuild.log 2>&1
	@echo "See rpmbuild.log for details"

rpm.1: RPMCONFFILE:=${AUBITDIR}/etc/aubit-auto.spec
#rpm.1: LOGFILE=> rpmbuild.log 2>&1
rpm.1:
	rpm -ba ${RPMCONFFILE} ${LOGFILE}

#       -bl    Do a "list check".  The "%files" section  from  the
#              spec file is macro expanded, and checks are made to
#              verify that each file exists.


#       --short-circuit
#              Skip  straight  to  specified  stage  (ie, skip all
#              stages leading up to the  specified  stage).   Only
#              valid with -bc and -bi.


#p means just run the prep section of the specfile.
#l is a list check that does some checks on %files.
#c do a prep and compile. This is useful when you are unsure of whether
#	your source will build at all. It seems useless because you might want
#	to just keep playing with the source itself until it builds and then
#	start using RPM, but once you become accustomed to using RPM you will
#	find instances when you will use it.
#i do a prep, compile, and install.
#b prep, compile, install, and build a binary package only.
#a build it all (both source and binary packages).

#--short-circuit will skip straight to a specified stage (can only be used with c and i).
#--clean removes the build tree when done.
#--keep-temps will keep all the temp files and scripts that were made in /tmp. You can actually see what files were created in /tmp using the -v option.
#--test does not execute any real stages, but does keep-temp.

#automatically create .spec file for RPM build:
etc/aubit-auto.spec: aubit4gl.lsm
	${MAKE} ${MKNAME} -n install | autospec -i -d -n ${NAMEVERBLD} -g Development/Languages > ${AUBITDIR}/etc/aubit-auto.spec

#make -n = Print the commands that would be executed, but do not execute them.
#autospec:
#  -d     Don't look for documentation  files  like  `README'
#              and  `BUGS' in the current directory to add them to
#              the spec file list.




build.diff.patch:
	diff -uNr dirname.orig dirname > ../SOURCES/dirname-linux.patch


#Create Linux Software Map (.lsm) used by autospec, see http://www.execpc.com/lsm/
aubit4gl.lsm: OUTFILE=aubit4gl.lsm
aubit4gl.lsm:
	@echo Begin4 > ${OUTFILE}
	@echo Title: Aubit 4gl compiler >> ${OUTFILE}
	@echo Version: ${AUBITVERSION}.${AUBITBUILD} >> ${OUTFILE}
	@echo Entered-date: ${COMPILEDATE} >> ${OUTFILE}
	@echo Description: Compiler for x4gl programming language >> ${OUTFILE}
	@echo Keywords: compiler 4gl database sql gui >> ${OUTFILE}
	@echo Author: Mike Aubury >> ${OUTFILE}
	@echo Maintained-by: Aubit development team >> ${OUTFILE}
	@echo Primary-site: http://aubit4gl.sourceforge.net >> ${OUTFILE}
	@echo Alternate-site: http://www.falout.com >> ${OUTFILE}
	@echo Original-site: http://www.aubit.com >> ${OUTFILE}
	@echo Platforms: POSIX Win32 >> ${OUTFILE}
	@echo Copying-policy: GNU GPL LGPL >> ${OUTFILE}
	@echo End >> ${OUTFILE}
	@echo >> ${OUTFILE}
	@echo >> ${OUTFILE}
	@echo Note: >> ${OUTFILE}
	@echo send this file to 'lsm@execpc.com' with the subject 'add'. >> ${OUTFILE}


## ------------------------------------------------------------------
##            DoxyGen doccumentation creation
## ------------------------------------------------------------------

#create Doxy documentation
doxy:
ifneq "@DOXYGEN@" "no"
	${MAKE} doxy.make
ifneq "@WWW_DOCUMENT_ROOT@" ""
	${MAKE} doxy.install.www
endif
ifneq "@CGI_DIR@" ""
	${MAKE} doxy.install.search
endif
	@echo To use it, open file 'docs/doxy/html/index.html' in your web browser
else
	@echo "Sorry DOXYGEN not installed"
endif

doxy.make:
	rm -rf docs/doxy/html
	doxygen docs/doxy/Doxyfile
	
#Now copy the file
#
#     /opt/aubit/aubit4glsrc/docs/doxy/html/doxysearch.cgi
#
#to the directory where the CGI binaries are located and don't forget to run
#
#     /opt/aubit/aubit4glsrc/docs/doxy/html/installdox
#
#to replace any dummy links.

	@echo DoxyGen doccumentation created and placed in docs/doxy/html

doxy.install.www:
	rm -rf @WWW_DOCUMENT_ROOT@/projects/Aubit4GL/doxy/html
	cp -r docs/doxy/html @WWW_DOCUMENT_ROOT@/projects/Aubit4GL/doxy/html
	cd @WWW_DOCUMENT_ROOT@/projects/Aubit4GL/doxy/html; doxytag -s search.idx
	@echo DoxyGen doccumentation installed in web server path :
	@echo @WWW_DOCUMENT_ROOT@/projects/Aubit4GL/doxy/html
	@echo Point your web browser to @WWW_HOST_NAME@/projects/Aubit4GL/doxy/html/index.html

doxy.install.search:
	cp docs/doxy/html/doxysearch.cgi @CGI_DIR@



## ------------------------------------------------------------------
##                       Other Targets
## ------------------------------------------------------------------

#This will increase build number; use it before releasing compiled binaries.
#Edit project/version file manually to increase version number; when
#you do, reset build counter to zero.
build:
	@echo Current versions before build number increase:
	@echo AUBITVERSION = ${AUBITVERSION} AUBITBUILD = ${AUBITBUILD}
	@chmod a+x tools/project/mkproject
	(cd tools/project; ${SH} mkproject -increase)
	@echo After build number increase:
	@echo "AUBITVERSION = `cat $(SOURCE)/tools/project/version` AUBITBUILD = `cat $(SOURCE)/tools/project/build`"

commit.build: build commit.build.step2
commit.build.step2: BUILDNO=$(shell cat $(SOURCE)/tools/project/build)
commit.build.step2:
	@cvs commit -m "commit.build ${BULDNO}" > commit.log
	@echo "Build ${BUILDNO} Commit finished. See file './commit.log'"

demo:
	${MAKE} ${MKNAME} -C tools/test
	@echo Aubit 4gl compiler examples are now compiled


allreadwrite:
	chmod -R a+rw *

help:
	@echo
	@echo This is Aubit 4gl compiler makefile help
	@echo
	@echo Usage: "make [targets] [option=value] ..."
	@echo
	@echo For more help use:
	@echo "  make help.options"
	@echo "  make help.targets"
	@echo

help.targets:
	@echo
	@echo Targets:
	@echo
	@echo "  all (same as just "make") - compile the Aubit 4gl compiler"
	@echo "  gtkgui - compile only GTK libraries"
	@echo "  clean - delete and temp and intermittent files, but not targets"
	@echo "  cleanall - delete ALL compiled object and temp files that where"
	@echo "          created with make. This will result in clan source code"
	@echo "          tree, as exported form CVS"
	@echo "  installall - install.tree install install.example install.manual"
	@echo "  createcleantar - installdrop installall tarinstall"
	@echo "  install - installs Aubit 4gl compiler in installation tree"
	@echo "  install.example - installs 4gl examples in installation tree"
	@echo "  install.manual - installs manual in installation tree"
	@echo "  installdrop - DELETES installation tree. WARNING: uses ${RMDIR}"
	@echo "  install.tree - creates installation tree"
	@echo "  tarinstall - creates ${ARCHEXT} file from installation tree"
	@echo "  demo - compile 4gl exampe code in tools/test/ and tools/test/gui/"
	@echo "  log - log default target make process to ./make.log"
	@echo "  settings - show how is makefile configured"
	@echo "  platform - dump settings and current build data to $(PLATFORMINFO)"
	@echo

help.options:
	@echo
	@echo "Options: (first option is default)"
	@echo "  PDFBUILD=(no/yes) NOTE: Must have PDF lib installed"
	@echo "  GTKBUILD=(yes/no) NOTE: Must have GTK lib installed"
	@echo "  JABBERBUILD=(yes/no) NOTE: Must have ikemel lib installed"
	@echo "  ODBC=iodbc/unix (ignored on Windows) NOTE: Must have ODBC lib installed"
	@echo "  CYGWIN=mno-cygwin : compile to monolith CygWin target (Windows only)"
	@echo "  PREFIX= where to install binaries, default is $PREFIX"
	@echo
	@echo

#--------------------- debugging -----------------------------

savesettings: OUT = $(PLATFORMINFO)
savesettings: newfile settings.common

#no stdout on CygWin :-(
#settings: OUT="/dev/stdout"
settings: OUT=  $(PLATFORMINFO)
settings: blankfile settings.common
	@cat $(PLATFORMINFO)

blankfile:
	@echo "" > ${OUT}

newfile:
	@echo "This file contains version info of compile platform" > ${OUT}

settings.common:
#	@echo "OUT = " ${OUT}
	@echo "make invoked with flags : ${MAKEFLAGS}" >> ${OUT}
	@echo "make invoked in : ${PWD}" >> ${OUT}
	@echo "Reading from root makefile variables:" >> ${OUT}
	@echo -------------- Optional libraries ---------------- >> ${OUT}
	@echo "GTKBUILD        = ${GTKBUILD}" >> ${OUT}
	@echo "PDFBUILD        = ${PDFBUILD}" >> ${OUT}
	@echo "JABBERBUILD     = ${JABBERBUILD}" >> ${OUT}
	@echo -------------- ODBC settings --------------------- >> ${OUT}
	@echo "HAVE_UNIXODBC   = ${HAVE_UNIXODBC}" >> ${OUT}
	@echo "HAVE_IODBC      = ${HAVE_IODBC}" >> ${OUT}
	@echo "ODBC_LINK       = ${ODBC_LINK}" >> ${OUT}
	@echo "ODBC            = ${ODBC}" >> ${OUT}
	@echo "ODBCLIBDIR      = ${ODBCLIBDIR}" >> ${OUT}
	@echo "ODBC_LIB_DIR    = ${ODBC_LIB_DIR}" >> ${OUT}
	@echo "ODBC_LIB_NAME   = ${ODBC_LIB_NAME}" >> ${OUT}
	@echo -------------- C Compiler settings --------------- >> ${OUT}
	@echo "CFLAGS          = ${CFLAGS}" >> ${OUT}
	@echo "LD_LIBRARY_PATH = ${LD_LIBRARY_PATH}" >> ${OUT}
	@echo -------------------------------------------------- >> ${OUT}
	@echo COMPILEDATE=$(COMPILEDATE) AUBITVERSION=$(AUBITVERSION) AUBITBUILD=$(AUBITBUILD) >> ${OUT}
	@echo AUBITDIR=${AUBITDIR} OS=$(TARGET) >> ${OUT}
	@echo -------------------------------------------------- >> ${OUT}

show.platform: OUT="/tmp/showplatform"
show.platform: platform.common
	cat /tmp/showplatform

platform: OUT = $(PLATFORMINFO)
platform: savesettings platform.common
	@cp $(OUT) $(INSTALL_DIR)
	@cp $(OUT) ${PLATFORMINFOFULL}
	@echo "platform: See result in ${OUT}"
	@echo "Also copied to $(INSTALL_DIR)/$(OUT) and ${PLATFORMINFOFULL}"


platform.common:
#	@echo OUT = $(OUT)
	@echo "----- Compile date: ---------" >> $(OUT)
	@date >> $(OUT)
	@echo "----- Compile host  ---------" >> $(OUT)
	@uname -a >> $(OUT)
	@${GTKCONFIGTEXT}  >> $(OUT)
	@${GTKCONFIGCMD} >> $(OUT)
	@echo "----- ${CC} -v ---------" >> $(OUT)
	@${CC} -v  >> $(OUT) 2>&1
	@if [ -f "bin/4glc" ]; then \
		echo "----- all shared libraries used by 4glc ---------" >> $(OUT) ; \
		ls -al bin/4glc  >> $(OUT) ; \
		${LDDCMD} bin/4glc${EXE} >> $(OUT) ; \
    fi
	@if [ -f "tools/test/test_build" ]; then \
		echo "----- all shared libraries used by compiled 4gl program ---------" >> $(OUT) ; \
		ls -al tools/test/test_build  >> $(OUT) ; \
		${LDDCMD} tools/test/test_build${EXE}  >> $(OUT) ; \
    fi
	@echo "-------------------- EOF -----------------------" >> $(OUT)

#FIXME: info needed for binary disrto: kernel version, ODBC lib version, PDF version,...


debug.filenames:
	@echo ${TEMPLATENAME} >> ${OUT}
	@echo ${TEMPLATENAMETXT} >> ${OUT}
	@echo ${TEMPLATESRC} >> ${OUT}
	@echo ${TEMPLATENAMEINFO} >> ${OUT}
	@echo ${PLATFORMINFO} >> ${OUT}
	@echo ${PLATFORMINFOFULL} >> ${OUT}


# ------------------------------ testing ----------------------------


lclint:
	(echo " " > $(LCLINTLOG))
#Warning! This will override CFLAGS in lib makefile!!!
	$(MAKE) ${MKNAME} -C lib lclint PDF=no >> $(LCLINTLOGCMD)
	$(MAKE) ${MKNAME} -C compilers/4glc/rules lclint LCLINTFLAGS=$(LCLINTFLAGS) >> $(LCLINTLOGCMD)
	@echo "see $(LCLINTLOG) for results"



1:
	rm -f lib/libgui/assist.c
	echo ${GTKGUI}
	echo ${AUBITDIR}
	make ${MKNAME} -C lib/libgui assist.c
	ls lib/libgui/assist.c

2:
	echo ${AUBITVERSION}
	echo ${AUBITBUILD}


showbug: xsettings
	${MAKE} XWZ=1 xsettings
xsettings:
	@echo "make invoked with flags : xx${MAKEFLAGS}xx"

old.2.in:
	${CP} Makefile.old Makefile.in
	${CP} compilers/4glc/Makefile.old compilers/4glc/Makefile.in
	${CP} compilers/4glc/rules/Makefile.old compilers/4glc/rules/Makefile.in
	${CP} compilers/fcompile/Makefile.old compilers/fcompile/Makefile.in
	${CP} compilers/helpcompile/Makefile.old compilers/helpcompile/Makefile.in
	${CP} compilers/menus/Makefile.old compilers/menus/Makefile.in
	${CP} lib/Makefile.old lib/Makefile.in
	${CP} lib/libgui/Makefile.old lib/libgui/Makefile.in
	${CP} lib/libpdf/Makefile.old lib/libpdf/Makefile.in
	${CP} lib/libsql/nosql/Makefile.old lib/libsql/nosql/Makefile.in
	${CP} lib/libsql/odbc/Makefile.old lib/libsql/odbc/Makefile.in
	${CP} tools/adbaccess/Makefile.old tools/adbaccess/Makefile.in
	${CP} tools/adbload/Makefile.old tools/adbload/Makefile.in
	${CP} tools/html/Makefile.old tools/html/Makefile.in
	${CP} tools/ide/Makefile.old tools/ide/Makefile.in
	${CP} tools/jabber/Makefile.old tools/jabber/Makefile.in
	${CP} tools/odbctest/Makefile.old tools/odbctest/Makefile.in
	${CP} tools/test/Makefile.old tools/test/Makefile.in
	${CP} tools/test/gui/Makefile.old tools/test/gui/Makefile.in

settings.rc:
	@echo
	@echo "A1 [/etc/opt/aubit4gl/aubitrc] =${A1}"
	@echo "A2 [/opt/aubit4gl/etc/aubitrc] =${A2}"
	@echo "A3 [../etc/aubitrc]            =${A3}"
	@echo "A4 [etc/aubitrc]               =${A4}"
	@echo "A5 [~/.aubit4gl/aubitrc]       =${A5}"
	@echo "A6 [./.aubitrc]                =${A6}"
	@echo "A7 ['$A4GL_INIFILE' ]            =${A7}"
	@echo

find.dup.c.files:
	find . -name "*.c" -exec basename {} \; | sort | uniq -c | grep -v " 1"


configure:
	autoconf --localdir=etc/config

test.install:
	cd $(INSTALL_DIR)/tools/test
	${MAKE}
	./hello
	cd gui
	${MAKE}
	./hello_gui

test.full:
	${MAKE} clean.all
	./configure
	${MAKE}
	${MAKE} install
	${MAKE} test.install


refresh.noyacc:
	${CP} compilers/4glc/rules/generated/y.tab.c tools/no_yacc/cygwin/compilers/4glc/rules/generated
	${CP} compilers/4glc/rules/generated/y.tab.h tools/no_yacc/cygwin/compilers/4glc/rules/generated
	${CP} compilers/fcompile/lex.yy.c tools/no_yacc/cygwin/compilers/fcompile
	${CP} compilers/fcompile/y.tab.c tools/no_yacc/cygwin/compilers/fcompile
	${CP} compilers/menus/lex.yy.c tools/no_yacc/cygwin/compilers/menus
	${CP} compilers/menus/y.tab.c tools/no_yacc/cygwin/compilers/menus


## ---------------------------- EOF ----------------------------------

