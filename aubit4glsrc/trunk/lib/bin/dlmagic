#!/bin/sh

##########################################################################
#
#This script is used to create API C source file for Aubit libraraies to be loaded
#at run-time using dlopen() function call.
#
##########################################################################


if [ $# -lt 1 -o "$1" = "--help" ]
then
	echo "Creates run-time loadable library API definition source code "
    echo " "
	echo "Usage:   dlmagic <SpecFile> [<APIName>] [<EnvVar>] > <APIname>.c"
	echo "  SpecFile - contains specifications for the API"
	echo "  APIName - API name (will be overwritten by LIBRARY tag if declared"
	echo "      in SpecFile)"
	echo "  EnvVar - Environment variable to read (will be overwritten by"
	echo "      VARIABLE tag if declared in the SpecFile)"
    echo " "
    echo "Example: "
    echo "  dlmagic sqlapi.spec SQL SQLTYPE > API_SQL.c "
    echo " "
	echo "SpecFile file format:"
	echo "  func-name param-type param-name ... -> returns"
	echo "  Any line beginning with a * is a comment"
	echo "  Any line beginning with a # is included in the output Eg #define #include etc"
    echo " "
    echo "Example input File :"
    echo "	LIBRARY TEST"
    echo "	VARIABLE VTEST"
    echo "	* This is a comment - Note - there are no spaces for void* int* etc."
    echo "	pdf_rep_print void* rep,int a,int s,int right_margin -> int*"
    echo "	disp_fields int n int attr ... -> int"
    echo " "

	exit 0
fi


lib=$2
env=$3

if grep LIBRARY $1 > /dev/null
then
	lib=`awk '/^LIBRARY /{print $2}' $1`
fi

if grep VARIABLE $1 > /dev/null
then
	env=`awk '/^VARIABLE /{print $2}' $1`
fi
echo "//Library=$lib env=$env"

awk -v lib="$lib" -v env="$env" '

BEGIN {
FS="[ 	,]"
print "/** lib=" lib " env=" env
print "* @file"
print "* File definition"
print "*"
print "* @todo Add Doxygen comments to file"
print "* @todo Take the prototypes here declared. See if the functions are static"
print "* or to be externally seen"
print "* @todo Doxygen comments to add to functions"
print "*/"
print "/******************************************************************************"
print "* (c) 1997-2002 Aubit Computing Ltd."
print "*"
print "*"
print "*******************************************************************************/"
print "#include <stdio.h>"
print ""
print "#include \"a4gl_dbform.h\""
print "#include \"a4gl_report.h\""
print "#include \"a4gl_debug.h\""
print "#include \"a4gl_stack.h\""
print ""
print "static void *libptr=0;"
print "static int (*func)();"
print "static double (*func_d)();"
print "void *find_func(void *p,char *s);"
print "void *find_func_allow_missing(void *p,char *s);"
print ""
print "/**"
print " * Library init function."
print " *"
print " * @todo : explain ussage and parameters."
print " * @return ."
print " */"
print ""
print "int A4GL" lib "_initlib (void) {"
print "   libptr=(void *)dl_openlibrary(\"" lib "\",acl_getenv(\"" env "\"));"
print "   if (libptr==0) {"
print "      exitwith(\"Unable to open " $lib " library...\");"
print "      return 0;"
print "   }"
print "   func=find_func_allow_missing(libptr,\"A4GL" lib "_initlib\");"
print ""
print "   if (func)"
print "      return func();"
print "   else"
print "      return 1;"
print "}"
print ""
print ""
}
/^LIBRARY / {next}
/^VARIABLE / {next}
/^#/ {print
	next
}
/^\*/ {next}
/^$/ {next}
/^[ 	]*$/ {next}
{
fname=$1
rtype="void"

c=0
for (a=2;a<=NF;a++) {
param_type[c]=$a

if (param_type[c]=="->") {
	param_type[c]=""
	a++
	rtype=$a
	break
}

if (param_type[c]=="...") {
	param_name[c]=""
	a++
	c++
	break
}


a++
param_name[c]=$a
c++;
}


print ""
print "/**"
print " * API call function for xyz ."
print " *"
print " * @todo : explain ussage and parameters."
print " * @param xyz Explain me..."
print " * @return xyz Explain me..."
print " */"
print ""

printf rtype " " lib "API_" fname "("
va_start=""
args=""
for (b=0;b<c;b++) {
	printf("%s %s",param_type[b],param_name[b]);
	if (param_type[b]=="...") {
		va_start=last;
		args=args ",&ap"
	}
	else {
		args=args "," param_name[b]
	}
	last=param_name[b]
	if (b<c-1) {
		printf(",");
	}
}
args=substr(args,2)
print ") {"
if (va_start!="") {print "va_list ap;"}

print "   if (libptr==0) A4GL" lib "_initlib();"
print "   func=find_func(libptr,\"" fname "\");"
if (va_start!="") {
	print "   va_start(ap," va_start ");"
}

if (rtype=="void") 
	print "   func(" args ");"
else
	print "   return func(" args ");"


print "}"
print ""

}' < $1


exit

