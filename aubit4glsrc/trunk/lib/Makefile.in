# +----------------------------------------------------------------------+
# | Aubit 4gl Language Compiler Version $.0   lib makefile				 |
# +----------------------------------------------------------------------+
# | Copyright (c) 2000-1 Aubit Development Team (See Credits file)       |
# +----------------------------------------------------------------------+
# | This program is free software; you can redistribute it and/or modify |
# | it under the terms of one of the following licenses:                 |
# |                                                                      |
# |  A) the GNU General Public License as published by the Free Software |
# |     Foundation; either version 2 of the License, or (at your option) |
# |     any later version.                                               |
# |                                                                      |
# |  B) the Aubit License as published by the Aubit Development Team and |
# |     included in the distribution in the file: LICENSE                |
# |                                                                      |
# | This program is distributed in the hope that it will be useful,      |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of       |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        |
# | GNU General Public License for more details.                         |
# |                                                                      |
# | You should have received a copy of both licenses referred to here.   |
# | If you did not, or have any questions about Aubit licensing, please  |
# | contact afalout@ihug.co.nz                                           |
# +----------------------------------------------------------------------+

#
# $Id: Makefile.in,v 1.39 2002-03-27 11:57:03 afalout Exp $
#

#All stuff common to more then one Aubit compiler make file is there:
include ../incl/Makefile-common
override NOINCL=0

## ==================================================================
##                              Source files
## ==================================================================

CMODS_PROJECT	=project.c
GUI_TUI			=gui_tui.o
GUI_GTK			=gui_gtk.o
GUI_SRC         =ui.c
CMODS_NOSQL		=libsql/odbc/nosql.c
CMODS_ODBCSQL   =libsql/odbc/sql.c
CMODS_ODBCEX    =libsql/odbc/sqlex.c
CMODS_DLSQL		=dlsql.c
CMODS_CONFIG	=aubit-config.c
CMODS_RESOURCE	=resource.c
#CMODS_NORPC		=rpc_norpc.c
#CMODS_RPC		=rpc_client.c rpc_server.c rpc_stack_clnt.c rpc_svc.c \
#				rpc_stack_xdr.c ../compilers/fcompile/form_x_xdr.c


#In alphabetical order:
COMMONSRC= \
	array.c \
	bogus.c builtin.c builtin_d.c \
	calldll.c conv.c colours.c curslib.c \
	data_if.c dates.c dmy.c debug.c \
	err.c error.c errfile.c extfile.c \
	fglwrap.c funcs_d.c fields.c \
	gtime.c gtrim.c gui_io.c gui.c \
	helper.c \
	io.c iarray.c interval.c \
	keys.c \
	load.c \
	match.c \
	newpanels.c \
	others.c \
	pointers.c prompt.c \
	read_dty.c readform.c readforms.c report.c rexp2.c ${CMODS_RESOURCE} \
	screen.c sleep.c stack.c string.c \
	translate.c

#SEPARATE_RPC=1
#ifeq "${SEPARATE_RPC}" "1"
	CMODSNOSQL 			=${COMMONSRC}
#else
#	ifeq "@HAVE_RPCLIB@" "0"
#		CMODSNOSQL 		=${COMMONSRC} ${CMODS_NORPC}
#	else
#		CMODSNOSQL 		=${COMMONSRC} ${CMODS_RPC}
#	endif
#endif

CMODS_ODBC			=${CMODS_ODBCSQL} ${CMODS_ODBCEX}
OBJS_NOSQL			=${CMODS_NOSQL:.c=.o}
#OBJS_RPC			=${CMODS_RPC:.c=.o}
#OBJS_NORPC			=${CMODS_NORPC:.c=.o}
CMODS 				=${CMODSNOSQL} ${CMODS_DLSQL}
OBJS				=${CMODS:.c=.o} ${CMODS_PROJECT:.c=.o}

## ==================================================================
##                              Options
## ==================================================================

ALL 				=aubit-config libPDF_NOPDF${SO_EXT} libSQL_noodbc${SO_EXT}
#libaclall.a
#ALL_GUI				=libaclallgui.a
#LDFLAGS				=-Map mapfile
4GLPC               =../bin/4glpc
4GLPCFLAGS			=-verbose -nogtk

ifdef COMSPEC
#   LDFLAGS			+=-lc
	ALL				+=dlllibRPC_NORPC dllaclshared

	ifneq "@HAVE_RPCLIB@" "0"
		ALL			+=dlllibRPC_SUNRPC
    endif
else
    ALL				+=libaclshared${SO_EXT} libRPC_NORPC${SO_EXT}
	ifneq "@HAVE_RPCLIB@" "0"
		ALL			+=libRPC_SUNRPC${SO_EXT}
    endif
endif

#This must NOT be += because it would place affitional parameters AFTER
#existing parameters already in CFLAGS: we must not do this, because if
#specific path is needed to RPClib, it MUST be BEFORE other potenitially
#conflicting paths:
CFLAGS				:=@RPCLIB_INCLUDE@ @RPCLIB_LFLAGS@ -I../compilers/fcompile -Ilibincl ${CFLAGS}

ifneq "@IFMX_ESQLC@" "no"
	ALL 		+=libSQL_esql${SO_EXT}
endif


ifdef COMSPEC
	ALL			+=libSQL_odbc32${SO_EXT}
else
	ifeq "$(HAVE_IODBC)" "yes"
	    ALL		+=libSQL_iodbc${SO_EXT}
    endif

	ifeq "$(HAVE_UNIXODBC)" "yes"
		ALL		+=libSQL_unixodbc${SO_EXT}
    endif

	ifneq "@HAVE_IFXODBC@" "no"
	    ALL		+=libSQL_ifxodbc${SO_EXT}
	endif

	ifneq "@HAVE_PGODBC@" "no"
		ALL		+=libSQL_pgodbc${SO_EXT}
	endif
endif

ifeq "$(PDFBUILD)" "yes"
	ALL 			+=libPDF_PDF${SO_EXT}
    PDF_LIBNAME     =-lPDF_PDF
    AUBIT_PDFLIBNAME=-Llibpdf
else
    PDF_LIBNAME     =-lPDF_NOPDF
endif

#cyclical dependency: I need SUNRPC to make libaclall, but I need aclall to make RPCLIB!
#ifneq "@HAVE_RPCLIB@" "0"
#	AUBIT_RPCLIBNAME=-lRPC_SUNRPC
#else
	AUBIT_RPCLIBNAME=-lRPC_NORPC
#endif

## ==================================================================
##                              Targets
## ==================================================================

all: ${ALL}
	@echo "Default targets (${ALL}) built successfully."

all_gui: ${ALL_GUI}
	@echo "Default GUI targets (${ALL_GUI}) built successfully."

aubit-config: ${CMODS_CONFIG} ${CMODS_RESOURCE}
	${CC} -I./libincl -o $@ $^
	cp $@ ../bin

libaclall.a : $(OBJS) ${GUI_TUI}
#	-ldl -lm should be linked here, not in 4glpc with executable?
	ar rc $@ $^
	ranlib $@
#	${LD} -static -rdynamic -o $@ $^ -ldl -lm

libaclshared.so : $(OBJS) ${GUI_TUI}
#	-ldl -lm should be linked here, not in 4glpc with executable?
	${LD} ${SO_LDFLAGS} -o $@ $^ -ldl -lm
#-Map  mapfile

#libRPC_SUNRPC.so: ${OBJS_RPC}
#	${LD} ${SO_LDFLAGS} -o $@ $^

#libRPC_NORPC.so: ${OBJS_NORPC}
#	${LD} ${SO_LDFLAGS} -o $@ $^

## ==================================================================
##                       Targets in sub-makefiles
## ==================================================================

libPDF_PDF.so:
	${MAKE} -C libpdf $(MKNAME) $@

libPDF_NOPDF.so:
	${MAKE} -C libpdf $(MKNAME) $@

libSQL_noodbc.so:
	${MAKE} -C libsql/nosql nosql.so

libSQL_iodbc.so:
	${MAKE} -C libsql/odbc iodbc

libSQL_unixodbc.so:
	${MAKE} -C libsql/odbc unixodbc

libSQL_esql${SO_EXT}:
	${MAKE} -C libsql/esqlc

libSQL_ifxodbc.so:
	${MAKE} -C libsql/odbc ifxodbc

libSQL_pgodbc.so:
	${MAKE} -C libsql/odbc pgodbc

libRPC_SUNRPC.so:
	${MAKE} -C librpc/sun_rpc libRPC_SUNRPC.so

libRPC_NORPC.so:
	${MAKE} -C librpc/sun_rpc libRPC_NORPC.so

dlllibRPC_SUNRPC:
	${MAKE} -C librpc/sun_rpc dlllibRPC_SUNRPC

dlllibRPC_NORPC:
	${MAKE} -C librpc/sun_rpc dlllibRPC_NORPC

## ==================================================================
##                       Windows 32 DLL Targets
## ==================================================================

.PHONY : dllaclshared
dllaclshared : $(OBJS) ${GUI_TUI}
	${MAKE} libaclshared.dll DLLOBJS="$^" DLL_LDLIBS="${AUBIT_RPCLIBNAME} ${AUBIT_PDFLIBNAME}" DLL_LDFLAGS="@RPCLIB_LFLAGS@ ${PDF_LIBNAME} -L."
#$RPCLIB_NAME

libSQL_noodbc.dll:
	${MAKE} -C libsql/nosql nosql.dll

libSQL_odbc32.dll:
	${MAKE} -C libsql/odbc odbc32

libPDF_NOPDF.dll:
	${MAKE} -C libpdf $(MKNAME) NOPDF.dll

libgtk4gl.dll:
	${MAKE} -C libgui

#dlllibRPC_SUNRPC: ${CMODS_RPC}
#	${MAKE} libRPC_SUNRPC.dll DLLOBJS="$^" DLL_LDLIBS="${AUBIT_PDFLIBNAME} -laclshared" DLL_LDFLAGS="@RPCLIB_LFLAGS@ @RPCLIB_INCLUDE@ ${RPCLIB_NAME} ${PDF_LIBNAME} -L. -Ilibincl -I../compilers/fcompile"

#dlllibRPC_NORPC: ${CMODS_NORPC}
#	${MAKE} libRPC_NORPC.dll DLLOBJS="$^" DLL_LDLIBS="${AUBIT_PDFLIBNAME} " DLL_LDFLAGS="@RPCLIB_INCLUDE@ ${PDF_LIBNAME} -L. -Ilibincl -I../compilers/fcompile"

## ==================================================================
##                             Sub Targets
## ==================================================================

gui_tui.o: ${GUI_SRC}
	${CC} -c $(CFLAGS) $^ -o $@

gui_gtk.o: ${GUI_SRC}
	${CC} -c $(CFLAGS) -DUSE_GTK $^ -o $@

loadmap:
	${SH} ${4GLPC} ${4GLPCFLAGS} -nopdf loadmap.4gl -o $@
	cp $@${EXE} ../bin

ci: $(CMODS)
	ci -l  $^

project.o: generated/${CMODS_PROJECT}
	${CC} -c -o $@ $^

generated/project.c:
	(cd ../tools/project; ${SH} mkproject)

generated/tmperrs.h :
	${SH} bin/mkerrors

## ==================================================================
##                        Dependencies
## ==================================================================

error.c : generated/tmperrs.h
array.o: array.c ../compilers/fcompile/form_x_xdr.c

## ==================================================================
##                        Clean Targets
## ==================================================================

clean : clean.generated clean.libsql clean.libpdf clean.libincl clean.librpc
	${RM} $(OBJS) $(OBJS_DEBUG) menu_x.h menu_x_xdr.c
	${RM} form_x_xdr.c form_x.h project.c aubit-config
	${RM} loadmap loadmap.c loadmap.h core
	${RM} *.out *.glb *.so *.a  *.o  *.bak *.exe *.dll *.stackdump *.err
	${RM} *.base *.exp libaclshared.def libRPC_NORPC.def libaclsharedgui.def libRPC_SUNRPC.def


clean.generated:
	${RM} generated/errdefs generated/tmperrs.h
	${RM} generated/project.c generated/project.o

clean.all: clean
	${MAKE} -C libgui clean
	${MAKE} -C libtui clean

clean.libincl:
	${RM} libincl/*.bak

clean.libsql:
	${MAKE} -C libsql/nosql clean
	${MAKE} -C libsql/odbc clean
	${MAKE} -C libsql/esqlc clean

clean.libpdf:
	${MAKE} -C libpdf clean

clean.librpc:
	${MAKE} -C librpc/sun_rpc clean


## ==================================================================
##                         Other Targets
## ==================================================================

lclint: $(CMODS)
	-lclint -weak $(CFLAGS) $(CMODS) > lclint.log 2>&1
	@echo "see lclint.log for results"

#----------------------------------- EOF -------------------------------





