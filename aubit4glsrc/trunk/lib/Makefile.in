# +----------------------------------------------------------------------+
# | Aubit 4gl Language Compiler Version $.0   lib makefile				 |
# +----------------------------------------------------------------------+
# | Copyright (c) 2000-1 Aubit Development Team (See Credits file)       |
# +----------------------------------------------------------------------+
# | This program is free software; you can redistribute it and/or modify |
# | it under the terms of one of the following licenses:                 |
# |                                                                      |
# |  A) the GNU General Public License as published by the Free Software |
# |     Foundation; either version 2 of the License, or (at your option) |
# |     any later version.                                               |
# |                                                                      |
# |  B) the Aubit License as published by the Aubit Development Team and |
# |     included in the distribution in the file: LICENSE                |
# |                                                                      |
# | This program is distributed in the hope that it will be useful,      |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of       |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        |
# | GNU General Public License for more details.                         |
# |                                                                      |
# | You should have received a copy of both licenses referred to here.   |
# | If you did not, or have any questions about Aubit licensing, please  |
# | contact afalout@ihug.co.nz                                           |
# +----------------------------------------------------------------------+

#
# $Id: Makefile.in,v 1.46 2002-04-15 00:22:57 afalout Exp $
#

#All stuff common to more then one Aubit compiler make file is there:
include ../incl/Makefile-common
override NOINCL=0

## ==================================================================
##                              Source files
## ==================================================================

CMODS_PROJECT	=project.c
GUI_TUI			=gui_tui.o
GUI_GTK			=gui_gtk.o
GUI_SRC         =ui.c
#CMODS_NOSQL	=libsql/odbc/nosql.c
#CMODS_ODBCSQL  =libsql/odbc/sql.c
#CMODS_ODBCEX   =libsql/odbc/sqlex.c
CMODS_DLSQL		=dlsql.c
CMODS_CONFIG	=aubit-config.c
CMODS_RESOURCE	=resource.c
#CMODS_NORPC		=rpc_norpc.c
#CMODS_RPC		=rpc_client.c rpc_server.c rpc_stack_clnt.c rpc_svc.c \
#				rpc_stack_xdr.c ../compilers/fcompile/form_x_xdr.c

#require XDR frunctions, part of Sun RPClib:
CMODS_XDR		=../compilers/fcompile/form_x_xdr.c

#In alphabetical order:
COMMONSRC= \
	array.c \
	bogus.c builtin.c builtin_d.c \
	calldll.c conv.c colours.c curslib.c \
	data_if.c dates.c dmy.c debug.c \
	err.c error.c errfile.c extfile.c extend_rep.c\
	fglwrap.c funcs_d.c fields.c \
	gtime.c gtrim.c gui_io.c gui.c \
	helper.c \
	io.c iarray.c interval.c \
	keys.c \
	load.c \
	match.c \
	newpanels.c \
	others.c \
	pointers.c prompt.c \
	rpc.c read_dty.c readform.c readforms.c report.c rexp2.c ${CMODS_RESOURCE} \
	screen.c sleep.c stack.c string.c \
	translate.c

ifeq "@HAVE_RPCLIB@" "0"
	CFLAGS 		+=-DNO_XDR
else
	COMMONSRC   +=${CMODS_XDR}
endif



#SEPARATE_RPC=1
#ifeq "${SEPARATE_RPC}" "1"
	CMODSNOSQL 			=${COMMONSRC}
#else
#	ifeq "@HAVE_RPCLIB@" "0"
#		CMODSNOSQL 		=${COMMONSRC} ${CMODS_NORPC}
#	else
#		CMODSNOSQL 		=${COMMONSRC} ${CMODS_RPC}
#	endif
#endif

#CMODS_ODBC			=${CMODS_ODBCSQL} ${CMODS_ODBCEX}
#OBJS_NOSQL			=${CMODS_NOSQL:.c=.o}
#OBJS_RPC			=${CMODS_RPC:.c=.o}
#OBJS_NORPC			=${CMODS_NORPC:.c=.o}
CMODS 				=${CMODSNOSQL} ${CMODS_DLSQL}
OBJS				=${CMODS:.c=.o} ${CMODS_PROJECT:.c=.o}

## ==================================================================
##                              Options
## ==================================================================

ALL 				=aubit-config libEXREPORT_NOPDF${SO_EXT}
#libaubit4gl.a
#LDFLAGS				=-Map mapfile
4GLPC               =../bin/4glpc
4GLPCFLAGS			=-verbose -nogtk

ifdef COMSPEC
#   LDFLAGS			+=-lc
	ALL				+=dlllibRPC_NORPC dllaubit4gl libSQL_noodbc${SO_EXT}

	ifneq "@HAVE_RPCLIB@" "0"
		ALL			+=dlllibRPC_XDR
    endif

	ifneq "@XML_RPC@" "no"
		ALL			+=dlllibRPC_XMLRPC
    endif

else
    ALL				+=libaubit4gl${SO_EXT} libRPC_NORPC${SO_EXT} libSQL_noodbc${SO_EXT}
	ifneq "@HAVE_RPCLIB@" "0"
		ALL			+=libRPC_XDR${SO_EXT}
    endif

	ifneq "@XML_RPC@" "no"
		ALL			+=libRPC_XMLRPC${SO_EXT}
    endif
endif

#This must NOT be += because it would place affitional parameters AFTER
#existing parameters already in CFLAGS: we must not do this, because if
#specific path is needed to RPClib, it MUST be BEFORE other potenitially
#conflicting paths:
CFLAGS				:=@RPCLIB_INCLUDE@ @RPCLIB_LFLAGS@ -I../compilers/fcompile -Ilibincl ${CFLAGS}

ifneq "@IFMX_ESQLC@" "no"
	ALL 		+=libSQL_esql${SO_EXT}
endif


ifdef COMSPEC
	ALL			+=libSQL_odbc32${SO_EXT}
else
	ifeq "$(HAVE_IODBC)" "yes"
	    ALL		+=libSQL_iodbc${SO_EXT}
    endif

	ifeq "$(HAVE_UNIXODBC)" "yes"
		ALL		+=libSQL_unixodbc${SO_EXT}
    endif

	ifneq "@HAVE_IFXODBC@" "no"
	    ALL		+=libSQL_ifxodbc${SO_EXT}
	endif

	ifneq "@HAVE_PGODBC@" "no"
		ALL		+=libSQL_pgodbc${SO_EXT}
	endif
endif

ifeq "$(PDFBUILD)" "yes"
	ALL 			+=libEXREPORT_PDF${SO_EXT}
endif
    #PDF_LIBNAME     =-lPDF_PDF
    #AUBIT_PDFLIBNAME=-Llibpdf
#else
    #PDF_LIBNAME     =-lPDF_NOPDF
#endif

#cyclical dependency: I need XDR to make libaubit4gl, but I need libaubit4gl to make RPCLIB!
#ifneq "@HAVE_RPCLIB@" "0"
#	AUBIT_RPCLIBNAME=-lRPC_XDR
#else
	AUBIT_RPCLIBNAME=-lRPC_NORPC
#endif

## RPC type and XDR are not the same thing. RPC type represents Remote
#Procedure Call in Aubit, that can be Sun RPC or XML-RPC (at the moment),
#but regardless of that, XDR functions (also conatained in Sun RPC libraries)
#are needed by forms and menus functionality, and without it user would not
#ba able to compile or open forms and menus, since they compiled output
#file format is outpudte in XDR format for portability:

## ==================================================================
##                              Targets
## ==================================================================

all: note ${ALL}
	@echo "Default targets (${ALL}) built successfully."

note:
	@echo "Building: ${ALL}"

all_gui: ${ALL_GUI}
	@echo "Default GUI targets (${ALL_GUI}) built successfully."

aubit-config: ${CMODS_CONFIG} ${CMODS_RESOURCE}
	${CC} ${CFLAGS} -Ilibincl -o $@ $^
	cp $@ ../bin

libaubit4gl.a : $(OBJS) ${GUI_TUI}
#	-ldl -lm should be linked here, not in 4glpc with executable?
	ar rc $@ $^
	ranlib $@
#	${LD} -static -rdynamic -o $@ $^ -ldl -lm

libaubit4gl.so : $(OBJS) ${GUI_TUI}
#	-ldl -lm should be linked here, not in 4glpc with executable?
#IMPORTANT- xdr_ functions are NOT in -lrpcsvc. On Linux, they are in -lc
	${LD} ${SO_LDFLAGS} -o $@ $^ -ldl -lm
#	@RPCLIB_NAME@
#-Map  mapfile



## ==================================================================
##                       Windows 32 DLL Targets
## ==================================================================

.PHONY : dllaubit4gl
dllaubit4gl : $(OBJS) ${GUI_TUI}
	${MAKE} libaubit4gl.dll DLLOBJS="$^" DLL_LDLIBS="${AUBIT_RPCLIBNAME} ${AUBIT_PDFLIBNAME}" DLL_LDFLAGS="@RPCLIB_LFLAGS@ -L."
#$RPCLIB_NAME

#libaubit4gl.def: $(OBJS) ${GUI_TUI}
#	dlltool --export-all --output-def $@ $^

#we need to make export library before we can make actuall dll, becaus eof cyclical dependencies
#between libSQL_xxx.dll and libaubit4gl.dll, since there can be no unresilved symols at link
#time on Windows when mailing dll:
#libaubit4gl.dll.a: $(OBJS) ${GUI_TUI}
#	dlltool --output-exp $@ $^

libSQL_noodbc.dll:
	${MAKE} -C libsql/nosql nosql.dll

libSQL_odbc32.dll:
	${MAKE} -C libsql/odbc odbc32

libEXREPORT_NOPDF.dll:
	${MAKE} -C libpdf $(MKNAME) NOPDF.dll

libgtk4gl.dll:
	${MAKE} -C libgui

## ==================================================================
##                             Sub Targets
## ==================================================================

gui_tui.o: ${GUI_SRC}
	${CC} ${CFLAGS} -c $(CFLAGS) $^ -o $@

gui_gtk.o: ${GUI_SRC}
	${CC} ${CFLAGS}-c $(CFLAGS) -DUSE_GTK $^ -o $@

loadmap:
	${SH} ${4GLPC} ${4GLPCFLAGS} -nopdf loadmap.4gl -o $@
	cp $@${EXE} ../bin

ci: $(CMODS)
	ci -l  $^

project.o: generated/${CMODS_PROJECT}
	${CC} ${CFLAGS} -c -o $@ $^

generated/project.c:
	(cd ../tools/project; ${SH} mkproject)

generated/tmperrs.h :
	${SH} bin/mkerrors

../compilers/fcompile/form_x_xdr.c:
	${MAKE} -C ../compilers/fcompile rpc

## ==================================================================
##                        Dependencies
## ==================================================================

error.c : generated/tmperrs.h
array.o: array.c ../compilers/fcompile/form_x_xdr.c

## ==================================================================
##                       Targets in sub-makefiles
## ==================================================================

libEXREPORT_PDF.so:
	${MAKE} -C libpdf $(MKNAME) $@

libEXREPORT_NOPDF.so:
	${MAKE} -C libpdf $(MKNAME) $@

libSQL_noodbc.so:
	${MAKE} -C libsql/nosql nosql.so

libSQL_iodbc.so:
	${MAKE} -C libsql/odbc iodbc

libSQL_unixodbc.so:
	${MAKE} -C libsql/odbc unixodbc

libSQL_esql${SO_EXT}:
	${MAKE} -C libsql/esqlc

libSQL_ifxodbc.so:
	${MAKE} -C libsql/odbc ifxodbc

libSQL_pgodbc.so:
	${MAKE} -C libsql/odbc pgodbc

libRPC_XDR.so:
	${MAKE} -C librpc/sun_rpc libRPC_XDR.so

libRPC_NORPC.so:
	${MAKE} -C librpc/sun_rpc libRPC_NORPC.so

libRPC_XMLRPC.so:
	${MAKE} -C librpc/xml_rpc libRPC_XMLRPC.so

dlllibRPC_XDR:
	${MAKE} -C librpc/sun_rpc dlllibRPC_XDR

dlllibRPC_NORPC:
	${MAKE} -C librpc/sun_rpc dlllibRPC_NORPC

dlllibRPC_XMLRPC:
	${MAKE} -C librpc/xml_rpc dlllibRPC_XMLRPC

## ==================================================================
##                        Clean Targets
## ==================================================================

clean : clean.generated clean.libsql clean.libpdf clean.libincl clean.librpc
	${RM} $(OBJS) $(OBJS_DEBUG) menu_x.h menu_x_xdr.c
	${RM} form_x_xdr.c form_x.h project.c aubit-config
	${RM} loadmap loadmap.c loadmap.h core
	${RM} *.out *.glb *.so *.a  *.o  *.bak *.exe *.dll *.stackdump *.err
	${RM} *.base *.exp libaubit4gl.def


clean.generated:
	${RM} generated/errdefs generated/tmperrs.h
	${RM} generated/project.c generated/project.o

clean.all: clean
	${MAKE} -C libgui clean
	${MAKE} -C libtui clean

clean.libincl:
	${RM} libincl/*.bak

clean.libsql:
	${MAKE} -C libsql/nosql clean
	${MAKE} -C libsql/odbc clean
	${MAKE} -C libsql/esqlc clean

clean.libpdf:
	${MAKE} -C libpdf clean

clean.librpc:
	${MAKE} -C librpc/sun_rpc clean
	${MAKE} -C librpc/xml_rpc clean

## ==================================================================
##                         Other Targets
## ==================================================================

lclint: $(CMODS)
	-lclint -weak $(CFLAGS) $(CMODS) > lclint.log 2>&1
	@echo "see lclint.log for results"

#----------------------------------- EOF -------------------------------





