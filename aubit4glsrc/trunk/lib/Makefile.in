# +----------------------------------------------------------------------+
# | Aubit 4gl Language Compiler Version $.0   lib makefile				 |
# +----------------------------------------------------------------------+
# | Copyright (c) 2000-1 Aubit Development Team (See Credits file)       |
# +----------------------------------------------------------------------+
# | This program is free software; you can redistribute it and/or modify |
# | it under the terms of one of the following licenses:                 |
# |                                                                      |
# |  A) the GNU General Public License as published by the Free Software |
# |     Foundation; either version 2 of the License, or (at your option) |
# |     any later version.                                               |
# |                                                                      |
# |  B) the Aubit License as published by the Aubit Development Team and |
# |     included in the distribution in the file: LICENSE                |
# |                                                                      |
# | This program is distributed in the hope that it will be useful,      |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of       |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        |
# | GNU General Public License for more details.                         |
# |                                                                      |
# | You should have received a copy of both licenses referred to here.   |
# | If you did not, or have any questions about Aubit licensing, please  |
# | contact afalout@ihug.co.nz                                           |
# +----------------------------------------------------------------------+

#
# $Id: Makefile.in,v 1.34 2002-03-21 01:29:16 afalout Exp $
#

#All stuff common to more then one Aubit compiler make file is there:
include ../incl/Makefile-common
override NOINCL=0

## ==================================================================
##                              Source files
## ==================================================================

CMODS_PROJECT	=project.c
GUI_TUI			=gui_tui.o
GUI_GTK			=gui_gtk.o
GUI_SRC         =ui.c
CMODS_NOSQL		=libsql/odbc/nosql.c
CMODS_ODBCSQL   =libsql/odbc/sql.c
CMODS_ODBCEX    =libsql/odbc/sqlex.c
CMODS_DLSQL		=dlsql.c
CMODS_CONFIG	=aubit-config.c
CMODS_RESOURCE	=resource.c

#FIXME: create libRPC_RPC.so and libRPC_NORPC.so:
CMODS_RPC		=rpc_client.c rpc_server.c rpc_stack_clnt.c rpc_svc.c rpc_stack_xdr.c \
					../compilers/fcompile/form_x_xdr.c
CMODS_NORPC		=rpc_norpc.c

COMMONSRC= \
	array.c \
	gui.c \
	debug.c keys.c \
	extfile.c \
	bogus.c builtin.c builtin_d.c \
	calldll.c conv.c colours.c curslib.c \
	data_if.c dates.c dmy.c \
	err.c error.c errfile.c \
	fglwrap.c funcs_d.c fields.c \
	gtime.c gtrim.c gui_io.c \
	helper.c \
	io.c iarray.c interval.c \
	load.c \
	match.c \
	newpanels.c \
	others.c \
	pointers.c prompt.c \
	read_dty.c readform.c readforms.c report.c rexp2.c ${CMODS_RESOURCE} \
	screen.c sleep.c stack.c string.c \
	translate.c

#../compilers/fcompile/formwrite2.c


COMMONSRC_RPC		= ${COMMONSRC} ${CMODS_RPC}
COMMONSRC_NORPC		= ${COMMONSRC} ${CMODS_NORPC}

ifeq "@HAVE_RPCLIB@" "0"
	CMODSNOSQL 		=${COMMONSRC_NORPC}
else
	CMODSNOSQL 		=${COMMONSRC_RPC}
endif



CMODS_ODBC			=${CMODS_ODBCSQL} ${CMODS_ODBCEX}
OBJS_NOSQL			+=${CMODS_NOSQL:.c=.o}

## ==================================================================
##                              Options
## ==================================================================

ALL 				=aubit-config libPDF_NOPDF${SO_EXT} libaclall.a
ALL_GUI				=libaclallgui.a
LDFLAGS				=-Map mapfile
4GLPC               =../bin/4glpc
4GLPCFLAGS			=-verbose -nogtk

ifdef COMSPEC
#	LOCALCFLAGS		+=-DWIN32 -I/usr/local/include
	LDFLAGS			+= ${RPCLIB_NAME} -lc
	ALL				+=dllaclshared dlllibRPC_NORPC
	ALL_GUI			+=dllaclsharedgui
	ifeq "$(ODBC_LINK)" "static"
		ifneq "$(ODBC)" "no"
			ALL		+=libaclall-noodbc.a
	    	ALL_GUI	+=libaclallgui-noodbc.a
	    endif
    endif
	ifneq "@HAVE_RPCLIB@" "0"
		ALL			+=dlllibRPC_SUNRPC
    endif
else
	#LOCALCFLAGS		+= -g
	#ifneq "$(ODBC)" "no"
	#	LOCALCFLAGS	+= -I$(ODBCLIBDIR)
    #endif
	#ifeq "$(ODBC)" "iodbc"
	#	LOCALCFLAGS	+=-I/usr/include/pgsql/iodbc -DIODBC
	#endif
#	ifeq "$(ODBC)" "no"
#		ifeq "$(ODBC_LINK)" "static"
#			LOCALCFLAGS	+=-DNOODBC
#        	4GLPCFLAGS	+=-noodbc
#        endif
#	endif
#	ifeq "$(PDFBUID)" "yes"
#		LOCALCFLAGS	+= -DUSE_PDF_REPORTS
#    endif
    ALL				+=libaclshared${SO_EXT} libRPC_NORPC${SO_EXT}
#    ALL_GUI			+=libaclsharedgui${SO_EXT}

	ifeq "$(ODBC_LINK)" "static"
		ifneq "$(ODBC)" "no"
		    ALL		+=libaclshared-noodbc${SO_EXT} libaclall-noodbc.a
	    	ALL_GUI	+=libaclsharedgui-noodbc${SO_EXT} libaclallgui-noodbc.a
	    endif
    endif
	ifneq "@HAVE_RPCLIB@" "0"
		ALL			+=libRPC_SUNRPC${SO_EXT}
    endif
endif

#ifndef CFLAGS
#	CFLAGS			=@RPCLIB_INCLUDE@ @RPCLIB_LFLAGS@ ${LOCALCFLAGS}
#endif

#override	CFLAGS	+=-I../compilers/fcompile #-I../compilers/mcompile

#CFLAGS				+=@RPCLIB_INCLUDE@ @RPCLIB_LFLAGS@ -I../compilers/fcompile -Ilibincl
#if particular location for RPC to be used was specified to configure, we have to place it
#BEFORE other include paths, to avoid conflict:
CFLAGS				:=@RPCLIB_INCLUDE@ @RPCLIB_LFLAGS@ -I../compilers/fcompile -Ilibincl ${CFLAGS}

ifeq "$(ODBC_LINK)" "static" #static linking for SQL access libs
	ifneq "$(ODBC)" "no"
		CMODS 		=${CMODSNOSQL} ${CMODS_ODBC}
	else
		CMODS 		=${CMODSNOSQL} ${CMODS_NOSQL}
	endif
	OBJSNOSQL		=${OBJS_NOSQL}
else #default: dynamic linking for SQL access libs

	CMODS 			=${CMODSNOSQL} ${CMODS_DLSQL}

	ifdef COMSPEC
		ALL			+=libSQL_noodbc${SO_EXT} libSQL_odbc32${SO_EXT}

		ifneq "@IFMX_ESQLC@" "no"
			ALL 	+=libSQL_esql${SO_EXT}
		endif
	else
		ALL			+=libSQL_noodbc${SO_EXT}

		ifeq "$(HAVE_IODBC)" "yes"
		    ALL		+=libSQL_iodbc${SO_EXT}
	    endif

		ifeq "$(HAVE_UNIXODBC)" "yes"
			ALL		+=libSQL_unixodbc${SO_EXT}
	    endif

		ifneq "@IFMX_ESQLC@" "no"
			ALL 	+=libSQL_esql${SO_EXT}
		endif

		ifneq "@HAVE_IFXODBC@" "no"
		    ALL		+=libSQL_ifxodbc${SO_EXT}
		endif

		ifneq "@HAVE_PGODBC@" "no"
			ALL		+=libSQL_pgodbc${SO_EXT}
		endif

	endif
endif

ifeq "$(PDFBUILD)" "yes"
	ALL 			+=libPDF_PDF${SO_EXT}
    PDF_LIBNAME     =-lPDF_PDF
    AUBIT_PDFLIBNAME=-Llibpdf
else
    PDF_LIBNAME     =-lPDF_NOPDF
endif


#not used:
#DLLNAME				=acl4gl
#DLL_OBJS			=dll.o gui_gtk.o windef.def

#====================================================================

OBJS				=${CMODS:.c=.o} ${CMODS_PROJECT:.c=.o}
OBJSNOSQL			+=${CMODSNOSQL:.c=.o} ${CMODS_PROJECT:.c=.o}


## ==================================================================
##                              Targets
## ==================================================================

all: ${ALL}
	@echo "Default targets ( ${ALL} ) built successfully."

all_gui: ${ALL_GUI}
	@echo "GUI targets ( ${ALL_GUI} ) built successfully."

aubit-config: ${CMODS_CONFIG} ${CMODS_RESOURCE}
	gcc $^ -o $@ -I./libincl
	cp $@ ../bin

libSQL_noodbc.so:
	${MAKE} $(MKNAME) -C libsql/nosql nosql.so
#	cp libsql/nosql/*.so .

libSQL_iodbc.so:
	${MAKE} $(MKNAME) -C libsql/odbc iodbc
#	cp libsql/odbc/*.so .

libSQL_unixodbc.so:
	${MAKE} $(MKNAME) -C libsql/odbc unixodbc
#	cp libsql/odbc/*.so .

libSQL_esql${SO_EXT}:
	${MAKE} $(MKNAME) -C libsql/esqlc
#	cp libsql/libsqlc/*.so .

libSQL_ifxodbc.so:
	${MAKE} $(MKNAME) -C libsql/odbc ifxodbc

libSQL_pgodbc.so:
	${MAKE} $(MKNAME) -C libsql/odbc pgodbc


#----------------- with ODBC, if ODBC != no ----------------------

libaclall.a : $(OBJS) ${GUI_TUI}
	ar rc $@ $^
	ranlib $@

libaclallgui.a : $(OBJS) ${GUI_GTK}
	ar rc $@ $^
	ranlib $@

libaclshared.so : $(OBJS) ${GUI_TUI}
	ld ${SO_LDFLAGS} $^ -o $@
#-lform -lpanel -lncurses -Map  mapfile

libaclsharedgui.so : $(OBJS) ${GUI_GTK}
	ld ${SO_LDFLAGS} $^ -o $@

#----------------- without ODBC, if ODBC = no (static ODBC) ------------

#obsolete-libaclall-noodbc.a: $(OBJSNOSQL)  ${GUI_TUI}
#obsolete-	ar rc $@ $^
#obsolete-	ranlib $@

#obsolete-libaclallgui-noodbc.a: $(OBJSNOSQL) ${GUI_GTK}
#obsolete-	ar rc $@ $^
#obsolete-	ranlib $@

#obsolete-libaclshared-noodbc.so:  $(OBJSNOSQL) ${GUI_TUI}
#obsolete-	ld  $(SO_LDFLAGS) $^ -o $@

#obsolete-libaclsharedgui-noodbc.so: $(OBJSNOSQL) ${GUI_GTK}
#obsolete-	ld  $(SO_LDFLAGS) $^ -o $@

## ==================================================================
##                       Windows 32 DLL Targets
## ==================================================================

.PHONY : dllaclshared
dllaclshared : $(OBJS) ${GUI_TUI}
#	${MAKE} libaclshared.dll DLLOBJS="$^" DLL_LDLIBS="@CURSES_LIB_NAME@ ${RPCLIB_NAME} ${AUBIT_PDFLIBNAME}" DLL_LDFLAGS="@RPCLIB_LFLAGS@ ${PDF_LIBNAME} -L."
	${MAKE} libaclshared.dll DLLOBJS="$^" DLL_LDLIBS="${RPCLIB_NAME} ${AUBIT_PDFLIBNAME}" DLL_LDFLAGS="@RPCLIB_LFLAGS@ ${PDF_LIBNAME} -L."
#$RPCLIB_NAME

#when this is linked with -gtk4gl that is linked with -rpclib, linking will fail with duplicated definitions;
#when this is linked with -gtk4gl that is linked WITHOUT -rpclib, linking will work, but compiled programs (like hello.exe)
#will fail with missing entry poit to xdr_array in libgtk4gl.dll

#problem: both libaclsharedgui.dll and libgtk4gl.dll MUST be linked with rpclib,
#aclsharedgui to resolve symbols at link time, and gtk4gl at run-time (???)
#because there can be no unresolved symbols at link time, when making Windows DLL - but,
#rpclib have no dll, only static .a, so both .dll's end up with full rpclib linked in them statically.
#(temporary) Solution: create libgtk4gl-norpc.
#obsolete-.PHONY : dllaclsharedgui
#obsolete-dllaclsharedgui : libgtk4gl.dll libPDF_NOPDF.dll
#obsolete-dllaclsharedgui : $(OBJS) ${GUI_GTK}
#obsolete-	${MAKE} libaclsharedgui.dll DLLOBJS="$^" DLL_LDLIBS="-lgtk4gl -lform -lpanel -lncurses ${RPCLIB_NAME} -lPDF_NOPDF" DLL_LDFLAGS="@RPCLIB_LFLAGS@ -Llibpdf -L."
#$RPCLIB_NAME
#overwrite non-rpclib with rpclib linked (runtime) versions:
#obsolete-	cp libgtk4gl-rpc.dll libgtk4gl.dll
#obsolete-	cp libgtk4gl-rpc${DLL_EXPORTLIB_EXT} libgtk4gl${DLL_EXPORTLIB_EXT}

libSQL_noodbc.dll:
	${MAKE} $(MKNAME) -C libsql/nosql nosql.dll

libSQL_odbc32.dll:
	${MAKE} $(MKNAME) -C libsql/odbc odbc32

libPDF_NOPDF.dll:
	${MAKE} -C libpdf $(MKNAME) NOPDF.dll

libgtk4gl.dll:
	${MAKE} $(MKNAME) -C libgui

#obsolete-defaclshared: $(OBJS) ${GUI_TUI}
#obsolete-	${MAKE} libaclshared.def DLLOBJS="$^" DLL_LDLIBS="-lform -lpanel -lncurses ${RPCLIB_NAME} -lPDF_NOPDF" DLL_LDFLAGS="@RPCLIB_LFLAGS@ -Llibpdf"

dlllibRPC_SUNRPC: ${CMODS_RPC}
	${MAKE} libRPC_SUNRPC.dll DLLOBJS="$^" DLL_LDLIBS="${RPCLIB_NAME} ${AUBIT_PDFLIBNAME} -laclshared" DLL_LDFLAGS="@RPCLIB_LFLAGS@ @RPCLIB_INCLUDE@ ${PDF_LIBNAME} -L. -Ilibincl -I../compilers/fcompile"

dlllibRPC_NORPC: ${CMODS_NORPC}
	${MAKE} libRPC_NORPC.dll DLLOBJS="$^" DLL_LDLIBS="${AUBIT_PDFLIBNAME} -laclshared" DLL_LDFLAGS="@RPCLIB_INCLUDE@ ${PDF_LIBNAME} -L. -Ilibincl -I../compilers/fcompile"


## ==================================================================
##                             Sub Targets
## ==================================================================

libPDF_PDF.so:
	${MAKE} -C libpdf $(MKNAME) $@


libRPC_SUNRPC.so: ${CMODS_RPC}
	ld ${SO_LDFLAGS} $^ -o $@

libRPC_NORPC.so: ${CMODS_NORPC}
	ld ${SO_LDFLAGS} $^ -o $@

libPDF_NOPDF.so:
	${MAKE} -C libpdf $(MKNAME) $@


gui_tui.o: ${GUI_SRC}
	${CC} -c $(CFLAGS) $^ -o $@

gui_gtk.o: ${GUI_SRC}
	${CC} -c $(CFLAGS) -DUSE_GTK $^ -o $@

loadmap:
	${SH} ${4GLPC} ${4GLPCFLAGS} -nopdf loadmap.4gl -o $@
	cp $@${EXE} ../bin

ci: $(CMODS)
	ci -l  $^

project.o: generated/${CMODS_PROJECT}
	${CC} -c -o $@ $^

generated/project.c:
	(cd ../tools/project; ${SH} mkproject)

#I see no point in this dependency?
#generated/tmperrs.h : ${TMPERRSSRC}
generated/tmperrs.h :
	${SH} bin/mkerrors

#dependencies:
#make: Circular generated/tmperrs.h <- error.c dependency dropped.
#generated/error.c : generated/tmperrs.h
error.c : generated/tmperrs.h
array.o: array.c ../compilers/fcompile/form_x_xdr.c


## ==================================================================
##                        Clean Targets
## ==================================================================

clean : clean.generated clean.libsql clean.libpdf clean.libincl
	${RM} $(OBJS) $(OBJS_DEBUG) menu_x.h menu_x_xdr.c
	${RM} form_x_xdr.c form_x.h project.c aubit-config
	${RM} loadmap loadmap.c loadmap.h core
	${RM} *.out *.glb *.so *.a  *.o  *.bak *.exe *.dll *.stackdump *.err
	${RM} *.base *.exp libaclshared.def libRPC_NORPC.def libaclsharedgui.def libRPC_SUNRPC.def


clean.generated:
	${RM} generated/errdefs generated/tmperrs.h
	${RM} generated/project.c generated/project.o

clean.all: clean
	${MAKE} $(MKNAME) -C libgui clean
	${MAKE} $(MKNAME) -C libtui clean

clean.libincl:
	${RM} libincl/*.bak

clean.libsql:
	${MAKE} $(MKNAME) -C libsql/nosql clean
	${MAKE} $(MKNAME) -C libsql/odbc clean
	${MAKE} $(MKNAME) -C libsql/esqlc clean

clean.libpdf:
	${MAKE} $(MKNAME) -C libpdf clean


## ==================================================================
##                         Other Targets
## ==================================================================

lclint: $(CMODS)
	-lclint -weak $(CFLAGS) $(CMODS) > lclint.log 2>&1
	@echo "see lclint.log for results"

#----------------------------------- EOF -------------------------------





